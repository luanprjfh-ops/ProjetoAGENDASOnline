<!doctype html>
<!--
  Painel Administrativo • AgendaPro (Multi-empresa • Supabase)
  - Este arquivo é 100% estático (HTML + JS) e consome Supabase.
  - Configure SUPABASE_URL e SUPABASE_ANON_KEY no bloco <script> (logo abaixo).
  - Requisitos atendidos: multi-tenant por company_id, autenticação Supabase, RLS no banco.
-->
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Painel ADM • AgendaPro</title>

  <style>
    :root{
  --bg:#07020b;
  --card: rgba(15, 8, 20, .72);
  --card2: rgba(12, 6, 16, .55);
  --primary:#ff4fd8;
  --primary2:#8b5cf6;
  --text:#f6f2ff;
  --muted:rgba(246,242,255,.68);
  --border:rgba(255,255,255,.10);
  --shadow: 0 20px 60px rgba(0,0,0,.55);
  --radius: 18px;
  --soft: rgba(255,255,255,.05);

  --ok:#22c55e;
  --bad:#fb7185;
  --done:#a78bfa;

  --glowPink: rgba(255,79,216,.35);
  --glowPurple: rgba(139,92,246,.30);
}
*{box-sizing:border-box}
    body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
  color:var(--text);
  background: radial-gradient(1200px 600px at 15% 10%, rgba(255,79,216,.18), transparent 55%),
              radial-gradient(900px 600px at 85% 30%, rgba(139,92,246,.18), transparent 55%),
              radial-gradient(1200px 700px at 40% 95%, rgba(255,79,216,.10), transparent 60%),
              var(--bg);
  min-height:100vh;
  overflow-x:hidden;
}
body::before, body::after{
  content:"";
  position:fixed;
  inset:-120px;
  z-index:-1;
  pointer-events:none;
  filter: blur(22px);
  opacity:.8;
  transform: translate3d(0,0,0);
}
body::before{
  background:
    radial-gradient(circle at 20% 20%, rgba(255,79,216,.45), transparent 35%),
    radial-gradient(circle at 85% 35%, rgba(139,92,246,.40), transparent 38%),
    radial-gradient(circle at 35% 90%, rgba(255,79,216,.22), transparent 40%);
  animation: floatGlow 10s ease-in-out infinite;
}
body::after{
  background:
    radial-gradient(circle at 65% 15%, rgba(255,255,255,.08), transparent 30%),
    radial-gradient(circle at 10% 70%, rgba(139,92,246,.16), transparent 35%),
    radial-gradient(circle at 90% 85%, rgba(255,79,216,.14), transparent 38%);
  animation: floatGlow2 14s ease-in-out infinite;
  opacity:.55;
}
@keyframes floatGlow{
  0%,100%{ transform: translate3d(0,0,0) scale(1); }
  50%{ transform: translate3d(20px,-12px,0) scale(1.03); }
}
@keyframes floatGlow2{
  0%,100%{ transform: translate3d(0,0,0) scale(1); }
  50%{ transform: translate3d(-18px,14px,0) scale(1.02); }
}
.hidden{display:none!important}
    .wrap{max-width:1200px;margin:0 auto;padding:22px}
    .card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  backdrop-filter: blur(14px);
}
.brand{
  font-weight:900;
  font-size:24px;
  margin:0;
  background: linear-gradient(90deg,var(--primary),var(--primary2));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  text-shadow: 0 0 22px rgba(255,79,216,.14);
}
.muted{color:var(--muted)}
    .pill{
  padding:8px 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background: linear-gradient(90deg, rgba(255,79,216,.12), rgba(139,92,246,.12));
  font-weight:800;
  font-size:13px;
  white-space:nowrap;
  color: var(--text);
}
/* LOGIN */
    .center{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px}
    .login{width:420px;padding:24px}
    label{font-size:12px;color:var(--muted);display:block;margin-top:10px}
    input, select{
  width:100%;
  padding:12px 14px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  outline:none;
  margin-top:6px;
  font-size:14px;
  background: rgba(10,6,14,.70);
  color: var(--text);
  box-shadow: 0 0 0 0 rgba(0,0,0,0);
}
    input:focus, select:focus{border-color: rgba(255,79,216,.55); box-shadow: 0 0 0 4px rgba(255,79,216,.14), 0 0 0 1px rgba(139,92,246,.10) inset}
.btn{
  border:0;
  padding:12px 14px;
  border-radius:14px;
  font-weight:900;
  cursor:pointer;
  color:#0b0410;
  background: linear-gradient(90deg, var(--primary), var(--primary2));
  box-shadow: 0 14px 30px var(--glowPink), 0 10px 22px rgba(0,0,0,.35);
  transition:.15s;
}
.btn:hover{transform:translateY(-1px); filter: brightness(1.03);}
.btn:disabled{opacity:.6;cursor:not-allowed;transform:none;filter:none}
.btn:hover{transform:translateY(-1px);opacity:.95}
    .btn:disabled{opacity:.6;cursor:not-allowed;transform:none}

    .btn2{
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  padding:10px 12px;
  border-radius:14px;
  cursor:pointer;
  font-weight:900;
  color: var(--text);
  transition: .15s;
}
.btn2:hover{background: rgba(255,255,255,.07); transform: translateY(-1px);}
.btn2:hover{background: rgba(255,255,255,.06)}
    .btnDanger{
      border:1px solid #fecdd3;
      background:#fff1f2;
      color:#be123c;
    }
    .btnDanger:hover{background:#ffe4e6}

    .error{
  display:none;
  margin-top:10px;
  padding:10px 12px;
  border-radius:14px;
  background: rgba(251,113,133,.12);
  border:1px solid rgba(251,113,133,.35);
  color:#fecdd3;
  font-size:13px;
}
.toast{
  position:fixed;
  right:18px;
  bottom:18px;
  min-width:260px;
  max-width:380px;
  padding:12px 14px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(10,6,14,.78);
  box-shadow:var(--shadow);
  display:none;
  z-index:9999;
  color: var(--text);
  backdrop-filter: blur(14px);
}
.toast.ok{border-color:#bbf7d0}
    .toast.err{border-color:#fecdd3}

    /* LAYOUT */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:16px 18px;
      margin-top:14px;
      gap:10px;
    }
    .row{display:flex;gap:16px;flex-wrap:wrap;margin-top:14px}
    .sidebar{
  width:280px;
  padding:16px;
  background:var(--card2);
  border:1px solid var(--border);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  backdrop-filter: blur(14px);
}
.menu{margin-top:14px;display:flex;flex-direction:column;gap:8px}
    .menu button{
      text-align:left;
      border:1px solid transparent;
      background:transparent;
      padding:12px;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .menu button:hover{background: rgba(255,255,255,.06);border-color:#f3e8ff}
    .menu .active{background: rgba(255,255,255,.06);border-color:#f3e8ff}
    .content{flex:1;min-width:300px}

    .section{padding:16px}
    .section h2{margin:0 0 6px 0}
    .section p{margin:0 0 12px 0;color:var(--muted)}
    .grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:14px;
    }
    @media (max-width:1100px){.grid{grid-template-columns: repeat(2, minmax(0,1fr));}}
    @media (max-width:760px){.grid{grid-template-columns: 1fr;}.sidebar{width:100%}}
    .kpi{padding:16px}
    .kpi h3{margin:0 0 6px 0;font-size:13px;color:var(--muted)}
    .kpi .big{font-size:28px;font-weight:1000;margin:0}

    .toolbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin:10px 0 12px;
    }
    .toolbar .left,.toolbar .right{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .miniInput{width:auto;min-width:220px}

    table{width:100%;border-collapse:separate;border-spacing:0 10px}
        th{font-size:12px;color:var(--muted);text-align:left;padding:0 10px}
    td{
  background: rgba(10,6,14,.55);
  border:1px solid rgba(255,255,255,.10);
  padding:12px 10px;
  vertical-align:middle;
  color: var(--text);
  backdrop-filter: blur(10px);
}
td:first-child{border-radius:14px 0 0 14px}
    td:last-child{border-radius:0 14px 14px 0}
    .tag{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      border:1px solid var(--border);
      background:#fff;
    }
    .tag.ok{border-color:#bbf7d0;background:#ecfdf5;color:#166534}
    .tag.bad{border-color:#fecdd3;background:#fff1f2;color:#be123c}
    .tag.done{border-color:#c7d2fe;background:#eef2ff;color:var(--done)}

    /* MODAL */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:9998;
    }
    .modal{width:100%;max-width:560px;padding:16px}
    .modalHeader{display:flex;justify-content:space-between;gap:10px;align-items:center}
    .modalHeader h3{margin:0}
    .modalBody{margin-top:10px}
    .modalBody .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:640px){.modalBody .row2{grid-template-columns:1fr}}
    .modalFooter{display:flex;gap:10px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap}
  </style>
</head>

<body>

  <!-- LOGIN -->
  <div id="loginView" class="center">
    <div class="card login">
      <h1 class="brand" style="font-size:28px">Painel Administrativo</h1>
      <p class="muted" style="margin:6px 0 14px 0;">Acesse para gerenciar sua agenda.</p>

      <label>E-mail</label>
      <input id="email" placeholder="admin@lep.local" />

      <label>Senha</label>
      <input id="password" type="password" placeholder="••••••••" />

      <div id="err" class="error"></div>

      <button id="btnLogin" class="btn" style="width:100%">Entrar</button>

      <p class="muted" style="margin:14px 0 0 0;font-size:12px;text-align:center">
        LEP Sistemas • Agenda Online
      </p>
    </div>
  </div>

  <!-- APP -->
  <div id="appView" class="wrap hidden">
    <div class="topbar card">
      <div>
        <div class="brand">AgendaPro</div>
        <div class="muted" id="who" style="font-size:13px;margin-top:2px;">—</div>
      </div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end">
        <span class="pill" id="companyPill">Empresa: —</span>
        <button class="btn2" id="btnRefresh">Atualizar</button>
        <button class="btn2" id="btnLogout">Sair</button>
      </div>
    </div>

    <div class="row">
      <aside class="sidebar">
        <div class="pill">Menu</div>
        <div class="menu">
          <button class="active" data-tab="dash"><span>Dashboard</span><span class="tag" id="badgeToday">—</span></button>
          <button data-tab="agenda"><span>Agenda</span><span class="tag" id="badgeAgenda">—</span></button>
          <button data-tab="clientes"><span>Clientes</span><span class="tag" id="badgeClientes">—</span></button>
          <button data-tab="profissionais"><span>Profissionais</span><span class="tag" id="badgePros">—</span></button>
          <button data-tab="servicos"><span>Serviços</span><span class="tag" id="badgeServ">—</span></button>
          <button data-tab="horarios"><span>Horários</span><span class="tag" id="badgeHours">—</span></button>
        </div>

        <div style="margin-top:14px" class="muted">
          <div style="font-weight:900;color:var(--text)">Ações rápidas</div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
            <button class="btn2" id="quickNewCustomer">+ Cliente</button>
            <button class="btn2" id="quickNewPro">+ Profissional</button>
            <button class="btn2" id="quickNewService">+ Serviço</button>
          </div>
        </div>

        <div style="margin-top:14px" class="muted">
          <div style="font-weight:900;color:var(--text)">Permissão</div>
          <div id="roleBox" class="pill" style="margin-top:8px;display:inline-block">—</div>
        </div>
      </aside>

      <main class="content">
        <!-- DASH -->
        <section id="tab-dash" class="card section">
          <h2>Dashboard</h2>
          <p>Resumo do dia e próximos agendamentos.</p>

          <div class="grid">
            <div class="card kpi"><h3>Hoje</h3><p class="big" id="kpiToday">—</p></div>
            <div class="card kpi"><h3>Confirmados</h3><p class="big" id="kpiConf">—</p></div>
            <div class="card kpi"><h3>Cancelados</h3><p class="big" id="kpiCanc">—</p></div>
            <div class="card kpi"><h3>Concluídos</h3><p class="big" id="kpiDone">—</p></div>
          </div>

          <div style="margin-top:14px" class="card section">
            <div class="toolbar">
              <div class="left">
                <div style="font-weight:1000">Próximos agendamentos</div>
                <span class="muted" style="font-size:13px">até 20 itens</span>
              </div>
              <div class="right">
                <button class="btn2" id="btnGoAgenda">Abrir Agenda</button>
              </div>
            </div>

            <div style="overflow:auto">
              <table>
                <thead>
                  <tr><th>Data/Hora</th><th>Profissional</th><th>Serviço</th><th>Cliente</th><th>Status</th></tr>
                </thead>
                <tbody id="tbodyNext"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- AGENDA -->
        <section id="tab-agenda" class="card section hidden">
          <h2>Agenda</h2>
          <p>Filtre por data e profissional, altere status e gerencie agendamentos.</p>

          <div class="toolbar">
            <div class="left">
              <input class="miniInput" id="agendaDate" type="date" />
              <select class="miniInput" id="agendaPro"></select>
            </div>
            <div class="right">
              <button class="btn2" id="btnAgendaReload">Recarregar</button>
            </div>
          </div>

          <div style="overflow:auto">
            <table>
              <thead>
                <tr><th>Hora</th><th>Profissional</th><th>Serviço</th><th>Cliente</th><th>Telefone</th><th>Status</th><th>Ações</th></tr>
              </thead>
              <tbody id="tbodyAgenda"></tbody>
            </table>
          </div>
        </section>

        <!-- CLIENTES -->
        <section id="tab-clientes" class="card section hidden">
          <h2>Clientes</h2>
          <p>Cadastre, edite e busque clientes.</p>

          <div class="toolbar">
            <div class="left">
              <input class="miniInput" id="searchCustomer" placeholder="Buscar por nome/telefone..." />
            </div>
            <div class="right">
              <button class="btn2" id="btnNewCustomer">+ Novo Cliente</button>
              <button class="btn2" id="btnCustomersReload">Recarregar</button>
            </div>
          </div>

          <div style="overflow:auto">
            <table>
              <thead>
                <tr><th>Nome</th><th>Telefone</th><th>E-mail</th><th>Documento</th><th>Ações</th></tr>
              </thead>
              <tbody id="tbodyCustomers"></tbody>
            </table>
          </div>
        </section>

        <!-- PROFISSIONAIS -->
        <section id="tab-profissionais" class="card section hidden">
          <h2>Profissionais</h2>
          <p>Gerencie equipe.</p>

          <div class="toolbar">
            <div class="left"></div>
            <div class="right">
              <button class="btn2" id="btnNewPro">+ Novo Profissional</button>
              <button class="btn2" id="btnProsReload">Recarregar</button>
            </div>
          </div>

          <div style="overflow:auto">
            <table>
              <thead>
                <tr><th>Nome</th><th>Status</th><th>Ações</th></tr>
              </thead>
              <tbody id="tbodyPros"></tbody>
            </table>
          </div>
        </section>

        <!-- SERVIÇOS -->
        <section id="tab-servicos" class="card section hidden">
          <h2>Serviços</h2>
          <p>Cadastre serviços com duração e preço.</p>

          <div class="toolbar">
            <div class="left"></div>
            <div class="right">
              <button class="btn2" id="btnNewService">+ Novo Serviço</button>
              <button class="btn2" id="btnServReload">Recarregar</button>
            </div>
          </div>

          <div style="overflow:auto">
            <table>
              <thead>
                <tr><th>Serviço</th><th>Duração</th><th>Preço</th><th>Status</th><th>Ações</th></tr>
              </thead>
              <tbody id="tbodyServ"></tbody>
            </table>
          </div>
        </section>

        <!-- HORÁRIOS -->
        <section id="tab-horarios" class="card section hidden">
          <h2>Horários</h2>
          <p>Defina dias e horários disponíveis por profissional.</p>

          <div class="toolbar">
            <div class="left" style="gap:10px">
              <select class="miniInput" id="whPro"></select>
              <select id="whWeekday" class="miniInput">
                <option value="0">Domingo</option>
                <option value="1">Segunda</option>
                <option value="2">Terça</option>
                <option value="3">Quarta</option>
                <option value="4">Quinta</option>
                <option value="5">Sexta</option>
                <option value="6">Sábado</option>
              </select>
              <input id="whStart" class="miniInput" type="time" value="09:00" />
              <input id="whEnd" class="miniInput" type="time" value="18:00" />
              <input id="whSlot" class="miniInput" type="number" min="10" max="180" value="30" />
            </div>
            <div class="right">
              <button class="btn2" id="btnWhAdd">Salvar Horário</button>
              <button class="btn2" id="btnWhDefault">Aplicar Seg–Sex 09:00–18:00</button>
              <button class="btn2" id="btnWhReload">Recarregar</button>
            </div>
          </div>

          <div style="overflow:auto">
            <table>
              <thead>
                <tr><th>Profissional</th><th>Dia</th><th>Início</th><th>Fim</th><th>Slot</th><th>Ações</th></tr>
              </thead>
              <tbody id="tbodyHours"></tbody>
            </table>
          </div>
        </section>

      </main>
    </div>
  </div>

  <!-- MODAL -->
  <div id="modalBack" class="modalBack">
    <div class="card modal">
      <div class="modalHeader">
        <h3 id="modalTitle">—</h3>
        <button class="btn2" id="modalClose">Fechar</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
      <div class="modalFooter" id="modalFooter"></div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SB_URL = "https://nsmvnfhdohpvmtoimsub.supabase.co";
    const SB_KEY = "sb_publishable_tn76OaKxjctgngA6jj9NSw_KXfWqt-f";
    const sb = window.supabase.createClient(SB_URL, SB_KEY);

    // UI refs
    const loginView = document.getElementById("loginView");
    const appView = document.getElementById("appView");
    const btnLogin = document.getElementById("btnLogin");
    const btnLogout = document.getElementById("btnLogout");
    const btnRefresh = document.getElementById("btnRefresh");
    const err = document.getElementById("err");

    const who = document.getElementById("who");
    const companyPill = document.getElementById("companyPill");
    const roleBox = document.getElementById("roleBox");

    const kpiToday = document.getElementById("kpiToday");
    const kpiConf  = document.getElementById("kpiConf");
    const kpiCanc  = document.getElementById("kpiCanc");
    const kpiDone  = document.getElementById("kpiDone");

    const badgeToday = document.getElementById("badgeToday");
    const badgeAgenda = document.getElementById("badgeAgenda");
    const badgeClientes = document.getElementById("badgeClientes");
    const badgePros = document.getElementById("badgePros");
    const badgeServ = document.getElementById("badgeServ");
    const badgeHours = document.getElementById("badgeHours");

    const tbodyNext = document.getElementById("tbodyNext");
    const tbodyAgenda = document.getElementById("tbodyAgenda");
    const agendaDate = document.getElementById("agendaDate");
    const agendaPro = document.getElementById("agendaPro");

    const tbodyCustomers = document.getElementById("tbodyCustomers");
    const searchCustomer = document.getElementById("searchCustomer");

    const tbodyPros = document.getElementById("tbodyPros");
    const tbodyServ = document.getElementById("tbodyServ");

    const btnGoAgenda = document.getElementById("btnGoAgenda");
    const btnAgendaReload = document.getElementById("btnAgendaReload");

    const btnNewCustomer = document.getElementById("btnNewCustomer");
    const btnCustomersReload = document.getElementById("btnCustomersReload");

    const btnNewPro = document.getElementById("btnNewPro");
    const btnProsReload = document.getElementById("btnProsReload");

    const btnNewService = document.getElementById("btnNewService");
    const btnServReload = document.getElementById("btnServReload");

    const quickNewCustomer = document.getElementById("quickNewCustomer");
    const quickNewPro = document.getElementById("quickNewPro");
    const quickNewService = document.getElementById("quickNewService");

    // Working Hours refs
    const whPro = document.getElementById("whPro");
    const whWeekday = document.getElementById("whWeekday");
    const whStart = document.getElementById("whStart");
    const whEnd = document.getElementById("whEnd");
    const whSlot = document.getElementById("whSlot");
    const btnWhAdd = document.getElementById("btnWhAdd");
    const btnWhDefault = document.getElementById("btnWhDefault");
    const btnWhReload = document.getElementById("btnWhReload");
    const tbodyHours = document.getElementById("tbodyHours");

    // Modal
    const modalBack = document.getElementById("modalBack");
    const modalTitle = document.getElementById("modalTitle");
    const modalBody = document.getElementById("modalBody");
    const modalFooter = document.getElementById("modalFooter");
    const modalClose = document.getElementById("modalClose");

    // Toast
    const toast = document.getElementById("toast");

    let state = {
      user: null,
      profile: null,
      company: null,
      role: "staff",
      isAdmin: false,
      pros: [],
      serv: [],
      prosMap: {},
      servMap: {}
    };

    const pad2 = (n)=>String(n).padStart(2,"0");
    const todayISO = ()=> {
      const d = new Date();
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    };
    const fmtTime = (iso)=> new Date(iso).toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});
    const fmtDateTime = (iso)=> new Date(iso).toLocaleString("pt-BR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"});
    const money = (cents)=>{
      if (cents===null || cents===undefined || cents==="") return "—";
      return (Number(cents)/100).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
    };

    const weekdayLabel = (w)=>{
      const a=["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"];
      return a[Number(w)] ?? String(w);
    };

    function resetState(){
      state = { user:null, profile:null, company:null, role:"staff", isAdmin:false, pros:[], serv:[], prosMap:{}, servMap:{} };
      who.textContent = "—";
      companyPill.textContent = "Empresa: —";
      roleBox.textContent = "—";
      kpiToday.textContent="—"; kpiConf.textContent="—"; kpiCanc.textContent="—"; kpiDone.textContent="—";
      badgeToday.textContent="—"; badgeAgenda.textContent="—"; badgeClientes.textContent="—"; badgePros.textContent="—"; badgeServ.textContent="—"; badgeHours.textContent="—";
      tbodyNext.innerHTML=""; tbodyAgenda.innerHTML=""; tbodyCustomers.innerHTML=""; tbodyPros.innerHTML=""; tbodyServ.innerHTML=""; tbodyHours.innerHTML="";
      agendaPro.innerHTML=""; whPro.innerHTML="";
      document.querySelectorAll(".menu button").forEach(b=>b.classList.remove("active"));
      document.querySelector('.menu button[data-tab="dash"]').classList.add("active");
      document.querySelectorAll("main section").forEach(sec=>sec.classList.add("hidden"));
      document.getElementById("tab-dash").classList.remove("hidden");
    }

    function showLogin(){ appView.classList.add("hidden"); loginView.classList.remove("hidden"); }
    function showApp(){ loginView.classList.add("hidden"); appView.classList.remove("hidden"); }
    function showError(msg){ err.style.display="block"; err.textContent=msg; }
    function clearError(){ err.style.display="none"; err.textContent=""; }

    function toastMsg(type, msg){
      toast.className = "toast " + (type==="ok" ? "ok" : "err");
      toast.textContent = msg;
      toast.style.display = "block";
      setTimeout(()=> toast.style.display="none", 2600);
    }

    function tagStatus(status){
      if(status==="confirmed") return `<span class="tag ok">Confirmado</span>`;
      if(status==="cancelled") return `<span class="tag bad">Cancelado</span>`;
      if(status==="done") return `<span class="tag done">Concluído</span>`;
      return `<span class="tag">${status}</span>`;
    }

    function openModal(title, bodyHTML, footerHTML){
      modalTitle.textContent = title;
      modalBody.innerHTML = bodyHTML;
      modalFooter.innerHTML = footerHTML || "";
      modalBack.style.display = "flex";
    }
    function closeModal(){ modalBack.style.display = "none"; }
    modalClose.onclick = closeModal;
    modalBack.addEventListener("click",(e)=>{ if(e.target===modalBack) closeModal(); });

    document.querySelectorAll(".menu button").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".menu button").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        const tab = btn.dataset.tab;
        document.querySelectorAll("main section").forEach(sec=>sec.classList.add("hidden"));
        document.getElementById("tab-" + tab).classList.remove("hidden");

        if(tab==="agenda") loadAgenda();
        if(tab==="clientes") loadCustomers();
        if(tab==="profissionais") loadProfessionals();
        if(tab==="servicos") loadServices();
        if(tab==="horarios") loadWorkingHours();
      });
    });

    btnGoAgenda.onclick = ()=>{
      document.querySelectorAll(".menu button").forEach(b=>b.classList.remove("active"));
      document.querySelector('.menu button[data-tab="agenda"]').classList.add("active");
      document.querySelectorAll("main section").forEach(sec=>sec.classList.add("hidden"));
      document.getElementById("tab-agenda").classList.remove("hidden");
      loadAgenda();
    };

    btnLogin.onclick = async ()=>{
      clearError();
      btnLogin.disabled = true;
      btnLogin.textContent = "Entrando...";
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;

      const { error } = await sb.auth.signInWithPassword({ email, password });

      btnLogin.disabled = false;
      btnLogin.textContent = "Entrar";
      if (error) return showError("E-mail ou senha inválidos.");

      await bootstrap();
    };

    btnLogout.onclick = async ()=>{
      try{
        await sb.auth.signOut();
      } finally {
        resetState();
        showLogin();
        toastMsg("ok","Sessão encerrada.");
      }
    };

    btnRefresh.onclick = async ()=>{
      await refreshAll();
      toastMsg("ok","Atualizado.");
    };

    quickNewCustomer.onclick = ()=> openCustomerModal();
    quickNewPro.onclick = ()=> openProModal();
    quickNewService.onclick = ()=> openServiceModal();

    btnAgendaReload.onclick = loadAgenda;
    btnCustomersReload.onclick = loadCustomers;
    btnProsReload.onclick = loadProfessionals;
    btnServReload.onclick = loadServices;

    btnNewCustomer.onclick = ()=> openCustomerModal();
    btnNewPro.onclick = ()=> openProModal();
    btnNewService.onclick = ()=> openServiceModal();

    agendaDate.onchange = loadAgenda;
    agendaPro.onchange = loadAgenda;

    let searchTimer = null;
    searchCustomer.oninput = ()=>{
      clearTimeout(searchTimer);
      searchTimer = setTimeout(loadCustomers, 250);
    };

    // Working hours actions
    btnWhReload.onclick = loadWorkingHours;

    // >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
    // IMPORTANTÍSSIMO MULTI-EMPRESA:
    // Todos inserts/updates usam state.profile.company_id
    // >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

    btnWhAdd.onclick = async ()=>{
      const professional_id = whPro.value;
      const weekday = Number(whWeekday.value);
      const start_time = whStart.value;
      const end_time = whEnd.value;
      const slot_minutes = Number(whSlot.value || 30);

      if(!professional_id) return toastMsg("err","Selecione um profissional.");
      if(!start_time || !end_time) return toastMsg("err","Informe início e fim.");
      if(start_time >= end_time) return toastMsg("err","Início deve ser menor que fim.");
      if(slot_minutes < 10 || slot_minutes > 180) return toastMsg("err","Slot inválido.");
      if(!state?.profile?.company_id) return toastMsg("err","Sessão inválida (sem company_id).");

      const payload = {
        company_id: state.profile.company_id,
        professional_id,
        weekday,
        start_time,
        end_time,
        slot_minutes
      };

      const { error } = await sb.from("working_hours").insert(payload);
      if(error) return toastMsg("err", "Erro ao salvar horário.");
      toastMsg("ok","Horário salvo.");
      await loadWorkingHours();
    };

    btnWhDefault.onclick = async ()=>{
      const professional_id = whPro.value;
      if(!professional_id) return toastMsg("err","Selecione um profissional.");
      if(!state?.profile?.company_id) return toastMsg("err","Sessão inválida (sem company_id).");

      const ok = confirm("Aplicar padrão Seg–Sex 09:00–18:00 (slot 30) para este profissional? Isso adiciona novos horários.");
      if(!ok) return;

      const rows = [1,2,3,4,5].map(weekday=>({
        company_id: state.profile.company_id,
        professional_id,
        weekday,
        start_time: "09:00",
        end_time: "18:00",
        slot_minutes: 30
      }));

      const { error } = await sb.from("working_hours").insert(rows);
      if(error) return toastMsg("err","Erro ao aplicar padrão (talvez duplicado).");
      toastMsg("ok","Padrão aplicado.");
      await loadWorkingHours();
    };

    async function bootstrap(){
      resetState();

      const { data: sess } = await sb.auth.getSession();
      if(!sess.session){ showLogin(); return; }
      showApp();

      const { data: u } = await sb.auth.getUser();
      state.user = u?.user || null;
      if(!state.user){ showLogin(); return; }

      const { data: prof, error: e1 } = await sb
        .from("profiles")
        .select("company_id, role, display_name")
        .eq("user_id", state.user.id)
        .maybeSingle();

      if(e1 || !prof){
        showError("Usuário sem vínculo no profiles. (Seu SQL já deveria ter criado esse vínculo).");
        await sb.auth.signOut();
        resetState();
        showLogin();
        return;
      }

      state.profile = prof;
      state.role = prof.role || "staff";
      state.isAdmin = state.role === "admin";

      roleBox.textContent = state.isAdmin ? "ADMIN" : "STAFF";

      const { data: comp, error: e2 } = await sb
        .from("companies")
        .select("name, slug, status, paid_until")
        .eq("id", prof.company_id)
        .maybeSingle();

      if(e2 || !comp){
        showError("Empresa não encontrada para este usuário.");
        await sb.auth.signOut();
        resetState();
        showLogin();
        return;
      }

      state.company = comp;

      who.textContent = `Usuário: ${prof.display_name || state.user.email} • Perfil: ${state.role}`;
      companyPill.textContent = `Empresa: ${comp.name}`;

      agendaDate.value = todayISO();

      await refreshAll();
    }

    async function refreshAll(){
      await loadMaps();
      await loadCounts();
      await loadDashboard();
      await fillWorkingHoursPros();
    }

    async function loadMaps(){
      const { data: pros } = await sb.from("professionals").select("id,name,active").order("name",{ascending:true});
      const { data: serv } = await sb.from("services").select("id,name,active,duration_minutes,price_cents").order("name",{ascending:true});

      state.pros = pros || [];
      state.serv = serv || [];
      state.prosMap = Object.fromEntries((pros||[]).map(p=>[p.id, p.name]));
      state.servMap = Object.fromEntries((serv||[]).map(s=>[s.id, s.name]));

      agendaPro.innerHTML = `<option value="">Todos os profissionais</option>`;
      (pros||[]).forEach(p=>{ if(p.active) agendaPro.innerHTML += `<option value="${p.id}">${p.name}</option>`; });
    }

    async function fillWorkingHoursPros(){
      whPro.innerHTML = `<option value="">Selecione um profissional</option>`;
      (state.pros || []).forEach(p=>{
        if(p.active) whPro.innerHTML += `<option value="${p.id}">${p.name}</option>`;
      });
      whPro.onchange = loadWorkingHours;
    }

    async function loadCounts(){
      const { count: cAppt } = await sb.from("appointments").select("id",{count:"exact",head:true});
      const { count: cCust } = await sb.from("customers").select("id",{count:"exact",head:true});
      const { count: cPros } = await sb.from("professionals").select("id",{count:"exact",head:true});
      const { count: cServ } = await sb.from("services").select("id",{count:"exact",head:true});
      const { count: cWh } = await sb.from("working_hours").select("id",{count:"exact",head:true});

      badgeAgenda.textContent = cAppt ?? "0";
      badgeClientes.textContent = cCust ?? "0";
      badgePros.textContent = cPros ?? "0";
      badgeServ.textContent = cServ ?? "0";
      badgeHours.textContent = cWh ?? "0";

      const d = agendaDate.value || todayISO();
      const start = d + "T00:00:00";
      const end   = d + "T23:59:59";
      const { count: cToday } = await sb
        .from("appointments")
        .select("id",{count:"exact",head:true})
        .gte("starts_at", start)
        .lte("starts_at", end);

      badgeToday.textContent = cToday ?? "0";
    }

    async function loadDashboard(){
      const d = todayISO();
      const start = d + "T00:00:00";
      const end   = d + "T23:59:59";

      const { data, error } = await sb
        .from("appointments")
        .select("status, starts_at")
        .gte("starts_at", start)
        .lte("starts_at", end);

      if(error){
        kpiToday.textContent="—"; kpiConf.textContent="—"; kpiCanc.textContent="—"; kpiDone.textContent="—";
      } else {
        const total = data.length;
        const conf = data.filter(x=>x.status==="confirmed").length;
        const canc = data.filter(x=>x.status==="cancelled").length;
        const done = data.filter(x=>x.status==="done").length;
        kpiToday.textContent = total;
        kpiConf.textContent = conf;
        kpiCanc.textContent = canc;
        kpiDone.textContent = done;
      }

      const now = new Date().toISOString();
      const { data: next, error: e2 } = await sb
        .from("appointments")
        .select("id, starts_at, status, customer_name, professional_id, service_id")
        .gte("starts_at", now)
        .order("starts_at",{ascending:true})
        .limit(20);

      tbodyNext.innerHTML = "";
      if(e2 || !next || !next.length){
        tbodyNext.innerHTML = `<tr><td colspan="5">Nenhum agendamento futuro.</td></tr>`;
      } else {
        next.forEach(a=>{
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${fmtDateTime(a.starts_at)}</td>
            <td>${state.prosMap[a.professional_id] || "—"}</td>
            <td>${state.servMap[a.service_id] || "—"}</td>
            <td>${a.customer_name || "—"}</td>
            <td>${tagStatus(a.status)}</td>
          `;
          tbodyNext.appendChild(tr);
        });
      }
    }

    async function loadAgenda(){
      const date = agendaDate.value || todayISO();
      const start = date + "T00:00:00";
      const end   = date + "T23:59:59";
      const proId = agendaPro.value;

      let q = sb
        .from("appointments")
        .select("id, starts_at, status, customer_name, customer_phone, professional_id, service_id")
        .gte("starts_at", start)
        .lte("starts_at", end)
        .order("starts_at",{ascending:true});

      if(proId) q = q.eq("professional_id", proId);

      const { data, error } = await q;

      tbodyAgenda.innerHTML = "";
      if(error){
        tbodyAgenda.innerHTML = `<tr><td colspan="7">Erro ao carregar agenda.</td></tr>`;
        return;
      }
      if(!data.length){
        tbodyAgenda.innerHTML = `<tr><td colspan="7">Nenhum agendamento para este filtro.</td></tr>`;
        return;
      }

      data.forEach(a=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${fmtTime(a.starts_at)}</td>
          <td>${state.prosMap[a.professional_id] || "—"}</td>
          <td>${state.servMap[a.service_id] || "—"}</td>
          <td>${a.customer_name || "—"}</td>
          <td>${a.customer_phone || "—"}</td>
          <td>${tagStatus(a.status)}</td>
          <td>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn2" data-act="confirm" data-id="${a.id}">Confirmar</button>
              <button class="btn2" data-act="done" data-id="${a.id}">Concluir</button>
              <button class="btn2 btnDanger" data-act="cancel" data-id="${a.id}">Cancelar</button>
              ${state.isAdmin ? `<button class="btn2 btnDanger" data-act="del" data-id="${a.id}">Excluir</button>` : ""}
            </div>
          </td>
        `;
        tbodyAgenda.appendChild(tr);
      });

      tbodyAgenda.querySelectorAll("button[data-act]").forEach(b=>{
        b.onclick = ()=> onAgendaAction(b.dataset.act, b.dataset.id);
      });

      await loadCounts();
    }

    async function onAgendaAction(act, id){
      if(act==="del" && !state.isAdmin) return toastMsg("err","Apenas ADMIN pode excluir.");
      if(act==="del"){
        const ok = confirm("Excluir este agendamento? Essa ação não pode ser desfeita.");
        if(!ok) return;
        const { error } = await sb.from("appointments").delete().eq("id", id);
        if(error) return toastMsg("err","Erro ao excluir.");
        toastMsg("ok","Agendamento excluído.");
        await loadAgenda(); await loadDashboard();
        return;
      }
      let status = "confirmed";
      if(act==="cancel") status = "cancelled";
      if(act==="done") status = "done";
      if(act==="confirm") status = "confirmed";

      const { error } = await sb.from("appointments").update({ status }).eq("id", id);
      if(error) return toastMsg("err","Erro ao atualizar status.");
      toastMsg("ok","Status atualizado.");
      await loadAgenda(); await loadDashboard();
    }

    async function loadCustomers(){
      const term = (searchCustomer.value || "").trim().toLowerCase();
      const { data, error } = await sb
        .from("customers")
        .select("id, full_name, phone, email, document, birth_date, address, notes")
        .order("full_name",{ascending:true})
        .limit(200);

      tbodyCustomers.innerHTML = "";
      if(error){ tbodyCustomers.innerHTML = `<tr><td colspan="5">Erro ao carregar clientes.</td></tr>`; return; }

      let list = data || [];
      if(term){
        list = list.filter(c =>
          (c.full_name||"").toLowerCase().includes(term) ||
          (c.phone||"").toLowerCase().includes(term)
        );
      }
      if(!list.length){
        tbodyCustomers.innerHTML = `<tr><td colspan="5">Nenhum cliente encontrado.</td></tr>`;
        badgeClientes.textContent = "0";
        return;
      }
      badgeClientes.textContent = String(list.length);

      list.forEach(c=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${c.full_name || "—"}</td>
          <td>${c.phone || "—"}</td>
          <td>${c.email || "—"}</td>
          <td>${c.document || "—"}</td>
          <td>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn2" onclick="openCustomerModal(${encodeURIComponent(JSON.stringify(c))})">Editar</button>
              ${state.isAdmin ? `<button class="btn2 btnDanger" onclick="deleteCustomer('${c.id}')">Excluir</button>` : ""}
            </div>
          </td>
        `;
        tbodyCustomers.appendChild(tr);
      });
    }

    async function loadProfessionals(){
      const { data, error } = await sb
        .from("professionals")
        .select("id,name,active")
        .order("name",{ascending:true});

      tbodyPros.innerHTML = "";
      if(error){ tbodyPros.innerHTML = `<tr><td colspan="3">Erro ao carregar profissionais.</td></tr>`; return; }
      if(!data.length){ tbodyPros.innerHTML = `<tr><td colspan="3">Nenhum profissional cadastrado.</td></tr>`; return; }

      badgePros.textContent = String(data.length);

      data.forEach(p=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.name}</td>
          <td>${p.active ? `<span class="tag ok">Ativo</span>` : `<span class="tag bad">Inativo</span>`}</td>
          <td>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn2" onclick="openProModal(${encodeURIComponent(JSON.stringify(p))})">Editar</button>
              <button class="btn2" onclick="togglePro('${p.id}', ${p.active})">${p.active ? "Inativar" : "Ativar"}</button>
              ${state.isAdmin ? `<button class="btn2 btnDanger" onclick="deletePro('${p.id}')">Excluir</button>` : ""}
            </div>
          </td>
        `;
        tbodyPros.appendChild(tr);
      });

      await loadMaps();
      await fillWorkingHoursPros();
    }

    async function loadServices(){
      const { data, error } = await sb
        .from("services")
        .select("id,name,duration_minutes,price_cents,active")
        .order("name",{ascending:true});

      tbodyServ.innerHTML = "";
      if(error){ tbodyServ.innerHTML = `<tr><td colspan="5">Erro ao carregar serviços.</td></tr>`; return; }
      if(!data.length){ tbodyServ.innerHTML = `<tr><td colspan="5">Nenhum serviço cadastrado.</td></tr>`; return; }

      badgeServ.textContent = String(data.length);

      data.forEach(s=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${s.name}</td>
          <td>${s.duration_minutes} min</td>
          <td>${money(s.price_cents)}</td>
          <td>${s.active ? `<span class="tag ok">Ativo</span>` : `<span class="tag bad">Inativo</span>`}</td>
          <td>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn2" onclick="openServiceModal(${encodeURIComponent(JSON.stringify(s))})">Editar</button>
              <button class="btn2" onclick="toggleService('${s.id}', ${s.active})">${s.active ? "Inativar" : "Ativar"}</button>
              ${state.isAdmin ? `<button class="btn2 btnDanger" onclick="deleteService('${s.id}')">Excluir</button>` : ""}
            </div>
          </td>
        `;
        tbodyServ.appendChild(tr);
      });

      await loadMaps();
    }

    async function loadWorkingHours(){
      const proId = whPro.value;

      let q = sb
        .from("working_hours")
        .select("id, professional_id, weekday, start_time, end_time, slot_minutes")
        .order("professional_id",{ascending:true})
        .order("weekday",{ascending:true})
        .order("start_time",{ascending:true});

      if(proId) q = q.eq("professional_id", proId);

      const { data, error } = await q;

      tbodyHours.innerHTML = "";
      if(error){
        tbodyHours.innerHTML = `<tr><td colspan="6">Erro ao carregar horários.</td></tr>`;
        return;
      }
      if(!data.length){
        tbodyHours.innerHTML = `<tr><td colspan="6">Nenhum horário cadastrado.</td></tr>`;
        return;
      }

      data.forEach(w=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${state.prosMap[w.professional_id] || "—"}</td>
          <td>${weekdayLabel(w.weekday)}</td>
          <td>${w.start_time}</td>
          <td>${w.end_time}</td>
          <td>${w.slot_minutes} min</td>
          <td>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn2" onclick="editWH('${w.id}')">Editar</button>
              ${state.isAdmin ? `<button class="btn2 btnDanger" onclick="deleteWH('${w.id}')">Excluir</button>` : ""}
            </div>
          </td>
        `;
        tbodyHours.appendChild(tr);
      });

      await loadCounts();
    }

    // ----- MODAIS / CRUD -----
    function esc(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    window.openCustomerModal = (encoded)=>{
      let c=null;
      if(encoded) c = JSON.parse(decodeURIComponent(encoded));
      const isEdit = !!c;
      c = c || { id:null, full_name:"", phone:"", email:"", document:"", birth_date:"", address:"", notes:"" };

      openModal(
        isEdit ? "Editar Cliente" : "Novo Cliente",
        `
          <div class="row2">
            <div><label>Nome completo</label><input id="c_full_name" value="${esc(c.full_name)}"/></div>
            <div><label>Telefone</label><input id="c_phone" value="${esc(c.phone||"")}"/></div>
          </div>
          <div class="row2">
            <div><label>E-mail</label><input id="c_email" value="${esc(c.email||"")}"/></div>
            <div><label>Documento</label><input id="c_document" value="${esc(c.document||"")}"/></div>
          </div>
          <div class="row2">
            <div><label>Nascimento</label><input id="c_birth" type="date" value="${c.birth_date||""}"/></div>
            <div><label>Endereço</label><input id="c_address" value="${esc(c.address||"")}"/></div>
          </div>
          <div><label>Observações</label><input id="c_notes" value="${esc(c.notes||"")}"/></div>
        `,
        `
          <button class="btn2" onclick="window.__closeModal()">Cancelar</button>
          <button class="btn" onclick="window.saveCustomer('${c.id||""}')">${isEdit ? "Salvar" : "Cadastrar"}</button>
        `
      );
    };

    window.saveCustomer = async (id)=>{
      if(!state?.profile?.company_id) return toastMsg("err","Sessão inválida (sem company_id).");

      const payload = {
        company_id: state.profile.company_id,
        full_name: document.getElementById("c_full_name").value.trim(),
        phone: document.getElementById("c_phone").value.trim() || null,
        email: document.getElementById("c_email").value.trim() || null,
        document: document.getElementById("c_document").value.trim() || null,
        birth_date: document.getElementById("c_birth").value || null,
        address: document.getElementById("c_address").value.trim() || null,
        notes: document.getElementById("c_notes").value.trim() || null
      };
      if(payload.full_name.length < 2) return toastMsg("err","Nome inválido.");

      let res;
      if(id){
        // update não precisa regravar company_id, mas não atrapalha
        res = await sb.from("customers").update(payload).eq("id", id);
      } else {
        res = await sb.from("customers").insert(payload);
      }

      if(res.error) return toastMsg("err","Erro ao salvar cliente.");
      toastMsg("ok", id ? "Cliente atualizado." : "Cliente cadastrado.");
      closeModal();
      await loadCustomers(); await loadCounts();
    };

    window.deleteCustomer = async (id)=>{
      if(!state.isAdmin) return toastMsg("err","Apenas ADMIN pode excluir.");
      if(!confirm("Excluir cliente?")) return;
      const { error } = await sb.from("customers").delete().eq("id", id);
      if(error) return toastMsg("err","Erro ao excluir.");
      toastMsg("ok","Cliente excluído.");
      await loadCustomers(); await loadCounts();
    };

    window.openProModal = (encoded)=>{
      let p=null;
      if(encoded) p = JSON.parse(decodeURIComponent(encoded));
      const isEdit = !!p;
      p = p || { id:null, name:"", active:true };

      openModal(
        isEdit ? "Editar Profissional" : "Novo Profissional",
        `
          <div class="row2">
            <div><label>Nome</label><input id="p_name" value="${esc(p.name)}"/></div>
            <div>
              <label>Status</label>
              <select id="p_active">
                <option value="true" ${p.active ? "selected":""}>Ativo</option>
                <option value="false" ${!p.active ? "selected":""}>Inativo</option>
              </select>
            </div>
          </div>
        `,
        `
          <button class="btn2" onclick="window.__closeModal()">Cancelar</button>
          <button class="btn" onclick="window.savePro('${p.id||""}')">${isEdit ? "Salvar" : "Cadastrar"}</button>
        `
      );
    };

    window.savePro = async (id)=>{
      if(!state?.profile?.company_id) return toastMsg("err","Sessão inválida (sem company_id).");

      const name = document.getElementById("p_name").value.trim();
      const active = document.getElementById("p_active").value === "true";
      if(name.length < 2) return toastMsg("err","Nome inválido.");

      let res;
      if(id){
        res = await sb.from("professionals").update({ name, active }).eq("id", id);
      } else {
        res = await sb.from("professionals").insert({ company_id: state.profile.company_id, name, active });
      }

      if(res.error) return toastMsg("err","Erro ao salvar profissional.");
      toastMsg("ok", id ? "Profissional atualizado." : "Profissional cadastrado.");
      closeModal();
      await loadProfessionals(); await loadCounts();
    };

    window.togglePro = async (id, active)=>{
      const { error } = await sb.from("professionals").update({ active: !active }).eq("id", id);
      if(error) return toastMsg("err","Erro ao atualizar.");
      toastMsg("ok","Atualizado.");
      await loadProfessionals(); await loadCounts();
    };

    window.deletePro = async (id)=>{
      if(!state.isAdmin) return toastMsg("err","Apenas ADMIN pode excluir.");
      if(!confirm("Excluir profissional?")) return;
      const { error } = await sb.from("professionals").delete().eq("id", id);
      if(error) return toastMsg("err","Erro ao excluir.");
      toastMsg("ok","Profissional excluído.");
      await loadProfessionals(); await loadCounts();
    };

    window.openServiceModal = (encoded)=>{
      let s=null;
      if(encoded) s = JSON.parse(decodeURIComponent(encoded));
      const isEdit = !!s;
      s = s || { id:null, name:"", duration_minutes:30, price_cents:0, active:true };

      openModal(
        isEdit ? "Editar Serviço" : "Novo Serviço",
        `
          <div class="row2">
            <div><label>Nome do serviço</label><input id="s_name" value="${esc(s.name)}"/></div>
            <div><label>Duração (min)</label><input id="s_dur" type="number" min="10" max="480" value="${Number(s.duration_minutes||30)}"/></div>
          </div>
          <div class="row2">
            <div><label>Preço (R$)</label><input id="s_price" type="number" step="0.01" value="${(Number(s.price_cents||0)/100).toFixed(2)}"/></div>
            <div>
              <label>Status</label>
              <select id="s_active">
                <option value="true" ${s.active ? "selected":""}>Ativo</option>
                <option value="false" ${!s.active ? "selected":""}>Inativo</option>
              </select>
            </div>
          </div>
        `,
        `
          <button class="btn2" onclick="window.__closeModal()">Cancelar</button>
          <button class="btn" onclick="window.saveService('${s.id||""}')">${isEdit ? "Salvar" : "Cadastrar"}</button>
        `
      );
    };

    window.saveService = async (id)=>{
      if(!state?.profile?.company_id) return toastMsg("err","Sessão inválida (sem company_id).");

      const name = document.getElementById("s_name").value.trim();
      const duration_minutes = Number(document.getElementById("s_dur").value || 30);
      const price = Number(document.getElementById("s_price").value || 0);
      const price_cents = Math.round(price * 100);
      const active = document.getElementById("s_active").value === "true";

      if(name.length < 2) return toastMsg("err","Nome inválido.");
      if(duration_minutes < 10 || duration_minutes > 480) return toastMsg("err","Duração inválida.");

      let res;
      if(id){
        res = await sb.from("services").update({ name, duration_minutes, price_cents, active }).eq("id", id);
      } else {
        res = await sb.from("services").insert({ company_id: state.profile.company_id, name, duration_minutes, price_cents, active });
      }

      if(res.error) return toastMsg("err","Erro ao salvar serviço.");
      toastMsg("ok", id ? "Serviço atualizado." : "Serviço cadastrado.");
      closeModal();
      await loadServices(); await loadCounts();
    };

    window.toggleService = async (id, active)=>{
      const { error } = await sb.from("services").update({ active: !active }).eq("id", id);
      if(error) return toastMsg("err","Erro ao atualizar.");
      toastMsg("ok","Atualizado.");
      await loadServices(); await loadCounts();
    };

    window.deleteService = async (id)=>{
      if(!state.isAdmin) return toastMsg("err","Apenas ADMIN pode excluir.");
      if(!confirm("Excluir serviço?")) return;
      const { error } = await sb.from("services").delete().eq("id", id);
      if(error) return toastMsg("err","Erro ao excluir.");
      toastMsg("ok","Serviço excluído.");
      await loadServices(); await loadCounts();
    };

    // Working hours edit/delete
    window.editWH = async (id)=>{
      const { data, error } = await sb.from("working_hours")
        .select("id, professional_id, weekday, start_time, end_time, slot_minutes")
        .eq("id", id).maybeSingle();

      if(error || !data) return toastMsg("err","Erro ao abrir horário.");

      openModal(
        "Editar Horário",
        `
          <div class="row2">
            <div>
              <label>Profissional</label>
              <select id="wh_e_pro">
                ${state.pros.filter(p=>p.active).map(p=>`<option value="${p.id}" ${p.id===data.professional_id?"selected":""}>${p.name}</option>`).join("")}
              </select>
            </div>
            <div>
              <label>Dia</label>
              <select id="wh_e_day">
                ${[0,1,2,3,4,5,6].map(w=>`<option value="${w}" ${Number(w)===Number(data.weekday)?"selected":""}>${weekdayLabel(w)}</option>`).join("")}
              </select>
            </div>
          </div>
          <div class="row2">
            <div><label>Início</label><input id="wh_e_start" type="time" value="${data.start_time}"/></div>
            <div><label>Fim</label><input id="wh_e_end" type="time" value="${data.end_time}"/></div>
          </div>
          <div><label>Slot (min)</label><input id="wh_e_slot" type="number" min="10" max="180" value="${data.slot_minutes}"/></div>
        `,
        `
          <button class="btn2" onclick="window.__closeModal()">Cancelar</button>
          <button class="btn" onclick="window.saveWH('${data.id}')">Salvar</button>
        `
      );
    };

    window.saveWH = async (id)=>{
      if(!state?.profile?.company_id) return toastMsg("err","Sessão inválida (sem company_id).");

      const professional_id = document.getElementById("wh_e_pro").value;
      const weekday = Number(document.getElementById("wh_e_day").value);
      const start_time = document.getElementById("wh_e_start").value;
      const end_time = document.getElementById("wh_e_end").value;
      const slot_minutes = Number(document.getElementById("wh_e_slot").value || 30);

      if(start_time >= end_time) return toastMsg("err","Início deve ser menor que fim.");
      if(slot_minutes < 10 || slot_minutes > 180) return toastMsg("err","Slot inválido.");

      const { error } = await sb.from("working_hours")
        .update({ professional_id, weekday, start_time, end_time, slot_minutes })
        .eq("id", id);

      if(error) return toastMsg("err","Erro ao salvar horário.");
      toastMsg("ok","Horário atualizado.");
      closeModal();
      await loadWorkingHours();
    };

    window.deleteWH = async (id)=>{
      if(!state.isAdmin) return toastMsg("err","Apenas ADMIN pode excluir.");
      if(!confirm("Excluir horário?")) return;
      const { error } = await sb.from("working_hours").delete().eq("id", id);
      if(error) return toastMsg("err","Erro ao excluir.");
      toastMsg("ok","Horário excluído.");
      await loadWorkingHours();
    };

    window.__closeModal = closeModal;

    // Auto start
    (async ()=>{
      const { data: sess } = await sb.auth.getSession();
      if(sess?.session){
        await bootstrap();
      } else {
        resetState();
        showLogin();
      }
    })();
  </script>
</body>
</html>
