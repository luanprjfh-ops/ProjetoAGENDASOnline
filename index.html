<!doctype html>
<!--
  Painel Administrativo ‚Ä¢ AgendaPro (Multi-empresa ‚Ä¢ Supabase)
  - Este arquivo √© 100% est√°tico (HTML + JS) e consome Supabase.
  - Configure SUPABASE_URL e SUPABASE_ANON_KEY no bloco <script> (logo abaixo).
  - Requisitos atendidos: multi-tenant por company_id, autentica√ß√£o Supabase, RLS no banco.
-->
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Painel ADM ‚Ä¢ AgendaPro</title>

  <style>

@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');

:root{
  /* Base */
  --bg:#07020b; /* mant√©m seu fundo */
  --text:#F5F3FF;
  --text2:#E7E3F7;
  --muted:#B9B3D4;
  --muted2:#9C96B8;

  /* Surfaces (glass premium) */
  --surface: rgba(14, 8, 20, .72);
  --surface2: rgba(12, 6, 16, .58);
  --surface3: rgba(10, 6, 14, .46);

  /* Accents */
  --accent1:#C084FC;   /* lil√°s premium */
  --accent2:#A855F7;   /* roxo intenso */
  --accent3:#FF4FD8;   /* pink neon controlado */

  /* Lines + shadow */
  --border:rgba(255,255,255,.10);
  --border2:rgba(255,255,255,.14);
  --shadow: 0 24px 70px rgba(0,0,0,.58);
  --shadow2: 0 14px 34px rgba(0,0,0,.40);
  --radius: 18px;

  /* Status */
  --ok:#22c55e;
  --bad:#fb7185;
  --done:#a78bfa;

  /* Glows */
  --glowA: rgba(192,132,252,.28);
  --glowB: rgba(168,85,247,.24);
  --glowP: rgba(255,79,216,.20);
}

*{box-sizing:border-box}
html,body{height:100%}

body{
  margin:0;
  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  color:var(--text);
  background:
    radial-gradient(1200px 620px at 16% 12%, rgba(255,79,216,.15), transparent 55%),
    radial-gradient(980px 620px at 86% 28%, rgba(168,85,247,.16), transparent 56%),
    radial-gradient(1200px 740px at 42% 96%, rgba(192,132,252,.10), transparent 60%),
    var(--bg);
  min-height:100vh;
  overflow-x:hidden;
  text-rendering: geometricPrecision;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

body::before, body::after{
  content:"";
  position:fixed;
  inset:-120px;
  z-index:-1;
  pointer-events:none;
  filter: blur(26px);
  opacity:.86;
  transform: translate3d(0,0,0);
}

body::before{
  background:
    radial-gradient(circle at 18% 20%, rgba(255,79,216,.36), transparent 36%),
    radial-gradient(circle at 84% 34%, rgba(168,85,247,.36), transparent 40%),
    radial-gradient(circle at 40% 90%, rgba(192,132,252,.18), transparent 44%);
  animation: floatGlow 11s ease-in-out infinite;
}

body::after{
  background:
    radial-gradient(circle at 64% 14%, rgba(255,255,255,.07), transparent 32%),
    radial-gradient(circle at 10% 70%, rgba(168,85,247,.14), transparent 36%),
    radial-gradient(circle at 92% 86%, rgba(255,79,216,.12), transparent 40%);
  animation: floatGlow2 15s ease-in-out infinite;
  opacity:.55;
}

@keyframes floatGlow{
  0%,100%{ transform: translate3d(0,0,0) scale(1); }
  50%{ transform: translate3d(18px,-10px,0) scale(1.03); }
}
@keyframes floatGlow2{
  0%,100%{ transform: translate3d(0,0,0) scale(1); }
  50%{ transform: translate3d(-16px,12px,0) scale(1.02); }
}

.hidden{display:none!important}

.wrap{max-width:1480px;margin:0 auto;padding:26px 32px}
@media (min-width:1600px){.wrap{max-width:1600px}}
@media (max-width:640px){.wrap{padding:18px}}

.card{
  background: linear-gradient(180deg, rgba(255,255,255,.045), rgba(255,255,255,.02)) , var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  backdrop-filter: blur(14px);
}

.card.soft{
  background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.015)) , var(--surface2);
}

.brand{
  font-weight:900;
  font-size:24px;
  margin:0;
  letter-spacing:.2px;
  background: linear-gradient(90deg, var(--accent3), var(--accent2), var(--accent1));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  text-shadow: 0 0 22px rgba(168,85,247,.12);
}

.muted{color:var(--muted)}
.smallMuted{color:var(--muted2)}

.pill{
  padding:8px 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background: linear-gradient(90deg, rgba(255,79,216,.10), rgba(168,85,247,.10));
  font-weight:800;
  font-size:13px;
  white-space:nowrap;
  color: var(--text);
}

/* LOGIN */
.center{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px}
.login{width:420px;padding:24px}
label{font-size:12px;color:var(--muted);display:block;margin-top:10px}

input, select{
  width:100%;
  padding:12px 14px;
  min-height:46px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.14);
  outline:none;
  margin-top:6px;
  font-size:14px;
  background: rgba(10,6,14,.68);
  color: var(--text);
  box-shadow: 0 0 0 0 rgba(0,0,0,0);
}

input::placeholder{color: rgba(245,243,255,.45)}

input:focus, select:focus{
  border-color: rgba(192,132,252,.55);
  box-shadow:
    0 0 0 4px rgba(168,85,247,.14),
    0 0 0 1px rgba(255,255,255,.08) inset;
}

.btn{
  border:0;
  padding:12px 14px;
  border-radius:14px;
  font-weight:900;
  cursor:pointer;
  color:#0b0410;
  background: linear-gradient(135deg, var(--accent2), var(--accent1));
  box-shadow: 0 16px 34px rgba(168,85,247,.28), 0 10px 22px rgba(0,0,0,.35);
  transition: transform .16s ease, filter .16s ease, box-shadow .16s ease;
}

.btn:hover{
  transform: translateY(-1px);
  filter: brightness(1.03);
  box-shadow: 0 18px 42px rgba(168,85,247,.32), 0 10px 22px rgba(0,0,0,.35);
}

.btn:disabled{opacity:.6;cursor:not-allowed;transform:none;filter:none}

.btn2{
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.04);
  padding:10px 14px;
  min-height:46px;
  border-radius:14px;
  cursor:pointer;
  font-weight:900;
  color: var(--text);
  transition: transform .16s ease, background .16s ease, border-color .16s ease, filter .16s ease;
}

.btn2:hover{
  background: rgba(255,255,255,.07);
  border-color: rgba(255,255,255,.20);
  transform: translateY(-1px);
}

.btn2:active{transform: translateY(0px); filter: brightness(.98);}

.btnDanger{
  border:1px solid rgba(251,113,133,.55);
  background: rgba(251,113,133,.10);
  color:#fecdd3;
}
.btnDanger:hover{background: rgba(251,113,133,.14);}

.error{
  display:none;
  margin-top:10px;
  padding:10px 12px;
  border-radius:14px;
  background: rgba(251,113,133,.12);
  border:1px solid rgba(251,113,133,.35);
  color:#fecdd3;
  font-size:13px;
}

.toast{
  position:fixed;
  right:18px;
  bottom:18px;
  min-width:260px;
  max-width:380px;
  padding:12px 14px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(10,6,14,.78);
  box-shadow:var(--shadow2);
  display:none;
  z-index:9999;
  color: var(--text);
  backdrop-filter: blur(14px);
}
.toast.ok{border-color: rgba(34,197,94,.50)}
.toast.err{border-color: rgba(251,113,133,.55)}

/* LAYOUT */
.topbar{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:16px 18px;
  margin-top:14px;
  gap:10px;
  position:relative; /* n√£o segue a rolagem por padr√£o */
  top:auto;
  z-index:50;
  transition: transform .18s ease, opacity .18s ease, box-shadow .18s ease, background .18s ease;
}

/* Op√ß√µes de layout (persistentes) */
body.topbarPinned .topbar{
  position:sticky;
  top:14px;
}
body.topbarHidden .topbar{
  transform: translateY(-130%);
  opacity:0;
  pointer-events:none;
}

/* Modo Foco: tela limpa */
body.appFocus .sidebar{display:none!important;}
body.appFocus .topbar{
  position:sticky;
  top:14px;
  padding:10px 12px;
  border-radius:999px;
  max-width: fit-content;
  margin-left:auto;
}
body.appFocus .topbar .muted{display:none!important;}
body.appFocus .row{gap:0;}
body.appFocus .content{min-width:0;}


.row{display:flex;gap:16px;flex-wrap:wrap;margin-top:14px}

.sidebar{
  position:relative; /* n√£o segue a rolagem por padr√£o */
  top:auto;
  align-self:flex-start;
  width:280px;
  padding:16px;
  background: linear-gradient(180deg, rgba(255,255,255,.035), rgba(255,255,255,.015)), var(--surface2);
  border:1px solid var(--border);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  backdrop-filter: blur(14px);
}
body.menuPinned .sidebar{
  position:sticky;
  top:94px;
}


.menu{margin-top:14px;display:flex;flex-direction:column;gap:8px}

.menu button{
  position:relative;
  text-align:left;
  border:1px solid transparent;
  background:transparent;
  padding:12px 12px 12px 12px;
  border-radius:14px;
  font-weight:900;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  color: var(--text2);
  transition: transform .16s ease, background .16s ease, border-color .16s ease;
}

.menu button:hover{
  background: rgba(255,255,255,.06);
  border-color: rgba(255,255,255,.16);
  transform: translateY(-1px);
}

.menu .active{
  background: rgba(255,255,255,.07);
  border-color: rgba(192,132,252,.28);
}

.menu .active::before{
  content:"";
  position:absolute;
  left:-1px;
  top:10px;
  bottom:10px;
  width:3px;
  border-radius:8px;
  background: linear-gradient(180deg, var(--accent1), var(--accent2));
  box-shadow: 0 0 18px rgba(168,85,247,.30);
}

.content{flex:1;min-width:300px;min-height:70vh}

.section{padding:18px}
.section h2{
  margin:0 0 6px 0;
  font-size:24px;
  letter-spacing:.2px;
  color: var(--text);
}
.section p{
  margin:0 0 14px 0;
  color:var(--muted);
  font-size:15px;
  line-height:1.45;
}

.grid{
  display:grid;
  grid-template-columns: repeat(4, minmax(0,1fr));
  gap:14px;
}
@media (max-width:1100px){.grid{grid-template-columns: repeat(2, minmax(0,1fr));}}
@media (max-width:760px){.grid{grid-template-columns: 1fr;}.sidebar{width:100%}}

.kpi{
  padding:16px;
  position:relative;
  overflow:hidden;
  background: linear-gradient(180deg, rgba(255,255,255,.045), rgba(255,255,255,.02)) , var(--surface3);
  border:1px solid rgba(255,255,255,.10);
  box-shadow: var(--shadow2);
  transition: transform .16s ease, border-color .16s ease, background .16s ease;
}
.kpi:hover{
  transform: translateY(-2px);
  border-color: rgba(192,132,252,.22);
  background: linear-gradient(180deg, rgba(192,132,252,.06), rgba(255,255,255,.015)) , var(--surface3);
}
.kpi::after{
  content:"";
  position:absolute;
  right:-60px;
  top:-60px;
  width:160px;
  height:160px;
  border-radius:999px;
  background: radial-gradient(circle at 30% 30%, rgba(192,132,252,.22), transparent 55%),
              radial-gradient(circle at 65% 65%, rgba(255,79,216,.16), transparent 60%);
  filter: blur(1px);
  opacity:.9;
}
.kpi h3{margin:0 0 6px 0;font-size:12px;color:var(--muted);letter-spacing:.08em;text-transform:uppercase}
.kpi .big{font-size:34px;font-weight:900;margin:0;color:var(--text);letter-spacing:.2px}

.toolbar{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  align-items:center;
  justify-content:space-between;
  margin:12px 0 14px;
  padding:14px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.03);
  backdrop-filter: blur(14px);
}

.toolbar .left,.toolbar .right{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.miniInput{width:auto;min-width:220px}

/* TABLE */
table{width:100%;border-collapse:separate;border-spacing:0 10px}
th{
  font-size:12px;
  color: rgba(245,243,255,.70);
  text-align:left;
  padding:12px 10px;
  position:sticky;
  top:0;
  background: rgba(10,6,14,.84);
  backdrop-filter: blur(14px);
  border-bottom:1px solid rgba(255,255,255,.08);
  z-index:2;
  letter-spacing:.08em;
  text-transform:uppercase
}

td{
  background: rgba(10,6,14,.56);
  border:1px solid rgba(255,255,255,.10);
  padding:12px 10px;
  vertical-align:middle;
  color: var(--text);
  backdrop-filter: blur(10px);
  transition: background .16s ease, border-color .16s ease, transform .16s ease;
}
td:first-child{border-radius:14px 0 0 14px}
td:last-child{border-radius:0 14px 14px 0}
tbody tr:hover td{
  background: rgba(255,255,255,.065);
  border-color: rgba(255,255,255,.16);
}

/* Tags */
.tag{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:900;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.04);
  color: var(--text);
  white-space:nowrap;
}
.tag.ok{border-color: rgba(34,197,94,.45);background: rgba(34,197,94,.12);color: #86efac}
.tag.bad{border-color: rgba(251,113,133,.45);background: rgba(251,113,133,.12);color: #fecdd3}
.tag.done{border-color: rgba(167,139,250,.45);background: rgba(167,139,250,.12);color: #ddd6fe}

/* MODAL */
.modalBack{
  position:fixed; inset:0;
  background: rgba(0,0,0,.58);
  display:none;
  align-items:center;
  justify-content:center;
  padding:18px;
  z-index:9998;
}
.modal{width:100%;max-width:560px;padding:16px}
.modalHeader{display:flex;justify-content:space-between;gap:10px;align-items:center}
.modalHeader h3{margin:0}
.modalBody{margin-top:10px}
.modalBody .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media (max-width:640px){.modalBody .row2{grid-template-columns:1fr}}
.modalFooter{display:flex;gap:10px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap}


/* Compact controls */
.ctrlPill{
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.04);
  padding:10px 12px;
  min-height:46px;
  border-radius:999px;
  cursor:pointer;
  font-weight:1000;
  color: var(--text);
  transition: transform .16s ease, background .16s ease, border-color .16s ease, filter .16s ease;
}
.ctrlPill:hover{background: rgba(255,255,255,.07); border-color: rgba(255,255,255,.20); transform: translateY(-1px);}
.ctrlPill:active{transform: translateY(0px); filter: brightness(.98);}
.ctrlPill.on{
  border-color: rgba(192,132,252,.35);
  background: rgba(192,132,252,.10);
}
/* New premium layout controls (2026) */
.topbarRight{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
  justify-content:flex-end;
}
.topbarActions{display:flex;gap:10px;align-items:center}

.iconBtn{
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.04);
  width:46px; height:46px;
  border-radius:999px;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  color: var(--text);
  transition: transform .16s ease, background .16s ease, border-color .16s ease, filter .16s ease;
}
.iconBtn.small{width:40px;height:40px;border-radius:14px}
.iconBtn:hover{background: rgba(255,255,255,.07); border-color: rgba(255,255,255,.20); transform: translateY(-1px);}
.iconBtn:active{transform: translateY(0px); filter: brightness(.98);}
.iconBtn .icon{display:inline-flex}
.iconBtn svg{
  width:20px;height:20px;
  stroke: currentColor;
  fill:none;
  stroke-width:2.2;
  stroke-linecap:round;
  stroke-linejoin:round;
  opacity:.92;
}

.dropdown{position:relative}
.menuDropdown{
  position:absolute;
  right:0;
  top:54px;
  min-width:240px;
  padding:10px;
  display:none;
  z-index:9999;
}
.dropdown.open .menuDropdown{display:block}
.ddItem{
  width:100%;
  text-align:left;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.03);
  padding:12px 12px;
  border-radius:12px;
  cursor:pointer;
  color: var(--text);
  font-weight:900;
  transition: transform .16s ease, background .16s ease, border-color .16s ease;
}
.ddItem:hover{background: rgba(255,255,255,.07); border-color: rgba(255,255,255,.18); transform: translateY(-1px);}
.ddItem.danger{border-color: rgba(251,113,133,.28); background: rgba(251,113,133,.08);}
.ddLine{height:1px;background: rgba(255,255,255,.10); margin:10px 2px}

.sidebarOverlay{
  position:fixed; inset:0;
  background: rgba(0,0,0,.58);
  display:none;
  z-index:9997;
}
body.sidebarOpen .sidebarOverlay{display:block;}

.sidebar{
  transition: width .22s ease, transform .22s ease, opacity .22s ease;
}
.sideHeader{display:flex; align-items:center; justify-content:space-between; gap:10px;}
.sideBrand{display:flex; gap:10px; align-items:center;}
.sideMark{
  width:12px;height:12px;border-radius:999px;
  background: linear-gradient(135deg, var(--accent3), var(--accent2), var(--accent1));
  box-shadow: 0 0 20px rgba(168,85,247,.22);
}
.sideTitle{font-weight:1000; letter-spacing:.2px}
.sideSub{font-size:12px;color:var(--muted); margin-top:1px}

.sideSearch{
  margin-top:12px;
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(10,6,14,.55);
}
.sideSearch input{
  border:0;
  padding:0;
  margin:0;
  min-height:unset;
  background: transparent;
}
.sideSearch .icon svg{width:18px;height:18px;opacity:.85}

.menu{margin-top:12px;}
.menuSep{
  height:1px;
  background: rgba(255,255,255,.10);
  margin:8px 6px;
  border-radius:999px;
}
.menu button{
  padding:12px 12px;
}
.menu button .itemLeft{display:flex;align-items:center;gap:12px}
.menu button .i{width:22px;height:22px;display:inline-flex;align-items:center;justify-content:center;opacity:.92}
.menu button .i svg{
  width:20px;height:20px;
  stroke: currentColor;
  fill:none;
  stroke-width:2.2;
  stroke-linecap:round;
  stroke-linejoin:round;
}
.menu button .label{letter-spacing:.1px}
.menu button .tag{min-width:32px;display:inline-flex;justify-content:center}

body.menuCollapsed .sidebar{width:92px; padding:14px 10px;}
body.menuCollapsed .sideTexts,
body.menuCollapsed .sideSearch,
body.menuCollapsed .menu button .label,
body.menuCollapsed .sidebar .muted{display:none!important;}
body.menuCollapsed .menu button{justify-content:center; padding:12px 10px;}
body.menuCollapsed .menu button .itemLeft{gap:0;}
body.menuCollapsed .menu button .tag{display:none!important;}
body.menuCollapsed .menuSep{margin:10px 8px;}
body.menuCollapsed .menu button:hover{transform:none}

@media (max-width:760px){
  .sidebar{
    position:fixed;
    left:18px; right:auto;
    top:86px;
    bottom:18px;
    width:min(86vw, 340px);
    transform: translateX(-125%);
    z-index:9998;
  }
  body.sidebarOpen .sidebar{transform: translateX(0%);}
}
/* Accessibility */
:focus-visible{
  outline: 2px solid rgba(192,132,252,.55);
  outline-offset: 2px;
}

  
/* WhatsApp quick action */
.waBtn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  padding:8px 10px;
  border-radius:12px;
  border:1px solid rgba(34,197,94,.45);
  background: rgba(34,197,94,.10);
  color:#86efac;
  font-weight:900;
  font-size:12px;
  text-decoration:none;
  white-space:nowrap;
  transition: transform .16s ease, filter .16s ease, background .16s ease, border-color .16s ease;
}
.waBtn:hover{
  transform: translateY(-1px);
  filter: brightness(1.03);
  background: rgba(34,197,94,.14);
  border-color: rgba(34,197,94,.55);
}
.waBtn:active{transform: translateY(0px); filter: brightness(.98);}
.waBtn.small{padding:6px 9px; font-size:12px; border-radius:999px}
.phoneCell{display:flex;align-items:center;gap:10px;flex-wrap:wrap}

/* Status warning (Aguardando) */
.tag.warn{border-color: rgba(250,204,21,.50);background: rgba(250,204,21,.12);color: #fde68a}

/* Clickable customer name */
.linkBtn{
  background:transparent;
  border:0;
  padding:0;
  margin:0;
  color: var(--text);
  font-weight:900;
  cursor:pointer;
  text-decoration: underline;
  text-decoration-color: rgba(192,132,252,.35);
  text-underline-offset: 3px;
}
.linkBtn:hover{ text-decoration-color: rgba(192,132,252,.65); }

/* Menu modal */
.menuGrid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
}
@media (max-width:640px){.menuGrid{grid-template-columns:1fr}}
.menuTile{
  text-align:left;
  padding:14px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.04);
  cursor:pointer;
  transition: transform .16s ease, background .16s ease, border-color .16s ease;
}
.menuTile:hover{
  transform: translateY(-1px);
  background: rgba(255,255,255,.07);
  border-color: rgba(255,255,255,.20);
}
.menuTile .t{font-weight:1000;color:var(--text);margin-bottom:4px}
.menuTile .d{font-size:12px;color:var(--muted)}


/* =========================
   PREMIUM LOGIN (Split)
   - Inspired by modern SaaS layouts
   - Does NOT change the internal app UI
   ========================= */
#loginView.loginShell{
  position: fixed;
  inset: 0;
  display: flex;
  align-items: stretch;
  justify-content: center;
  padding: 24px;
  background:
    radial-gradient(1200px 700px at 18% 12%, rgba(168,85,247,.14), transparent 55%),
    radial-gradient(1000px 720px at 86% 20%, rgba(192,132,252,.14), transparent 58%),
    radial-gradient(1200px 740px at 40% 96%, rgba(255,79,216,.10), transparent 60%),
    #07020b;
  overflow: auto;
}

#loginView .loginGrid{
  width: min(1180px, 100%);
  min-height: 640px;
  display: grid;
  grid-template-columns: 1fr 1.15fr;
  gap: 22px;
  align-items: stretch;
}

@media (max-width: 980px){
  #loginView .loginGrid{ grid-template-columns: 1fr; min-height: auto; }
  #loginView .loginHero{ display:none; }
  #loginView.loginShell{ padding: 18px; }
}

#loginView .loginCardWrap{
  display:flex;
  align-items:center;
  justify-content:center;
}

#loginView .loginCard{
  width: min(460px, 100%);
  padding: 28px 26px;
  border-radius: 20px;
  border: 1px solid rgba(255,255,255,.12);
  background:
    linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)),
    rgba(14, 8, 20, .72);
  box-shadow: 0 26px 78px rgba(0,0,0,.55);
  backdrop-filter: blur(14px);
}

#loginView .loginBrandRow{
  display:flex;
  gap:12px;
  align-items:center;
}

#loginView .loginMark{
  width:44px;
  height:44px;
  border-radius: 14px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight: 1000;
  letter-spacing: .2px;
  color:#0b0410;
  background: linear-gradient(135deg, var(--accent2), var(--accent1));
  box-shadow: 0 14px 30px rgba(168,85,247,.28);
}

#loginView .loginBrandName{
  font-weight: 1000;
  font-size: 18px;
  letter-spacing: .3px;
  color: var(--text);
}
#loginView .loginBrandName span{ color: var(--accent1); }

#loginView .loginBrandTag{
  margin-top:2px;
  font-size: 12px;
  color: var(--muted2);
  letter-spacing: .08em;
  text-transform: uppercase;
}

#loginView .loginTitle{
  margin: 18px 0 6px;
  font-size: 22px;
  letter-spacing: .2px;
}
#loginView .loginSub{
  margin: 0 0 14px;
  color: var(--muted);
  font-size: 14px;
  line-height: 1.45;
}

#loginView .loginForm label{
  font-size: 12px;
  color: var(--muted);
  display:block;
  margin-top: 10px;
}

#loginView .loginForm input{
  width:100%;
  padding: 12px 14px;
  min-height: 46px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.14);
  outline: none;
  margin-top: 6px;
  font-size: 14px;
  background: rgba(10,6,14,.68);
  color: var(--text);
}

#loginView .passWrap{
  position: relative;
  margin-top: 6px;
}
#loginView .passWrap input{ margin-top: 0; padding-right: 48px; }

#loginView .passToggle{
  position:absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.05);
  color: var(--text);
  width: 34px;
  height: 34px;
  border-radius: 12px;
  cursor: pointer;
}
#loginView .passToggle:hover{ background: rgba(255,255,255,.08); }

#loginView .loginPrimary{
  margin-top: 16px;
  font-size: 15px;
}

#loginView .loginFoot{
  margin-top: 18px;
  font-size: 12px;
  color: var(--muted2);
  text-align:center;
}

/* RIGHT HERO (visual only) */
#loginView .loginHero{
  position: relative;
  border-radius: 22px;
  border: 1px solid rgba(255,255,255,.10);
  background:
    radial-gradient(900px 520px at 78% 10%, rgba(192,132,252,.10), transparent 55%),
    radial-gradient(900px 620px at 22% 90%, rgba(168,85,247,.10), transparent 60%),
    rgba(10,6,14,.35);
  overflow: hidden;
  box-shadow: 0 26px 78px rgba(0,0,0,.45);
  backdrop-filter: blur(14px);
}

#loginView .heroInner{
  height: 100%;
  padding: 34px 34px;
  display:flex;
  flex-direction: column;
  justify-content: center;
  gap: 18px;
}

#loginView .heroBadge{
  display:inline-flex;
  align-self:flex-start;
  padding: 8px 12px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.04);
  color: var(--text);
  font-weight: 900;
  font-size: 12px;
  letter-spacing: .08em;
  text-transform: uppercase;
}

#loginView .heroLogo{
  display:flex;
  align-items: center;
  gap: 12px;
}
#loginView .heroIcon{
  width: 54px;
  height: 54px;
  border-radius: 18px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight: 1000;
  font-size: 22px;
  color:#0b0410;
  background: linear-gradient(135deg, var(--accent2), var(--accent1));
  box-shadow: 0 16px 34px rgba(168,85,247,.28);
}
#loginView .heroName{
  font-weight: 1000;
  font-size: 30px;
  letter-spacing: .6px;
}
#loginView .heroName span{ color: var(--accent1); }
#loginView .heroBy{
  margin-top: 2px;
  color: var(--muted);
  font-size: 13px;
}

#loginView .heroBig{
  font-size: 32px;
  line-height: 1.15;
  font-weight: 900;
  letter-spacing: .2px;
  color: var(--text);
  text-shadow: 0 12px 44px rgba(0,0,0,.55);
}

#loginView .heroWa{
  position: absolute;
  right: 18px;
  bottom: 18px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding: 12px 14px;
  border-radius: 999px;
  border: 1px solid rgba(34,197,94,.55);
  background: rgba(34,197,94,.12);
  color: #86efac;
  font-weight: 1000;
  text-decoration: none;
}

#loginView .heroWa:hover{
  background: rgba(34,197,94,.16);
  border-color: rgba(34,197,94,.70);
}

#loginView .heroDeco{
  position:absolute;
  border-radius: 999px;
  pointer-events:none;
  filter: blur(0px);
  opacity: .55;
}
#loginView .heroDeco.d1{
  width: 380px; height: 380px;
  right: -160px; top: -160px;
  border: 2px solid rgba(255,255,255,.08);
}
#loginView .heroDeco.d2{
  width: 520px; height: 520px;
  right: -260px; top: -220px;
  border: 2px solid rgba(255,255,255,.06);
}
#loginView .heroDeco.d3{
  width: 520px; height: 520px;
  left: -260px; bottom: -280px;
  border: 2px solid rgba(255,255,255,.05);
}

</style>

  <link rel="icon" href="data:," />
</head>

<body>

  
  <!-- LOGIN (Premium split layout) -->
  <div id="loginView" class="loginShell">
    <div class="loginGrid">

      <!-- LEFT: Card -->
      <section class="loginCardWrap">
        <div class="loginCard">
          <div class="loginBrandRow">
            <div class="loginMark" aria-hidden="true">AP</div>
            <div>
              <div class="loginBrandName">Agenda<span>PRO</span></div>
              <div class="loginBrandTag">Painel Administrativo</div>
            </div>
          </div>

          <h2 class="loginTitle">Acesso ao sistema</h2>
          <p class="loginSub">Entre com suas credenciais para continuar.</p>

          <div class="loginForm">
            <label for="email">E-mail</label>
            <input id="email" placeholder="seu@email.com" autocomplete="email" />

            <label for="password">Senha</label>
            <div class="passWrap">
              <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
              <button class="passToggle" type="button" aria-label="Mostrar/ocultar senha" onclick="togglePassword()">üëÅ</button>
            </div>

            <div id="err" class="error"></div>

            <button id="btnLogin" class="btn loginPrimary" style="width:100%">Entrar</button>
          </div>

          <div class="loginFoot">
            <span>LEP Sistemas ‚Ä¢ Agenda Online</span>
          </div>
        </div>
      </section>

      <!-- RIGHT: Hero -->
      <aside class="loginHero" aria-hidden="true">
        <div class="heroInner">
          <div class="heroBadge">Solu√ß√£o profissional</div>

          <div class="heroLogo">
            <div class="heroIcon">$</div>
            <div class="heroName">Agenda<span>PRO</span></div>
            <div class="heroBy">por LEP Sistemas</div>
          </div>

          <div class="heroBig">
            O sistema completo<br/>
            para gest√£o de agenda<br/>
            da sua Barbearia e 
            Sal√£o de beleza
          </div>

          <a class="heroWa" href="https://wa.me/" target="_blank" rel="noopener" title="Suporte via WhatsApp">
            WhatsApp
          </a>
        </div>

        <div class="heroDeco d1"></div>
        <div class="heroDeco d2"></div>
        <div class="heroDeco d3"></div>
      </aside>

    </div>
  </div>

  <script>
    function togglePassword(){
      const el = document.getElementById('password');
      if(!el) return;
      el.type = (el.type === 'password') ? 'text' : 'password';
    }
  </script>


  <!-- APP -->
  <div id="appView" class="wrap hidden">
    <div class="topbar card">
      <div>
        <div class="brand">AgendaPro</div>
        <div class="muted" id="who" style="font-size:13px;margin-top:2px;">‚Äî</div>
      </div>
      <div class="topbarRight">
        <span class="pill" id="companyPill">Empresa: ‚Äî</span>

        <div class="topbarActions">
          <button class="iconBtn" id="btnSidebar" title="Abrir/fechar menu (Ctrl+M)" aria-label="Abrir/fechar menu">
            <span class="icon" aria-hidden="true">
              <svg viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
            </span>
          </button>

          <button class="iconBtn" id="btnFocus" title="Tela limpa (Ctrl+K)" aria-label="Tela limpa">
            <span class="icon" aria-hidden="true">
              <svg viewBox="0 0 24 24"><path d="M8 3H5a2 2 0 0 0-2 2v3M16 3h3a2 2 0 0 1 2 2v3M8 21H5a2 2 0 0 1-2-2v-3M16 21h3a2 2 0 0 0 2-2v-3"/></svg>
            </span>
          </button>

          <div class="dropdown">
            <button class="iconBtn" id="btnSettings" title="Configura√ß√µes de layout" aria-label="Configura√ß√µes">
              <span class="icon" aria-hidden="true">
                <svg viewBox="0 0 24 24"><path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Zm8.9-2.7-.9-.5.1-1.1.1-1.1-1-.6-1-.6-.8.7-.8.7-1-.4-1-.4-.2-1.1-.2-1.1h-2.3l-.2 1.1-.2 1.1-1 .4-1 .4-.8-.7-.8-.7-1 .6-1 .6.1 1.1.1 1.1-.9.5-.9.5v2.2l.9.5.9.5-.1 1.1-.1 1.1 1 .6 1 .6.8-.7.8-.7 1 .4 1 .4.2 1.1.2 1.1h2.3l.2-1.1.2-1.1 1-.4 1-.4.8.7.8.7 1-.6 1-.6-.1-1.1-.1-1.1.9-.5.9-.5v-2.2Z"/></svg>
              </span>
            </button>

            <div class="menuDropdown card soft" id="settingsMenu" role="menu" aria-label="Configura√ß√µes de layout">
              <button class="ddItem" id="btnPinTopbar" role="menuitem">Fixar barra do topo</button>
              <button class="ddItem" id="btnPinMenu" role="menuitem">Fixar menu lateral</button>
              <button class="ddItem" id="btnCollapseMenu" role="menuitem">Recolher/expandir menu</button>
              <div class="ddLine"></div>
              <button class="ddItem" id="btnOpenMenu" role="menuitem">Atalhos</button>
              <button class="ddItem" id="btnRefresh" role="menuitem">Atualizar</button>
              <button class="ddItem danger" id="btnLogout" role="menuitem">Sair</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="sidebarOverlay" id="sidebarOverlay" aria-hidden="true"></div>

    <div class="row">
      <aside class="sidebar" aria-label="Menu lateral">
  <div class="sideHeader">
    <div class="sideBrand" title="AgendaPro">
      <span class="sideMark" aria-hidden="true"></span>
      <div class="sideTexts">
        <div class="sideTitle">AgendaPro</div>
        <div class="sideSub">Navega√ß√£o</div>
      </div>
    </div>

    <button class="iconBtn small" id="btnCollapseMenu2" title="Recolher/expandir menu" aria-label="Recolher/expandir menu">
      <span class="icon" aria-hidden="true">
        <svg viewBox="0 0 24 24"><path d="M9 6l6 6-6 6"/></svg>
      </span>
    </button>
  </div>

  <div class="sideSearch">
    <span class="icon" aria-hidden="true">
      <svg viewBox="0 0 24 24"><path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Zm6.2-1.3 4 4"/></svg>
    </span>
    <input id="menuSearch" type="search" placeholder="Buscar no menu..." autocomplete="off" />
  </div>

  <nav class="menu" id="sideMenu">
    <button class="active" data-tab="dash" data-label="Dashboard">
      <span class="itemLeft">
        <span class="i" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M4 13h7V4H4v9Zm9 7h7V11h-7v9ZM4 20h7v-5H4v5Zm9-11h7V4h-7v5Z"/></svg></span>
        <span class="label">Dashboard</span>
      </span>
      <span class="tag" id="badgeToday">‚Äî</span>
    </button>

    <button data-tab="agenda" data-label="Agenda">
      <span class="itemLeft">
        <span class="i" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M7 3v2M17 3v2M4 8h16M6 6h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2Z"/></svg></span>
        <span class="label">Agenda</span>
      </span>
      <span class="tag" id="badgeAgenda">‚Äî</span>
    </button>

    <button data-tab="historico" data-label="Hist√≥rico">
      <span class="itemLeft">
        <span class="i" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M12 8v5l3 2M3 12a9 9 0 1 0 3-6.7M3 4v4h4"/></svg></span>
        <span class="label">Hist√≥rico</span>
      </span>
      <span class="tag" id="badgeHistorico">‚Äî</span>
    </button>

    <button data-tab="clientes" data-label="Clientes">
      <span class="itemLeft">
        <span class="i" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M16 11a4 4 0 1 0-8 0 4 4 0 0 0 8 0ZM4 20a8 8 0 0 1 16 0"/></svg></span>
        <span class="label">Clientes</span>
      </span>
      <span class="tag" id="badgeClientes">‚Äî</span>
    </button>

    <button data-tab="profissionais" data-label="Profissionais">
      <span class="itemLeft">
        <span class="i" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M6 3l12 12M7 14l-3 7 7-3 10-10a2 2 0 0 0-3-3L8 15Z"/></svg></span>
        <span class="label">Profissionais</span>
      </span>
      <span class="tag" id="badgePros">‚Äî</span>
    </button>

    <button data-tab="servicos" data-label="Servi√ßos">
      <span class="itemLeft">
        <span class="i" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M20 12v6a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-6M12 3v9M8 7l4-4 4 4"/></svg></span>
        <span class="label">Servi√ßos</span>
      </span>
      <span class="tag" id="badgeServ">‚Äî</span>
    </button>

    <button data-tab="horarios" data-label="Hor√°rios">
      <span class="itemLeft">
        <span class="i" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M12 7v5l3 2M21 12a9 9 0 1 0-9 9 9 9 0 0 0 9-9Z"/></svg></span>
        <span class="label">Hor√°rios</span>
      </span>
      <span class="tag" id="badgeHours">‚Äî</span>
    </button>

    <div class="menuSep"></div>

    <button data-tab="produtos" data-label="Produtos">
      <span class="itemLeft">
        <span class="i" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M21 8l-9-5-9 5v10l9 5 9-5V8Z"/></svg></span>
        <span class="label">Produtos</span>
      </span>
      <span class="tag" id="badgeProdutos">‚Äî</span>
    </button>

    <button data-tab="estoque" data-label="Estoque">
      <span class="itemLeft">
        <span class="i" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M4 6h16v6H4V6Zm0 8h10v4H4v-4Zm12 0h4v4h-4v-4Z"/></svg></span>
        <span class="label">Estoque</span>
      </span>
      <span class="tag" id="badgeEstoque">‚Äî</span>
    </button>

    <button data-tab="pdv" data-label="PDV">
      <span class="itemLeft">
        <span class="i" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M4 7h16v10H4V7Zm3 14h10"/></svg></span>
        <span class="label">PDV</span>
      </span>
      <span class="tag" id="badgePDV">‚Äî</span>
    </button>

    <button data-tab="vendas" data-label="Hist√≥rico de vendas">
      <span class="itemLeft">
        <span class="i" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M7 3h10v4H7V3Zm-2 6h14v12H5V9Zm4 3h6"/></svg></span>
        <span class="label">Vendas</span>
      </span>
      <span class="tag" id="badgeVendas">‚Äî</span>
    </button>
  </nav>

  <div style="margin-top:14px" class="muted">
          <div style="font-weight:900;color:var(--text)">A√ß√µes r√°pidas</div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
            <button class="btn2" id="quickNewCustomer">+ Cliente</button>
            <button class="btn2" id="quickNewPro">+ Profissional</button>
            <button class="btn2" id="quickNewService">+ Servi√ßo</button>
          </div>
        </div>

        <div style="margin-top:14px" class="muted">
          <div style="font-weight:900;color:var(--text)">Permiss√£o</div>
          <div id="roleBox" class="pill" style="margin-top:8px;display:inline-block">‚Äî</div>
        </div>
      </aside>

      <main class="content">
        <!-- DASH -->
        <section id="tab-dash" class="card section">
          <h2>Dashboard</h2>
          <p>Resumo do dia e pr√≥ximos agendamentos.</p>

          <div class="grid">
            <div class="card kpi"><h3>Hoje</h3><p class="big" id="kpiToday">‚Äî</p></div>
            <div class="card kpi"><h3>Confirmados</h3><p class="big" id="kpiConf">‚Äî</p></div>
            <div class="card kpi"><h3>Cancelados</h3><p class="big" id="kpiCanc">‚Äî</p></div>
            <div class="card kpi"><h3>Conclu√≠dos</h3><p class="big" id="kpiDone">‚Äî</p></div>
          </div>


          <div class="grid" style="margin-top:14px">
            <div class="card kpi"><h3>Atendimentos hoje</h3><p class="big" id="kpiApptToday">‚Äî</p></div>
            <div class="card kpi"><h3>Faturamento estimado hoje</h3><p class="big" id="kpiRevenueToday">‚Äî</p></div>
            <div class="card kpi"><h3>Profissional mais ocupado (semana)</h3><p class="big" id="kpiBusiestPro">‚Äî</p></div>
            <div class="card kpi"><h3>Hor√°rio mais usado (semana)</h3><p class="big" id="kpiBusiestHour">‚Äî</p></div>
          </div>

          <div style="margin-top:14px" class="card section">
            <div class="toolbar">
              <div class="left">
                <div style="font-weight:1000">Alertas</div>
                <span class="muted" style="font-size:13px">detec√ß√£o autom√°tica</span>
              </div>
              <div class="right">
                <span class="tag" id="alertBadge">‚Äî</span>
              </div>
            </div>

            <div id="alertsBox" class="muted" style="font-size:14px;line-height:1.6">
              <div>‚Äî</div>
            </div>
          </div>

          <div style="margin-top:14px" class="card section">
            <div class="toolbar">
              <div class="left">
                <div style="font-weight:1000">Pr√≥ximos agendamentos</div>
                <span class="muted" style="font-size:13px">at√© 20 itens</span>
              </div>
              <div class="right">
                <button class="btn2" id="btnGoAgenda">Abrir Agenda</button>
              </div>
            </div>

            <div style="overflow:auto">
              <table>
                <thead>
                  <tr><th>Data/Hora</th><th>Profissional</th><th>Servi√ßo</th><th>Cliente</th><th>Status</th></tr>
                </thead>
                <tbody id="tbodyNext"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- AGENDA -->
        <section id="tab-agenda" class="card section hidden">
          <h2>Agenda</h2>
          <p>Filtre por data e profissional, altere status e gerencie agendamentos.</p>

          <div class="toolbar">
            <div class="left">
              <input class="miniInput" id="agendaDate" type="date" />
              <select class="miniInput" id="agendaPro"></select>
              <input class="miniInput" id="agendaSearch" placeholder="Buscar cliente/telefone..." />
            </div>
            <div class="right">
              <button class="btn2" id="btnNewAppointment">+ Novo Agendamento</button>
              <button class="btn2" id="btnAgendaReload">Recarregar</button>
            </div>
          </div>

          <div style="overflow:auto">
            <table>
              <thead>
                <tr><th>Hora</th><th>Profissional</th><th>Servi√ßo</th><th>Cliente</th><th>Telefone</th><th>Status</th><th>A√ß√µes</th></tr>
              </thead>
              <tbody id="tbodyAgenda"></tbody>
            </table>
          </div>
        </section>

        <!-- HIST√ìRICO -->
        <section id="tab-historico" class="card section hidden">
          <h2>Hist√≥rico</h2>
          <p>Atendimentos finalizados (status: <strong>done</strong>). Filtre por datas e profissional. Voc√™ pode excluir por per√≠odo para manter leve.</p>

          <div class="toolbar">
            <div class="left">
              <input class="miniInput" id="histStart" type="date" />
              <input class="miniInput" id="histEnd" type="date" />
              <select class="miniInput" id="histPro"></select>
              <input class="miniInput" id="histSearch" placeholder="Buscar cliente/telefone..." />
            </div>
            <div class="right">
              <button class="btn2" id="btnHistToday">Hoje</button>
              <button class="btn2" id="btnHist7">7 dias</button>
              <button class="btn2" id="btnHist30">30 dias</button>
              <button class="btn2" id="btnHistReload">Recarregar</button>
              <button class="btn2 btnDanger" id="btnHistClear">Excluir por data</button>
            </div>
          </div>

          <div style="overflow:auto">
            <table>
              <thead>
                <tr><th>Data</th><th>Hora</th><th>Profissional</th><th>Servi√ßo</th><th>Cliente</th><th>Telefone</th><th>Status</th></tr>
              </thead>
              <tbody id="tbodyHistorico"></tbody>
            </table>
          </div>
        </section>

        <!-- CLIENTES -->
        <section id="tab-clientes" class="card section hidden">
          <h2>Clientes</h2>
          <p>Cadastre, edite e busque clientes.</p>

          <div class="toolbar">
            <div class="left">
              <input class="miniInput" id="searchCustomer" placeholder="Buscar por nome/telefone..." />
            </div>
            <div class="right">
              <button class="btn2" id="btnNewCustomer">+ Novo Cliente</button>
              <button class="btn2" id="btnCustomersReload">Recarregar</button>
            </div>
          </div>

          <div style="overflow:auto">
            <table>
              <thead>
                <tr><th>Nome</th><th>Telefone</th><th>E-mail</th><th>Documento</th><th>A√ß√µes</th></tr>
              </thead>
              <tbody id="tbodyCustomers"></tbody>
            </table>
          </div>
        </section>

        <!-- PROFISSIONAIS -->
        <section id="tab-profissionais" class="card section hidden">
          <h2>Profissionais</h2>
          <p>Gerencie equipe.</p>

          <div class="toolbar">
            <div class="left"></div>
            <div class="right">
              <button class="btn2" id="btnNewPro">+ Novo Profissional</button>
              <button class="btn2" id="btnProsReload">Recarregar</button>
            </div>
          </div>

          <div style="overflow:auto">
            <table>
              <thead>
                <tr><th>Nome</th><th>Status</th><th>A√ß√µes</th></tr>
              </thead>
              <tbody id="tbodyPros"></tbody>
            </table>
          </div>
        </section>

        <!-- SERVI√áOS -->
        <section id="tab-servicos" class="card section hidden">
          <h2>Servi√ßos</h2>
          <p>Cadastre servi√ßos com dura√ß√£o e pre√ßo.</p>

          <div class="toolbar">
            <div class="left"></div>
            <div class="right">
              <button class="btn2" id="btnNewService">+ Novo Servi√ßo</button>
              <button class="btn2" id="btnServReload">Recarregar</button>
            </div>
          </div>

          <div style="overflow:auto">
            <table>
              <thead>
                <tr><th>Servi√ßo</th><th>Dura√ß√£o</th><th>Pre√ßo</th><th>Status</th><th>A√ß√µes</th></tr>
              </thead>
              <tbody id="tbodyServ"></tbody>
            </table>
          </div>
        </section>

        <!-- HOR√ÅRIOS -->
        <section id="tab-horarios" class="card section hidden">
          <h2>Hor√°rios</h2>
          <p>Defina dias e hor√°rios dispon√≠veis por profissional.</p>

          <div class="toolbar">
            <div class="left" style="gap:10px; flex-wrap:wrap">
              <select class="miniInput" id="whPro"></select>

              <select id="whMode" class="miniInput" title="Modo de lan√ßamento">
                <option value="weekday">Recorrente (dia da semana)</option>
                <option value="date">Por data (ex.: hoje/amanh√£)</option>
              </select>

              <select id="whWeekday" class="miniInput" title="Dia da semana">
                <option value="0">Domingo</option>
                <option value="1">Segunda</option>
                <option value="2">Ter√ßa</option>
                <option value="3">Quarta</option>
                <option value="4">Quinta</option>
                <option value="5">Sexta</option>
                <option value="6">S√°bado</option>
              </select>

              <input id="whDate" class="miniInput" type="date" title="Data (modo por data)" style="display:none" />
              <input id="whDateEnd" class="miniInput" type="date" title="Data fim (opcional)" style="display:none" />

              <input id="whStart" class="miniInput" type="time" value="09:00" />
              <input id="whEnd" class="miniInput" type="time" value="18:00" />
              <input id="whSlot" class="miniInput" type="number" min="5" max="180" value="5" title="Passo (min)" />
            </div>
            <div class="right" style="flex-wrap:wrap; gap:10px">
              <button class="btn2" id="btnWhAdd">Salvar Hor√°rio</button>
              <button class="btn2" id="btnWhTodayTomorrow">Hoje + Amanh√£</button>
              <button class="btn2" id="btnWhList">Listar do Profissional</button>
              <button class="btn2" id="btnWhDefault">Aplicar Seg‚ÄìSex 09:00‚Äì18:00</button>
              <button class="btn2" id="btnWhReload">Recarregar</button>
            </div>
          </div>

          <div style="overflow:auto">
            <table>
              <thead>
                <tr><th>Profissional</th><th>Dia/Data</th><th>In√≠cio</th><th>Fim</th><th>Passo</th><th>Tipo</th><th>A√ß√µes</th></tr>
              </thead>
              <tbody id="tbodyHours"></tbody>
            </table>
          </div>
        </section>


        <!-- PRODUTOS -->
        <section id="tab-produtos" class="card section hidden">
          <h2>Produtos</h2>
          <p>Cadastre produtos (bebidas, itens, etc.) com pre√ßo e c√≥digo de barras.</p>

          <div class="toolbar">
            <div class="left">
              <input class="miniInput" id="prodSearch" placeholder="Buscar por nome/c√≥digo..." />
            </div>
            <div class="right">
              <button class="btn2" id="btnNewProduct">+ Novo Produto</button>
              <button class="btn2" id="btnProdReload">Recarregar</button>
            </div>
          </div>

          <div style="overflow:auto">
            <table>
              <thead>
                <tr><th>Produto</th><th>C√≥digo</th><th>Pre√ßo</th><th>Status</th><th>A√ß√µes</th></tr>
              </thead>
              <tbody id="tbodyProducts"></tbody>
            </table>
          </div>
        </section>

        <!-- ESTOQUE -->
        <section id="tab-estoque" class="card section hidden">
          <h2>Estoque</h2>
          <p>Saldo por produto (entrada/sa√≠da/ajuste).</p>

          <div class="toolbar">
            <div class="left">
              <input class="miniInput" id="stockSearch" placeholder="Buscar produto..." />
            </div>
            <div class="right">
              <button class="btn2" id="btnStockIn">+ Entrada</button>
              <button class="btn2" id="btnStockOut">- Sa√≠da</button>
              <button class="btn2" id="btnStockReload">Recarregar</button>
            </div>
          </div>

          <div style="overflow:auto">
            <table>
              <thead>
                <tr><th>Produto</th><th>Saldo</th><th>M√≠nimo</th><th>Status</th><th>A√ß√µes</th></tr>
              </thead>
              <tbody id="tbodyStock"></tbody>
            </table>
          </div>
        </section>

        <!-- PDV -->
        <section id="tab-pdv" class="card section hidden">
          <h2>PDV</h2>
          <p>Pesquisa de produto, carrinho e total. Voc√™ pode vincular a venda a um agendamento do dia.</p>

          <div class="toolbar">
            <div class="left" style="gap:10px">
              <input class="miniInput" id="pdvSearch" placeholder="Buscar produto..." />
              <select class="miniInput" id="pdvApptLink">
                <option value="">Vincular a agendamento (opcional)</option>
              </select>
            </div>
            <div class="right">
              <button class="btn2" id="btnPdvClear">Limpar</button>
              <button class="btn2" id="btnPdvReload">Recarregar</button>
            </div>
          </div>

          <div class="row" style="margin-top:0">
            <div class="card section" style="flex:1;min-width:320px">
              <div style="font-weight:1000;margin-bottom:10px">Produtos</div>
              <div style="overflow:auto;max-height:520px">
                <table>
                  <thead>
                    <tr><th>Produto</th><th>Pre√ßo</th><th>Estoque</th><th>A√ß√£o</th></tr>
                  </thead>
                  <tbody id="tbodyPdvProducts"></tbody>
                </table>
              </div>
            </div>

            <div class="card section" style="flex:1;min-width:320px">
              <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
                <div style="font-weight:1000">Carrinho</div>
                <div class="pill" id="pdvTotal">Total: ‚Äî</div>
              </div>

              <div style="overflow:auto;max-height:420px;margin-top:10px">
                <table>
                  <thead>
                    <tr><th>Item</th><th>Qtd</th><th>Unit</th><th>Total</th><th></th></tr>
                  </thead>
                  <tbody id="tbodyPdvCart"></tbody>
                </table>
              </div>

              <div class="toolbar" style="margin-top:12px">
                <div class="left" style="gap:10px">
                  <select class="miniInput" id="pdvPay">
                    <option value="dinheiro">Dinheiro</option>
                    <option value="pix">Pix</option>
                    <option value="credito">Cart√£o (Cr√©dito)</option>
                    <option value="debito">Cart√£o (D√©bito)</option>
                    <option value="outros">Outros</option>
                  </select>
                  <input class="miniInput" id="pdvDiscount" type="number" step="0.01" placeholder="Desconto (R$)" style="min-width:160px" />
                </div>
                <div class="right">
                  <button class="btn" id="btnPdvFinalize">Finalizar</button>
                </div>
              </div>

              <div class="muted" id="pdvMsg" style="font-size:13px;margin-top:8px">‚Äî</div>
            </div>
          </div>
        </section>


        <section id="tab-vendas" class="card section hidden">
          <div class="row" style="justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
            <div>
              <div class="h2">Hist√≥rico de vendas</div>
              <div class="muted">Registros no Supabase. Acesso protegido por senha (2526) no painel.</div>
            </div>
            <div class="row" style="gap:10px;flex-wrap:wrap">
              <button class="btn" id="btnVendasReload">Recarregar</button>
            </div>
          </div>

          <div class="card" style="margin-top:14px">
            <div class="row" style="gap:12px;flex-wrap:wrap;align-items:end">
              <div class="field" style="min-width:180px">
                <label>Data in√≠cio</label>
                <input type="date" id="salesStart" />
              </div>
              <div class="field" style="min-width:180px">
                <label>Data fim</label>
                <input type="date" id="salesEnd" />
              </div>
              <div class="field" style="min-width:220px">
                <label>Forma de pagamento</label>
                <select id="salesPayFilter">
                  <option value="">Todas</option>
                  <option value="dinheiro">Dinheiro</option>
                  <option value="pix">Pix</option>
                  <option value="cartao">Cart√£o</option>
                  <option value="debito">D√©bito</option>
                  <option value="credito">Cr√©dito</option>
                  <option value="outros">Outros</option>
                </select>
              </div>
              <button class="btn primary" id="btnSalesApply">Aplicar filtro</button>
              <button class="btn" id="btnSalesClear">Limpar</button>
            </div>

            <div class="row" style="gap:12px;flex-wrap:wrap;margin-top:14px">
              <div class="kpi">
                <div class="muted">Total vendido</div>
                <div class="big" id="kpiSalesTotal">‚Äî</div>
              </div>
              <div class="kpi">
                <div class="muted">Quantidade de vendas</div>
                <div class="big" id="kpiSalesCount">‚Äî</div>
              </div>
              <div class="kpi">
                <div class="muted">Ticket m√©dio</div>
                <div class="big" id="kpiSalesAvg">‚Äî</div>
              </div>
            </div>
          </div>

          <div class="card" style="margin-top:14px">
            <div class="tableWrap">
              <table class="table">
                <thead>
                  <tr>
                    <th>Data/Hora</th>
                    <th>Pagamento</th>
                    <th>Subtotal</th>
                    <th>Desconto</th>
                    <th>Total</th>
                    <th>Agendamento</th>
                  </tr>
                </thead>
                <tbody id="tbodySales">
                  <tr><td colspan="6" class="muted">Carregue as vendas para visualizar o hist√≥rico.</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>


      </main>
    </div>
  </div>

  <!-- MODAL -->
  <div id="modalBack" class="modalBack">
    <div class="card modal">
      <div class="modalHeader">
        <h3 id="modalTitle">‚Äî</h3>
        <button class="btn2" id="modalClose">Fechar</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
      <div class="modalFooter" id="modalFooter"></div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SB_URL = "https://nsmvnfhdohpvmtoimsub.supabase.co";
    const SB_KEY = "sb_publishable_tn76OaKxjctgngA6jj9NSw_KXfWqt-f";
    const sb = window.supabase.createClient(SB_URL, SB_KEY);

    // UI refs
    const loginView = document.getElementById("loginView");
    const appView = document.getElementById("appView");
    const btnLogin = document.getElementById("btnLogin");
    const btnLogout = document.getElementById("btnLogout");
    const btnRefresh = document.getElementById("btnRefresh");
    const err = document.getElementById("err");

    const who = document.getElementById("who");
    const companyPill = document.getElementById("companyPill");
    const roleBox = document.getElementById("roleBox");

    const kpiToday = document.getElementById("kpiToday");
    const kpiConf  = document.getElementById("kpiConf");
    const kpiCanc  = document.getElementById("kpiCanc");
    const kpiDone  = document.getElementById("kpiDone");

    const kpiApptToday = document.getElementById("kpiApptToday");
    const kpiRevenueToday = document.getElementById("kpiRevenueToday");
    const kpiBusiestPro = document.getElementById("kpiBusiestPro");
    const kpiBusiestHour = document.getElementById("kpiBusiestHour");

    const alertsBox = document.getElementById("alertsBox");
    const alertBadge = document.getElementById("alertBadge");


    const badgeToday = document.getElementById("badgeToday");
    const badgeAgenda = document.getElementById("badgeAgenda");
    const badgeHistorico = document.getElementById("badgeHistorico");
const badgeClientes = document.getElementById("badgeClientes");
    const badgePros = document.getElementById("badgePros");
    const badgeServ = document.getElementById("badgeServ");
    const badgeHours = document.getElementById("badgeHours");
    const badgeProdutos = document.getElementById("badgeProdutos");
    const badgeEstoque = document.getElementById("badgeEstoque");
    const badgePDV = document.getElementById("badgePDV");
    const badgeVendas = document.getElementById("badgeVendas");

    const tbodyNext = document.getElementById("tbodyNext");
    const tbodyAgenda = document.getElementById("tbodyAgenda");
    // HIST√ìRICO
    const histStart = document.getElementById("histStart");
    const histEnd = document.getElementById("histEnd");
    const histPro = document.getElementById("histPro");
    const histSearch = document.getElementById("histSearch");

    // VENDAS (Hist√≥rico)
    const btnVendasReload = document.getElementById("btnVendasReload");
    const salesStart = document.getElementById("salesStart");
    const salesEnd = document.getElementById("salesEnd");
    const salesPayFilter = document.getElementById("salesPayFilter");
    const btnSalesApply = document.getElementById("btnSalesApply");
    const btnSalesClear = document.getElementById("btnSalesClear");
    const tbodySales = document.getElementById("tbodySales");
    const kpiSalesTotal = document.getElementById("kpiSalesTotal");
    const kpiSalesCount = document.getElementById("kpiSalesCount");
    const kpiSalesAvg = document.getElementById("kpiSalesAvg");
    const btnHistToday = document.getElementById("btnHistToday");
    const btnHist7 = document.getElementById("btnHist7");
    const btnHist30 = document.getElementById("btnHist30");
    const btnHistReload = document.getElementById("btnHistReload");
    const btnHistClear = document.getElementById("btnHistClear");
    const tbodyHistorico = document.getElementById("tbodyHistorico");

    const agendaDate = document.getElementById("agendaDate");
    const agendaPro = document.getElementById("agendaPro");

    const tbodyCustomers = document.getElementById("tbodyCustomers");
    const searchCustomer = document.getElementById("searchCustomer");

    const tbodyPros = document.getElementById("tbodyPros");
    const tbodyServ = document.getElementById("tbodyServ");

    const btnGoAgenda = document.getElementById("btnGoAgenda");
    const btnAgendaReload = document.getElementById("btnAgendaReload");
    const btnNewAppointment = document.getElementById("btnNewAppointment");

    const btnNewCustomer = document.getElementById("btnNewCustomer");
    const btnCustomersReload = document.getElementById("btnCustomersReload");

    const btnNewPro = document.getElementById("btnNewPro");
    const btnProsReload = document.getElementById("btnProsReload");

    const btnNewService = document.getElementById("btnNewService");
    const btnServReload = document.getElementById("btnServReload");

    const quickNewCustomer = document.getElementById("quickNewCustomer");
    const quickNewPro = document.getElementById("quickNewPro");
    const quickNewService = document.getElementById("quickNewService");

    // Working Hours refs
    const whPro = document.getElementById("whPro");
    const whMode = document.getElementById("whMode");
    const whWeekday = document.getElementById("whWeekday");
    const whDate = document.getElementById("whDate");
    const whDateEnd = document.getElementById("whDateEnd");
    const whStart = document.getElementById("whStart");
    const whEnd = document.getElementById("whEnd");
    const whSlot = document.getElementById("whSlot");
    const btnWhAdd = document.getElementById("btnWhAdd");
    const btnWhTodayTomorrow = document.getElementById("btnWhTodayTomorrow");
    const btnWhList = document.getElementById("btnWhList");
    const btnWhDefault = document.getElementById("btnWhDefault");
    const btnWhReload = document.getElementById("btnWhReload");
    const tbodyHours = document.getElementById("tbodyHours");

    // Modal (Listar hor√°rios do profissional)
    const modalHoursList = document.getElementById("modalHoursList");
    const btnCloseHoursList = document.getElementById("btnCloseHoursList");
    const hoursListTitle = document.getElementById("hoursListTitle");
    const tbodyHoursList = document.getElementById("tbodyHoursList");

    // Produtos / Estoque / PDV (modo local)
    // Produtos / Estoque / PDV (modo local) (modo local)
    const prodSearch = document.getElementById("prodSearch");
    const btnNewProduct = document.getElementById("btnNewProduct");
    const btnProdReload = document.getElementById("btnProdReload");
    const tbodyProducts = document.getElementById("tbodyProducts");

    const stockSearch = document.getElementById("stockSearch");
    const btnStockIn = document.getElementById("btnStockIn");
    const btnStockOut = document.getElementById("btnStockOut");
    const btnStockReload = document.getElementById("btnStockReload");
    const tbodyStock = document.getElementById("tbodyStock");

    const pdvSearch = document.getElementById("pdvSearch");
    const pdvApptLink = document.getElementById("pdvApptLink");
    const btnPdvClear = document.getElementById("btnPdvClear");
    const btnPdvReload = document.getElementById("btnPdvReload");
    const tbodyPdvProducts = document.getElementById("tbodyPdvProducts");
    const tbodyPdvCart = document.getElementById("tbodyPdvCart");
    const pdvTotal = document.getElementById("pdvTotal");
    const pdvPay = document.getElementById("pdvPay");
    const pdvDiscount = document.getElementById("pdvDiscount");
    const btnPdvFinalize = document.getElementById("btnPdvFinalize");
    const pdvMsg = document.getElementById("pdvMsg");


    // Modal
    const modalBack = document.getElementById("modalBack");
    const modalTitle = document.getElementById("modalTitle");
    const modalBody = document.getElementById("modalBody");
    const modalFooter = document.getElementById("modalFooter");
    const modalClose = document.getElementById("modalClose");

    // Toast
    const toast = document.getElementById("toast");
    // Menu (modal)
    // Layout controls
    const btnSidebar = document.getElementById("btnSidebar");
    const btnPinTopbar = document.getElementById("btnPinTopbar");
    const btnPinMenu = document.getElementById("btnPinMenu");
    const btnFocus = document.getElementById("btnFocus");
    const btnCollapseMenu = document.getElementById("btnCollapseMenu");
    const btnCollapseMenu2 = document.getElementById("btnCollapseMenu2");

    const btnSettings = document.getElementById("btnSettings");
    const settingsMenu = document.getElementById("settingsMenu");
    const sidebarOverlay = document.getElementById("sidebarOverlay");

    const btnOpenMenu = document.getElementById("btnOpenMenu");
    const menuSearch = document.getElementById("menuSearch");

    // Agenda search
    const agendaSearch = document.getElementById("agendaSearch");

    // Helpers: WhatsApp link and phone normalization (BR default)
    function normalizePhoneToE164(phone){
      const raw = String(phone||"").trim();
      if(!raw) return null;
      const digits = raw.replace(/\D/g,"");
      if(!digits) return null;

      // If starts with 55 already (Brazil), keep; else assume BR when length <= 11
      if(digits.startsWith("55")) return digits;
      if(digits.length <= 11) return "55" + digits;
      return digits; // fallback
    }

    function waLink(phone, text){
      const e164 = normalizePhoneToE164(phone);
      if(!e164) return null;
      const base = "https://wa.me/" + e164;
      if(!text) return base;
      return base + "?text=" + encodeURIComponent(text);
    }

    function renderWhatsAppBtn(phone, name, small=false){
      const url = waLink(phone, name ? `Ol√° ${name}!` : "Ol√°!");
      if(!url) return "";
      const cls = "waBtn" + (small ? " small" : "");
      return `<a class="${cls}" href="${url}" target="_blank" rel="noopener">WhatsApp</a>`;
    }

    // Open Menu modal (clean navigation / more visibility)
    function openMenuModal(){
      const body = `
        <div class="menuGrid">
          <button class="menuTile" onclick="selectTab('dash', true)">
            <div class="t">Dashboard</div><div class="d">Resumo do dia e pr√≥ximos</div>
          </button>
          <button class="menuTile" onclick="selectTab('agenda', true)">
            <div class="t">Agenda</div><div class="d">Gerenciar agendamentos</div>
          </button>
          <button class="menuTile" onclick="selectTab('clientes', true)">
            <div class="t">Clientes</div><div class="d">Cadastro, busca e hist√≥rico</div>
          </button>
          <button class="menuTile" onclick="selectTab('profissionais', true)">
            <div class="t">Profissionais</div><div class="d">Equipe e disponibilidade</div>
          </button>
          <button class="menuTile" onclick="selectTab('servicos', true)">
            <div class="t">Servi√ßos</div><div class="d">Pre√ßo e dura√ß√£o</div>
          </button>
          <button class="menuTile" onclick="selectTab('horarios', true)">
            <div class="t">Hor√°rios</div><div class="d">Regras de agenda por profissional</div>
          </button>
        </div>
      `;
      openModal("Menu", body, `<button class="btn" onclick="window.__closeModal()">Fechar</button>`);
    }

    window.selectTab = (tab, close=true)=>{
      if(tab==="vendas" && !state.salesUnlocked){
        openSalesGate();
        return;
      }
      document.querySelectorAll(".menu button").forEach(b=>b.classList.remove("active"));
      const btn = document.querySelector(`.menu button[data-tab="${tab}"]`);
      if(btn) btn.classList.add("active");
      document.querySelectorAll("main section").forEach(sec=>sec.classList.add("hidden"));
      const sec = document.getElementById("tab-" + tab);
      if(sec) sec.classList.remove("hidden");

      if(tab==="agenda") loadAgenda();
      if(tab==="historico") loadHistory();
      if(tab==="clientes") loadCustomers();
      if(tab==="profissionais") loadProfessionals();
      if(tab==="servicos") loadServices();
      if(tab==="horarios") loadWorkingHours();
      if(tab==="produtos") loadLocalProducts();
      if(tab==="estoque") loadLocalStock();
      if(tab==="pdv") loadPDV();
      if(tab==="vendas") loadSalesHistory();

      if(close) closeModal();
    };


    function openSalesGate(){
      const body = `
        <div class="muted" style="margin-bottom:10px">Digite a senha do propriet√°rio para acessar o Hist√≥rico de Vendas.</div>
        <div class="field">
          <label>Senha</label>
          <input id="salesPassInput" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off" />
        </div>
      `;
      const footer = `
        <button class="btn" onclick="window.__closeModal()">Cancelar</button>
        <button class="btn primary" id="btnSalesPassOk">Entrar</button>
      `;
      openModal("Acesso restrito", body, footer);
      setTimeout(()=>{
        const inp = document.getElementById("salesPassInput");
        const ok = document.getElementById("btnSalesPassOk");
        inp?.focus();
        const submit = ()=>{
          const v = String(inp?.value||"").trim();
          if(v === "2526"){
            state.salesUnlocked = true;
            toastMsg("ok","Acesso liberado.");
            window.__closeModal();
            selectTab("vendas", false);
          }else{
            toastMsg("err","Senha incorreta.");
          }
        };
        ok?.addEventListener("click", submit);
        inp?.addEventListener("keydown", (e)=>{ if(e.key==="Enter") submit(); });
      }, 50);
    }

    function setSalesDefaultDates(){
      if(!salesStart || !salesEnd) return;
      const t = todayISO();
      salesStart.value = t;
      salesEnd.value = t;
    }

    async function loadSalesHistory(){
      if(!tbodySales) return;

      // defaults
      if(!salesStart?.value || !salesEnd?.value) setSalesDefaultDates();

      const companyId = state?.profile?.company_id;
      if(!companyId){
        tbodySales.innerHTML = `<tr><td colspan="6" class="muted">Sess√£o inv√°lida.</td></tr>`;
        return;
      }

      tbodySales.innerHTML = `<tr><td colspan="6" class="muted">Carregando‚Ä¶</td></tr>`;

      try{
        const s = salesStart?.value || "";
        const e = salesEnd?.value || "";
        const pay = salesPayFilter?.value || "";

        let q = sb.from("sales")
          .select("id, created_at, payment_method, subtotal_cents, discount_cents, total_cents, appointment_id")
          .eq("company_id", companyId)
          .order("created_at", { ascending:false });

        if(s){
          const r = dayRangeUTC(s);
          q = q.gte("created_at", r.start);
        }
        if(e){
          const r = dayRangeUTC(e);
          q = q.lt("created_at", r.end);
        }
        if(pay) q = q.eq("payment_method", pay);

        const { data, error } = await q;
        if(error){
          console.warn(error);
          tbodySales.innerHTML = `<tr><td colspan="6" class="muted">N√£o foi poss√≠vel carregar vendas (verifique tabela/pol√≠ticas).</td></tr>`;
          kpiSalesTotal.textContent = "‚Äî";
          kpiSalesCount.textContent = "‚Äî";
          kpiSalesAvg.textContent = "‚Äî";
          return;
        }

        const rows = data || [];
        const sum = rows.reduce((a,x)=>a + Number(x.total_cents||0), 0);
        const cnt = rows.length;
        const avg = cnt ? Math.round(sum/cnt) : 0;

        if(kpiSalesTotal) kpiSalesTotal.textContent = fmtMoney(sum);
        if(kpiSalesCount) kpiSalesCount.textContent = String(cnt);
        if(kpiSalesAvg) kpiSalesAvg.textContent = fmtMoney(avg);

        if(badgeVendas) badgeVendas.textContent = String(cnt);

        if(!cnt){
          tbodySales.innerHTML = `<tr><td colspan="6" class="muted">Nenhuma venda no per√≠odo.</td></tr>`;
          return;
        }

        tbodySales.innerHTML = rows.map(r=>{
          const dt = new Date(r.created_at);
          const when = isNaN(dt) ? (r.created_at||"") : dt.toLocaleString();
          const payLbl = (r.payment_method||"").toUpperCase();
          return `
            <tr>
              <td>${esc(when)}</td>
              <td>${esc(payLbl || "‚Äî")}</td>
              <td>${fmtMoney(r.subtotal_cents||0)}</td>
              <td>${fmtMoney(r.discount_cents||0)}</td>
              <td style="font-weight:900">${fmtMoney(r.total_cents||0)}</td>
              <td>${r.appointment_id ? `<span class="tag">Vinculado</span>` : `<span class="muted">‚Äî</span>`}</td>
            </tr>
          `;
        }).join("");
      }catch(e){
        console.warn(e);
        tbodySales.innerHTML = `<tr><td colspan="6" class="muted">Erro ao carregar vendas.</td></tr>`;
      }
    }

    btnVendasReload?.addEventListener("click", loadSalesHistory);
    btnSalesApply?.addEventListener("click", loadSalesHistory);
    btnSalesClear?.addEventListener("click", ()=>{
      if(salesStart) salesStart.value = "";
      if(salesEnd) salesEnd.value = "";
      if(salesPayFilter) salesPayFilter.value = "";
      setSalesDefaultDates();
      loadSalesHistory();
    });

    btnOpenMenu?.addEventListener("click", openMenuModal);
    // Persist√™ncia de layout (premium)
    function setBtnOn(el, on){
      if(!el) return;
      el.classList.toggle("on", !!on);
    }

    function applyLayoutFromStorage(){
      const topbarPinned = localStorage.getItem("agp_topbarPinned")==="1";
      const menuPinned = localStorage.getItem("agp_menuPinned")==="1";
      const focus = localStorage.getItem("agp_focus")==="1";
      const menuCollapsed = localStorage.getItem("agp_menuCollapsed")==="1";

      document.body.classList.toggle("topbarPinned", topbarPinned);
      document.body.classList.toggle("menuPinned", menuPinned);
      document.body.classList.toggle("appFocus", focus);
      document.body.classList.toggle("menuCollapsed", menuCollapsed);

      setBtnOn(btnPinTopbar, topbarPinned);
      setBtnOn(btnPinMenu, menuPinned);
      setBtnOn(btnFocus, focus);
      setBtnOn(btnCollapseMenu, menuCollapsed);
      setBtnOn(btnCollapseMenu2, menuCollapsed);

      if(btnPinTopbar) btnPinTopbar.textContent = topbarPinned ? "Barra do topo: fixa" : "Barra do topo: normal";
      if(btnPinMenu) btnPinMenu.textContent = menuPinned ? "Menu lateral: fixo" : "Menu lateral: normal";
      if(btnCollapseMenu) btnCollapseMenu.textContent = menuCollapsed ? "Menu: expandir" : "Menu: recolher";
      if(btnCollapseMenu2) btnCollapseMenu2.setAttribute("aria-pressed", String(!!menuCollapsed));
      if(btnFocus) btnFocus.setAttribute("aria-pressed", String(!!focus));
    }

    function toggleClassPersist(cls, key){
      const on = !document.body.classList.contains(cls);
      document.body.classList.toggle(cls, on);
      localStorage.setItem(key, on ? "1" : "0");
      applyLayoutFromStorage();
    }

    btnPinTopbar?.addEventListener("click", ()=> toggleClassPersist("topbarPinned", "agp_topbarPinned"));
    btnPinMenu?.addEventListener("click", ()=> toggleClassPersist("menuPinned", "agp_menuPinned"));
    btnFocus?.addEventListener("click", ()=> toggleClassPersist("appFocus", "agp_focus"));

    function toggleMenuCollapsed(){
      const on = !document.body.classList.contains("menuCollapsed");
      document.body.classList.toggle("menuCollapsed", on);
      localStorage.setItem("agp_menuCollapsed", on ? "1" : "0");
      applyLayoutFromStorage();
    }
    btnCollapseMenu?.addEventListener("click", toggleMenuCollapsed);
    btnCollapseMenu2?.addEventListener("click", toggleMenuCollapsed);

    // Sidebar toggle: desktop = collapse; mobile = drawer
    function toggleSidebar(){
      const isMobile = window.matchMedia("(max-width:760px)").matches;
      if(isMobile){
        document.body.classList.toggle("sidebarOpen");
      }else{
        toggleMenuCollapsed();
      }
    }
    btnSidebar?.addEventListener("click", toggleSidebar);
    sidebarOverlay?.addEventListener("click", ()=> document.body.classList.remove("sidebarOpen"));

    // Settings dropdown
    function closeSettings(){
      document.querySelector(".dropdown")?.classList.remove("open");
    }
    btnSettings?.addEventListener("click", (e)=>{
      e.stopPropagation();
      document.querySelector(".dropdown")?.classList.toggle("open");
    });
    document.addEventListener("click", ()=> closeSettings());
    settingsMenu?.addEventListener("click", (e)=> e.stopPropagation());

    // Close drawer on resize
    window.addEventListener("resize", ()=>{
      if(!window.matchMedia("(max-width:760px)").matches){
        document.body.classList.remove("sidebarOpen");
      }
    });
// Atalhos de teclado
    window.addEventListener("keydown", (e)=>{
      if(e.ctrlKey && e.key.toLowerCase()==="k"){ e.preventDefault(); toggleClassPersist("appFocus","agp_focus"); }
      if(e.ctrlKey && !e.shiftKey && e.key.toLowerCase()==="m"){ e.preventDefault(); toggleSidebar(); }
      if(e.ctrlKey && e.shiftKey && e.key.toLowerCase()==="m"){ e.preventDefault(); toggleClassPersist("menuPinned","agp_menuPinned"); }
      if(e.ctrlKey && e.key.toLowerCase()==="b"){ e.preventDefault(); toggleClassPersist("topbarPinned","agp_topbarPinned"); }
    });

    applyLayoutFromStorage();


// Menu search (filtra itens do menu lateral)
menuSearch?.addEventListener("input", ()=>{
  const q = (menuSearch.value||"").trim().toLowerCase();
  const items = document.querySelectorAll("#sideMenu > button[data-tab]");
  items.forEach(btn=>{
    const label = (btn.getAttribute("data-label") || "").toLowerCase();
    btn.style.display = (!q || label.includes(q)) ? "" : "none";
  });
  // mant√©m separadores vis√≠veis somente quando faz sentido
  document.querySelectorAll("#sideMenu .menuSep").forEach(sep=>{
    const hasVisible = [...items].some(b=> b.style.display !== "none");
    sep.style.display = hasVisible ? "" : "none";
  });
});

    // Debounce agenda search
    let agendaSearchTimer = null;
    agendaSearch?.addEventListener("input", ()=>{
      clearTimeout(agendaSearchTimer);
      agendaSearchTimer = setTimeout(loadAgenda, 250);
    });

    // Customer history (simple / premium)
    window.openCustomerHistory = async (encoded)=>{
      let c = encoded ? JSON.parse(decodeURIComponent(encoded)) : null;
      if(!c) return toastMsg("err","Cliente inv√°lido.");
      await openHistoryByCustomer(c.full_name, c.phone);
    };

    window.openCustomerHistoryFromAgenda = async (name, phone)=>{
      await openHistoryByCustomer(name, phone);
    };

    async function openHistoryByCustomer(name, phone){
      const companyId = state?.profile?.company_id;
      if(!companyId) return toastMsg("err","Sess√£o inv√°lida.");

      const phoneNorm = (phone||"").trim();
      const nameNorm = (name||"").trim();

      // Prefer phone match when available
      let q = sb.from("appointments")
        .select("id, starts_at, status, customer_name, customer_phone, professional_id, service_id")
        .eq("company_id", companyId)
        .order("starts_at",{ascending:false})
        .limit(10);

      if(phoneNorm){
        q = q.eq("customer_phone", phoneNorm);
      } else if(nameNorm){
        q = q.ilike("customer_name", "%" + nameNorm + "%");
      }

      const { data, error } = await q;
      if(error) return toastMsg("err","Erro ao carregar hist√≥rico.");

      const rows = (data||[]).map(a=>`
        <tr>
          <td>${fmtDateTime(a.starts_at)}</td>
          <td>${state.prosMap[a.professional_id] || "‚Äî"}</td>
          <td>${state.servMap[a.service_id] || "‚Äî"}</td>
          <td>${tagStatus(a.status)}</td>
        </tr>
      `).join("");

      const wa = phoneNorm ? `
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 2px 0">
          <a class="waBtn" target="_blank" rel="noopener" href="${waLink(phoneNorm, `Ol√° ${nameNorm||""}! Estou confirmando seu agendamento.`) || "#"}">Confirmar</a>
          <a class="waBtn" target="_blank" rel="noopener" href="${waLink(phoneNorm, `Ol√° ${nameNorm||""}! Podemos remarcar seu hor√°rio?`) || "#"}">Remarcar</a>
          <a class="waBtn" target="_blank" rel="noopener" href="${waLink(phoneNorm, `Ol√° ${nameNorm||""}! Obrigado pelo atendimento.`) || "#"}">P√≥s</a>
        </div>
      ` : `<div class="muted" style="font-size:13px;margin-top:10px">Sem telefone para WhatsApp.</div>`;

      openModal(
        "Hist√≥rico do Cliente",
        `
          <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap">
            <div>
              <div style="font-weight:1000;font-size:16px;color:var(--text)">${esc(nameNorm) || "Cliente"}</div>
              <div class="muted" style="font-size:13px;margin-top:4px">Telefone: ${esc(phoneNorm)||"‚Äî"}</div>
            </div>
            ${phoneNorm ? renderWhatsAppBtn(phoneNorm, nameNorm) : ""}
          </div>

          ${wa}

          <div style="margin-top:12px; overflow:auto">
            <table>
              <thead>
                <tr><th>Data/Hora</th><th>Profissional</th><th>Servi√ßo</th><th>Status</th></tr>
              </thead>
              <tbody>
                ${rows || `<tr><td colspan="4">Nenhum hist√≥rico encontrado.</td></tr>`}
              </tbody>
            </table>
          </div>
        `,
        `<button class="btn" onclick="window.__closeModal()">Fechar</button>`
      );
    }


    let state = {
      user: null,
      profile: null,
      company: null,
      role: "staff",
      isAdmin: false,
      pros: [],
      serv: [],
      prosMap: {},
      servMap: {},
      servPriceMap: {},
      local: {
        products: [],
        stock: {},
        movements: [],
        carts: { pdv: [] },
        apptItems: {}
      },
      salesUnlocked: false
    };

    const pad2 = (n)=>String(n).padStart(2,"0");
    const todayISO = ()=> {
      const d = new Date();
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    };

    // Converte um dia (YYYY-MM-DD) em intervalo UTC equivalente ao dia LOCAL
    // Ex.: 2026-01-09 (local) -> start/end em ISO UTC para filtrar timestamptz corretamente
    function dayRangeUTC(dateStr){
      const startLocal = new Date(dateStr + "T00:00:00");
      const endLocal = new Date(dateStr + "T00:00:00");
      endLocal.setDate(endLocal.getDate() + 1);
      return { start: startLocal.toISOString(), end: endLocal.toISOString() };
    }
    const fmtTime = (iso)=> new Date(iso).toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});
    const fmtDateTime = (iso)=> new Date(iso).toLocaleString("pt-BR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"});
    const fmtDate = (iso)=> new Date(iso).toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit",year:"numeric"});

    function debounce(fn, wait = 300){
      let t;
      return (...args)=>{
        clearTimeout(t);
        t=setTimeout(()=>fn(...args), wait);
      };
    }

    const money = (cents)=>{
      if (cents===null || cents===undefined || cents==="") return "‚Äî";
      return (Number(cents)/100).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
    };

    const weekdayLabel = (w)=>{
      const a=["Dom","Seg","Ter","Qua","Qui","Sex","S√°b"];
      return a[Number(w)] ?? String(w);
    };

    function resetState(){
      state = { user:null, profile:null, company:null, role:"staff", isAdmin:false, pros:[], serv:[], prosMap:{}, servMap:{} };
      who.textContent = "‚Äî";
      companyPill.textContent = "Empresa: ‚Äî";
      roleBox.textContent = "‚Äî";
      kpiToday.textContent="‚Äî"; kpiConf.textContent="‚Äî"; kpiCanc.textContent="‚Äî"; kpiDone.textContent="‚Äî";
      kpiApptToday.textContent="‚Äî"; kpiRevenueToday.textContent="‚Äî"; kpiBusiestPro.textContent="‚Äî"; kpiBusiestHour.textContent="‚Äî";
      alertBadge.textContent="‚Äî"; alertsBox.innerHTML = "<div>‚Äî</div>";
      badgeToday.textContent="‚Äî"; badgeAgenda.textContent="‚Äî"; badgeClientes.textContent="‚Äî"; badgePros.textContent="‚Äî"; badgeServ.textContent="‚Äî"; badgeHours.textContent="‚Äî";
      if(badgeProdutos) badgeProdutos.textContent="‚Äî";
      if(badgeEstoque) badgeEstoque.textContent="‚Äî";
      if(badgePDV) badgePDV.textContent="‚Äî";
      tbodyNext.innerHTML=""; tbodyAgenda.innerHTML=""; tbodyCustomers.innerHTML=""; tbodyPros.innerHTML=""; tbodyServ.innerHTML=""; tbodyHours.innerHTML="";
      if(tbodyProducts) tbodyProducts.innerHTML="";
      if(tbodyStock) tbodyStock.innerHTML="";
      if(tbodyPdvProducts) tbodyPdvProducts.innerHTML="";
      if(tbodyPdvCart) tbodyPdvCart.innerHTML="";
      agendaPro.innerHTML=""; whPro.innerHTML="";
      document.querySelectorAll(".menu button").forEach(b=>b.classList.remove("active"));
      document.querySelector('.menu button[data-tab="dash"]').classList.add("active");
      document.querySelectorAll("main section").forEach(sec=>sec.classList.add("hidden"));
      document.getElementById("tab-dash").classList.remove("hidden");
    }

    function showLogin(){ appView.classList.add("hidden"); loginView.classList.remove("hidden"); }
    function showApp(){ loginView.classList.add("hidden"); appView.classList.remove("hidden"); }
    function showError(msg){ err.style.display="block"; err.textContent=msg; }
    function clearError(){ err.style.display="none"; err.textContent=""; }

    function toastMsg(type, msg){
      toast.className = "toast " + (type==="ok" ? "ok" : "err");
      toast.textContent = msg;
      toast.style.display = "block";
      setTimeout(()=> toast.style.display="none", 2600);
    }

    function tagStatus(status){
      if(status==="confirmed") return `<span class="tag ok">Confirmado</span>`;
      if(status==="cancelled") return `<span class="tag bad">Cancelado</span>`;
      if(status==="done") return `<span class="tag done">Conclu√≠do</span>`;
      if(status==="pending" || status==="awaiting") return `<span class="tag warn">Aguardando</span>`;
      return `<span class="tag">${status || "‚Äî"}</span>`;
    }

    function openModal(title, bodyHTML, footerHTML){
      modalTitle.textContent = title;
      modalBody.innerHTML = bodyHTML;
      modalFooter.innerHTML = footerHTML || "";
      modalBack.style.display = "flex";
    }
    function closeModal(){ modalBack.style.display = "none"; }
    modalClose.onclick = closeModal;
    modalBack.addEventListener("click",(e)=>{ if(e.target===modalBack) closeModal(); });

    document.querySelectorAll(".menu button").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".menu button").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        const tab = btn.dataset.tab;
        document.querySelectorAll("main section").forEach(sec=>sec.classList.add("hidden"));
        document.getElementById("tab-" + tab).classList.remove("hidden");

        if(tab==="agenda") loadAgenda();
        if(tab==="clientes") loadCustomers();
        if(tab==="profissionais") loadProfessionals();
        if(tab==="servicos") loadServices();
        if(tab==="horarios") loadWorkingHours();
      if(tab==="produtos") loadLocalProducts();
      if(tab==="estoque") loadLocalStock();
      if(tab==="pdv") loadPDV();
      });
    });

    btnGoAgenda.onclick = ()=>{
      document.querySelectorAll(".menu button").forEach(b=>b.classList.remove("active"));
      document.querySelector('.menu button[data-tab="agenda"]').classList.add("active");
      document.querySelectorAll("main section").forEach(sec=>sec.classList.add("hidden"));
      document.getElementById("tab-agenda").classList.remove("hidden");
      loadAgenda();
    };

    btnLogin.onclick = async ()=>{
      clearError();
      btnLogin.disabled = true;
      btnLogin.textContent = "Entrando...";

      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;

      if(!email || !password){
        btnLogin.disabled = false;
        btnLogin.textContent = "Entrar";
        return showError("Informe e-mail e senha.");
      }

      const { error } = await sb.auth.signInWithPassword({ email, password });

      btnLogin.disabled = false;
      btnLogin.textContent = "Entrar";

      if (error) {
        // Mant√©m mensagem real quando poss√≠vel (ajuda no debug e em casos como email n√£o confirmado)
        const msg = (error?.message || "Falha no login.").toLowerCase().includes("invalid")
          ? "E-mail ou senha inv√°lidos."
          : (error.message || "Falha no login.");
        return showError(msg);
      }

      await bootstrap();
    };

    btnLogout.onclick = async ()=>{
      try{
        await sb.auth.signOut();
      } finally {
        resetState();
        showLogin();
        toastMsg("ok","Sess√£o encerrada.");
      }
    };

    btnRefresh.onclick = async ()=>{
      await refreshAll();
      toastMsg("ok","Atualizado.");
    };

    quickNewCustomer.onclick = ()=> openCustomerModal();
    quickNewPro.onclick = ()=> openProModal();
    quickNewService.onclick = ()=> openServiceModal();

    btnAgendaReload.onclick = loadAgenda;
    btnNewAppointment && (btnNewAppointment.onclick = ()=> openNewAppointmentModal());
    btnCustomersReload.onclick = loadCustomers;
    btnProsReload.onclick = loadProfessionals;
    btnServReload.onclick = loadServices;

    // Produtos/Estoque/PDV (modo local)
    btnProdReload && (btnProdReload.onclick = loadLocalProducts);
    btnNewProduct && (btnNewProduct.onclick = ()=> openProductModal(null));
    prodSearch && (prodSearch.addEventListener('input', debounce(loadLocalProducts, 250)));

    btnStockReload && (btnStockReload.onclick = loadLocalStock);
    btnStockIn && (btnStockIn.onclick = ()=> openStockMovement('in'));
    btnStockOut && (btnStockOut.onclick = ()=> openStockMovement('out'));
    stockSearch && (stockSearch.addEventListener('input', debounce(loadLocalStock, 250)));

    btnPdvReload && (btnPdvReload.onclick = loadPDV);
    btnPdvClear && (btnPdvClear.onclick = pdvClear);
    pdvSearch && (pdvSearch.addEventListener('input', debounce(renderPdvProducts, 200)));
    pdvDiscount && (pdvDiscount.addEventListener('input', debounce(renderPdvCart, 200)));
    btnPdvFinalize && (btnPdvFinalize.onclick = pdvFinalize);

    btnNewCustomer.onclick = ()=> openCustomerModal();
    btnNewPro.onclick = ()=> openProModal();
    btnNewService.onclick = ()=> openServiceModal();

    agendaDate.onchange = loadAgenda;
    agendaPro.onchange = loadAgenda;

    let searchTimer = null;
    searchCustomer.oninput = ()=>{
      clearTimeout(searchTimer);
      searchTimer = setTimeout(loadCustomers, 250);
    };

    // Working hours actions
    btnWhReload.onclick = loadWorkingHours;

    // Hor√°rios: alternar modo (recorrente x por data)
    function syncWhModeUI(){
      const mode = (whMode?.value || 'weekday');
      const isDate = mode === 'date';
      if(whWeekday) whWeekday.style.display = isDate ? 'none' : '';
      if(whDate) whDate.style.display = isDate ? '' : 'none';
      if(whDateEnd) whDateEnd.style.display = isDate ? '' : 'none';

      // defaults √∫teis
      if(isDate && whDate && !whDate.value){
        const d = new Date();
        const iso = d.toISOString().slice(0,10);
        whDate.value = iso;
      }
      if(!isDate && whDateEnd){
        whDateEnd.value = '';
      }
    }
    whMode?.addEventListener('change', syncWhModeUI);
    syncWhModeUI();

    // Hoje + Amanh√£ (modo por data)
    btnWhTodayTomorrow && (btnWhTodayTomorrow.onclick = ()=>{
      if(!whMode) return;
      whMode.value = 'date';
      syncWhModeUI();
      const today = new Date();
      const tomorrow = new Date();
      tomorrow.setDate(today.getDate()+1);
      const t1 = today.toISOString().slice(0,10);
      const t2 = tomorrow.toISOString().slice(0,10);
      if(whDate) whDate.value = t1;
      if(whDateEnd) whDateEnd.value = t2;
    });

    // Listar hor√°rios do profissional (recorrentes + por data)
    btnWhList && (btnWhList.onclick = async ()=>{
      const professional_id = whPro?.value;
      if(!professional_id) return toastMsg('err','Selecione um profissional.');
      await openHoursListModal(professional_id);
    });

    btnCloseHoursList && (btnCloseHoursList.onclick = ()=>{
      if(modalHoursList) modalHoursList.style.display = 'none';
    });

    // >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
    // IMPORTANT√çSSIMO MULTI-EMPRESA:
    // Todos inserts/updates usam state.profile.company_id
    // >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

    btnWhAdd.onclick = async ()=>{
      const professional_id = whPro.value;
      const start_time = whStart.value;
      const end_time = whEnd.value;
      const slot_minutes = Number(whSlot.value || 5); // passo (min)

      if(!professional_id) return toastMsg("err","Selecione um profissional.");
      if(!start_time || !end_time) return toastMsg("err","Informe in√≠cio e fim.");
      if(start_time >= end_time) return toastMsg("err","In√≠cio deve ser menor que fim.");
      if(slot_minutes < 5 || slot_minutes > 180) return toastMsg("err","Passo inv√°lido.");
      if(!state?.profile?.company_id) return toastMsg("err","Sess√£o inv√°lida (sem company_id).");

      const company_id = state.profile.company_id;
      const mode = (whMode?.value || 'weekday');

      // 1) Por data (ex.: hoje/amanh√£)
      if(mode === 'date'){
        const date_start = whDate?.value;
        const date_end = whDateEnd?.value || date_start;
        if(!date_start) return toastMsg('err','Informe a data.');
        if(date_end && date_end < date_start) return toastMsg('err','Data fim deve ser maior/igual √† data.');

        // gera datas (inclusive)
        const dates=[];
        let cur = new Date(date_start + 'T00:00:00');
        const last = new Date((date_end||date_start) + 'T00:00:00');
        while(cur <= last){
          dates.push(cur.toISOString().slice(0,10));
          cur.setDate(cur.getDate()+1);
        }

        const payload = dates.map(d=>({
          company_id,
          professional_id,
          date: d,
          start_time,
          end_time,
          slot_minutes
        }));

        const { error } = await sb.from('working_hours_dates').upsert(payload, { onConflict: 'company_id,professional_id,date,start_time,end_time' });
        if(error){
          console.error(error);
          return toastMsg('err','Erro ao salvar hor√°rio por data. Verifique se a tabela working_hours_dates existe.');
        }
        toastMsg('ok', `Hor√°rio por data salvo (${dates.length} dia(s)).`);
        await loadWorkingHours();
        return;
      }

      // 2) Recorrente (dia da semana)
      const weekday = Number(whWeekday.value);
      const payload = {
        company_id,
        professional_id,
        weekday,
        start_time,
        end_time,
        slot_minutes
      };

      const { error } = await sb.from('working_hours').insert(payload);
      if(error){
        console.error(error);
        return toastMsg('err', 'Erro ao salvar hor√°rio.');
      }
      toastMsg('ok','Hor√°rio salvo.');
      await loadWorkingHours();
    };

    btnWhDefault.onclick = async ()=>{
      const professional_id = whPro.value;
      if(!professional_id) return toastMsg("err","Selecione um profissional.");
      if(!state?.profile?.company_id) return toastMsg("err","Sess√£o inv√°lida (sem company_id).");

      const company_id = state.profile.company_id;
      const start_time = "09:00";
      const end_time = "18:00";
      const slot_minutes = 5;

      // Seg(1) a Sex(5)
      const rows = [1,2,3,4,5].map(weekday=>({
        company_id,
        professional_id,
        weekday,
        start_time,
        end_time,
        slot_minutes
      }));

      // Remove existentes seg-sex e insere novamente (evita duplica√ß√£o)
      const { error: delErr } = await sb.from('working_hours')
        .delete()
        .eq('company_id', company_id)
        .eq('professional_id', professional_id)
        .in('weekday', [1,2,3,4,5]);

      if(delErr){
        console.error(delErr);
        return toastMsg('err','Erro ao limpar hor√°rios seg-sex.');
      }

      const { error } = await sb.from('working_hours').insert(rows);
      if(error){
        console.error(error);
        return toastMsg('err','Erro ao aplicar padr√£o seg-sex.');
      }

      toastMsg('ok','Padr√£o seg-sex aplicado.');
      await loadWorkingHours();
    };

    async function validateAccess(){
      // Preferencial: RPC (security definer) que valida status/fatura e retorna perfil+empresa
      try{
        const { data, error } = await sb.rpc('validate_access');
        if(error) throw error;
        return { ok:true, data };
      } catch(e){
        return { ok:false, error:e };
      }
    }

    async function bootstrap(){
      resetState();

      const { data: sess } = await sb.auth.getSession();
      if(!sess.session){ showLogin(); return; }
      showApp();

      const { data: u } = await sb.auth.getUser();
      state.user = u?.user || null;
      if(!state.user){ showLogin(); return; }

      // 1) Tentativa principal: validate_access() (recomendado)
      const va = await validateAccess();
      if(va.ok && va.data){
        const payload = va.data;

        if(payload.ok !== true){
          // BLOQUEADO (empresa inativa / fatura vencida)
          const msg = payload.message || "Acesso bloqueado. Para reativa√ß√£o, entre em contato com o suporte.";
          showError(msg);
          await sb.auth.signOut();
          resetState();
          showLogin();
          return;
        }

        state.profile = payload.profile || null;
        state.company = payload.company || null;
        state.role = state.profile?.role || "staff";
        state.isAdmin = state.role === "admin";

      } else {
        // 2) Fallback: select direto (se RPC ainda n√£o foi criada)
        const { data: prof, error: e1 } = await sb
          .from("profiles")
          .select("company_id, role, display_name")
          .eq("user_id", state.user.id)
          .maybeSingle();

        if(e1 || !prof){
          showError("Usu√°rio sem v√≠nculo no profiles.");
          await sb.auth.signOut();
          resetState();
          showLogin();
          return;
        }

        const { data: comp, error: e2 } = await sb
          .from("companies")
          .select("name, slug, status, paid_until")
          .eq("id", prof.company_id)
          .maybeSingle();

        if(e2 || !comp){
          showError("Empresa n√£o encontrada para este usu√°rio.");
          await sb.auth.signOut();
          resetState();
          showLogin();
          return;
        }

        // Regras de bloqueio (fallback)
        const status = String(comp.status || "").toLowerCase();
        const paidUntil = comp.paid_until ? new Date(comp.paid_until + "T00:00:00") : null;
        const today = new Date();
        today.setHours(0,0,0,0);

        if(status && status !== "active"){
          showError("Sua fatura venceu ou sua empresa est√° desativada. Para reativa√ß√£o, entre em contato com o suporte.");
          await sb.auth.signOut();
          resetState();
          showLogin();
          return;
        }

        if(paidUntil && paidUntil < today){
          showError(`Sua fatura venceu (pagamento at√© ${comp.paid_until}). Para reativa√ß√£o, entre em contato com o suporte.`);
          await sb.auth.signOut();
          resetState();
          showLogin();
          return;
        }

        state.profile = prof;
        state.company = comp;
        state.role = prof.role || "staff";
        state.isAdmin = state.role === "admin";
      }

      // Se chegou aqui, est√° liberado
      roleBox.textContent = state.isAdmin ? "ADMIN" : "STAFF";

      const prof = state.profile || {};
      const comp = state.company || {};

      who.textContent = `Usu√°rio: ${prof.display_name || state.user.email} ‚Ä¢ Perfil: ${state.role}`;
      companyPill.textContent = `Empresa: ${comp.name || "-"}`;

      agendaDate.value = todayISO();

      await refreshAll();
    }

    async function refreshAll(){
      await loadMaps();
      await loadCounts();
      await loadDashboard();
      await loadDashboardOverview();
      await fillWorkingHoursPros();
      loadLocal(); seedLocalIfEmpty(); recalcLocalBadges();
    }

    async function loadMaps(){
      const companyId = state?.profile?.company_id;
      if(!companyId) return;

      const { data: pros } = await sb
        .from("professionals")
        .select("id,name,active,company_id")
        .eq("company_id", companyId)
        .order("name",{ascending:true});

      const { data: serv } = await sb
        .from("services")
        .select("id,name,active,duration_minutes,price_cents,company_id")
        .eq("company_id", companyId)
        .order("name",{ascending:true});

      state.pros = pros || [];
      state.serv = serv || [];
      state.prosMap = Object.fromEntries((pros||[]).map(p=>[p.id, p.name]));
      state.servMap = Object.fromEntries((serv||[]).map(s=>[s.id, s.name]));
      state.servPriceMap = Object.fromEntries((serv||[]).map(s=>[s.id, Number(s.price_cents||0)]));

      agendaPro.innerHTML = `<option value="">Todos os profissionais</option>`;
      (pros||[]).forEach(p=>{ if(p.active) agendaPro.innerHTML += `<option value="${p.id}">${p.name}</option>`; });
    }

    async function fillWorkingHoursPros(){
      whPro.innerHTML = `<option value="">Selecione um profissional</option>`;
      (state.pros || []).forEach(p=>{
        if(p.active) whPro.innerHTML += `<option value="${p.id}">${p.name}</option>`;
      });
      whPro.onchange = loadWorkingHours;
    }

    async function loadCounts(){
      const companyId = state?.profile?.company_id;
      if(!companyId) return;

      const { count: cAppt } = await sb.from("appointments").select("id",{count:"exact",head:true}).eq("company_id", companyId);
      const { count: cCust } = await sb.from("customers").select("id",{count:"exact",head:true}).eq("company_id", companyId);
      const { count: cPros } = await sb.from("professionals").select("id",{count:"exact",head:true}).eq("company_id", companyId);
      const { count: cServ } = await sb.from("services").select("id",{count:"exact",head:true}).eq("company_id", companyId);
      const { count: cWh }   = await sb.from("working_hours").select("id",{count:"exact",head:true}).eq("company_id", companyId);

      badgeAgenda.textContent = cAppt ?? "0";
      badgeClientes.textContent = cCust ?? "0";
      badgePros.textContent = cPros ?? "0";
      badgeServ.textContent = cServ ?? "0";
      badgeHours.textContent = cWh ?? "0";
      loadLocal(); seedLocalIfEmpty(); recalcLocalBadges();

      const d = agendaDate.value || todayISO();
      const { start, end } = dayRangeUTC(d);

      const { count: cToday } = await sb
        .from("appointments")
        .select("id",{count:"exact",head:true})
        .eq("company_id", companyId)
        .gte("starts_at", start)
        .lt("starts_at", end);

      badgeToday.textContent = cToday ?? "0";
    }

    async function loadDashboard(){
      const companyId = state?.profile?.company_id;
      if(!companyId){
        kpiToday.textContent="‚Äî"; kpiConf.textContent="‚Äî"; kpiCanc.textContent="‚Äî"; kpiDone.textContent="‚Äî";
      kpiApptToday.textContent="‚Äî"; kpiRevenueToday.textContent="‚Äî"; kpiBusiestPro.textContent="‚Äî"; kpiBusiestHour.textContent="‚Äî";
      alertBadge.textContent="‚Äî"; alertsBox.innerHTML = "<div>‚Äî</div>";
        tbodyNext.innerHTML = `<tr><td colspan="5">Sess√£o inv√°lida (sem company_id).</td></tr>`;
        return;
      }

      const d = todayISO();
      const { start, end } = dayRangeUTC(d);

      const { data, error } = await sb
        .from("appointments")
        .select("status, starts_at")
        .eq("company_id", companyId)
        .gte("starts_at", start)
        .lt("starts_at", end);

      if(error){
        kpiToday.textContent="‚Äî"; kpiConf.textContent="‚Äî"; kpiCanc.textContent="‚Äî"; kpiDone.textContent="‚Äî";
      kpiApptToday.textContent="‚Äî"; kpiRevenueToday.textContent="‚Äî"; kpiBusiestPro.textContent="‚Äî"; kpiBusiestHour.textContent="‚Äî";
      alertBadge.textContent="‚Äî"; alertsBox.innerHTML = "<div>‚Äî</div>";
      } else {
        const total = (data||[]).length;
        const conf = (data||[]).filter(x=>x.status==="confirmed").length;
        const canc = (data||[]).filter(x=>x.status==="cancelled").length;
        const done = (data||[]).filter(x=>x.status==="done").length;
        kpiToday.textContent = total;
        kpiConf.textContent = conf;
        kpiCanc.textContent = canc;
        kpiDone.textContent = done;
      }

      const now = new Date().toISOString();
      const { data: next, error: e2 } = await sb
        .from("appointments")
        .select("id, starts_at, status, customer_name, professional_id, service_id")
        .eq("company_id", companyId)
        .gte("starts_at", now)
        .order("starts_at",{ascending:true})
        .limit(20);

      tbodyNext.innerHTML = "";
      if(e2 || !next || !next.length){
        tbodyNext.innerHTML = `<tr><td colspan="5">Nenhum agendamento futuro.</td></tr>`;
      } else {
        next.forEach(a=>{
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${fmtDateTime(a.starts_at)}</td>
            <td>${state.prosMap[a.professional_id] || "‚Äî"}</td>
            <td>${state.servMap[a.service_id] || "‚Äî"}</td>
            <td>${a.customer_name || "‚Äî"}</td>
            <td>${tagStatus(a.status)}</td>
          `;
          tbodyNext.appendChild(tr);
        });
      }
    }

    
    async function loadDashboardOverview(){
      const companyId = state?.profile?.company_id;
      if(!companyId){
        kpiApptToday.textContent="‚Äî";
        kpiRevenueToday.textContent="‚Äî";
        kpiBusiestPro.textContent="‚Äî";
        kpiBusiestHour.textContent="‚Äî";
        alertBadge.textContent="‚Äî";
        alertsBox.innerHTML = "<div>Sess√£o inv√°lida (sem company_id).</div>";
        return;
      }

      const { data, error } = await sb.rpc("dashboard_overview");
      if(error || !data){
        // Fallback silencioso (mant√©m painel funcionando mesmo sem as functions)
        kpiApptToday.textContent="‚Äî";
        kpiRevenueToday.textContent="‚Äî";
        kpiBusiestPro.textContent="‚Äî";
        kpiBusiestHour.textContent="‚Äî";
        alertBadge.textContent="‚Äî";
        alertsBox.innerHTML = `<div>N√£o foi poss√≠vel carregar as m√©tricas avan√ßadas.</div>`;
        return;
      }

      // TODAY
      const today = data.today || {};
      kpiApptToday.textContent = Number(today.appointments_today || 0);
      kpiRevenueToday.textContent = money(Number(today.revenue_today_cents || 0));

      // WEEK
      const week = data.week || {};
      const bProName = week.busiest_professional_name;
      const bProCount = Number(week.busiest_professional_count || 0);
      kpiBusiestPro.textContent = (bProName ? `${bProName} (${bProCount})` : "‚Äî");

      const bHour = week.busiest_hour;
      const bHourCount = Number(week.busiest_hour_count || 0);
      kpiBusiestHour.textContent = (bHour ? `${String(bHour).padStart(2,"0")}:00 (${bHourCount})` : "‚Äî");

      // ALERTS
      const alerts = data.alerts || {};
      const agendaEmptyTomorrow = !!alerts.agenda_empty_tomorrow;
      const prosWithoutHours = Array.isArray(alerts.professionals_without_hours) ? alerts.professionals_without_hours : [];

      const items = [];
      if(agendaEmptyTomorrow){
        items.push(`<div><span class="tag bad">Aten√ß√£o</span> Agenda vazia amanh√£.</div>`);
      } else {
        items.push(`<div><span class="tag ok">OK</span> H√° agendamentos para amanh√£.</div>`);
      }

      if(prosWithoutHours.length){
        const names = prosWithoutHours
          .map(x => x?.professional_name || x?.name || x?.professional || "Profissional")
          .slice(0, 8)
          .join(", ");
        items.push(`<div><span class="tag warn">Aviso</span> Profissionais sem hor√°rio cadastrado: <b>${esc(names)}</b>${prosWithoutHours.length>8 ? "‚Ä¶" : ""}</div>`);
      } else {
        items.push(`<div><span class="tag ok">OK</span> Todos os profissionais ativos possuem hor√°rio cadastrado.</div>`);
      }

      alertsBox.innerHTML = items.join("");
      const totalAlerts = (agendaEmptyTomorrow ? 1 : 0) + (prosWithoutHours.length ? 1 : 0);
      alertBadge.textContent = totalAlerts ? String(totalAlerts) : "0";
    }


    async function loadAgenda(){
      const companyId = state?.profile?.company_id;
      if(!companyId){
        tbodyAgenda.innerHTML = `<tr><td colspan="7">Sess√£o inv√°lida (sem company_id).</td></tr>`;
        return;
      }

      const date = agendaDate.value || todayISO();
      const { start, end } = dayRangeUTC(date);
      const proId = agendaPro.value;

      let q = sb
        .from("appointments")
        .select("id, company_id, starts_at, status, customer_name, customer_phone, professional_id, service_id")
        .eq("company_id", companyId)
        .gte("starts_at", start)
        .lt("starts_at", end)
        .neq("status", "done")
        .order("starts_at",{ascending:true});

      if(proId) q = q.eq("professional_id", proId);

      const { data, error } = await q;

      // filtro local (r√°pido) para busca na tela sem complicar o SQL
      const aTerm = (agendaSearch?.value || "").trim().toLowerCase();
      let list = data || [];
      state.__todayAppts = list.slice(0, 80);
      try { fillPdvAppointmentsOfDay(); } catch(e) {}
      if(aTerm){
        list = list.filter(x =>
          (x.customer_name||"").toLowerCase().includes(aTerm) ||
          (x.customer_phone||"").toLowerCase().includes(aTerm)
        );
      }

      tbodyAgenda.innerHTML = "";
      if(error){
        tbodyAgenda.innerHTML = `<tr><td colspan="7">Erro ao carregar agenda.</td></tr>`;
        return;
      }
      if(!list?.length){
        tbodyAgenda.innerHTML = `<tr><td colspan="7">Nenhum agendamento para este filtro.</td></tr>`;
        return;
      }

      list.forEach(a=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${fmtTime(a.starts_at)}</td>
          <td>${state.prosMap[a.professional_id] || "‚Äî"}</td>
          <td>${state.servMap[a.service_id] || "‚Äî"}</td>
          <td>
            <button class="linkBtn" onclick="openCustomerHistoryFromAgenda('${a.customer_name||""}','${a.customer_phone||""}')">
              ${a.customer_name || "‚Äî"}
            </button>
          </td>
          <td>
            <div class="phoneCell">
              <span>${a.customer_phone || "‚Äî"}</span>
              ${renderWhatsAppBtn(a.customer_phone, a.customer_name)}
            </div>
          </td>
          <td>${tagStatus(a.status)}</td>
          <td>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn2" onclick="openAppointmentComanda(\'${a.id}\')">Comanda</button>
              <button class="btn2" data-act="confirm" data-id="${a.id}">Confirmar</button>
              <button class="btn2" data-act="done" data-id="${a.id}">Finalizar</button>
              <button class="btn2 btnDanger" data-act="cancel" data-id="${a.id}">Cancelar</button>
              ${state.isAdmin ? '<button class="btn2 btnDanger" data-act="del" data-id="${a.id}">Excluir</button>' : ""}
            </div>
          </td>
        `;
        tbodyAgenda.appendChild(tr);
      });

      tbodyAgenda.querySelectorAll("button[data-act]").forEach(b=>{
        b.onclick = ()=> onAgendaAction(b.dataset.act, b.dataset.id);
      });

      await loadCounts();
    }

    async function loadHistory(){
      const companyId = state?.profile?.company_id;
      if(!companyId){
        tbodyHistorico.innerHTML = `<tr><td colspan="7">Sess√£o inv√°lida (sem company_id).</td></tr>`;
        return;
      }

      // Defaults: √∫ltimos 7 dias
      if(!histStart.value || !histEnd.value){
        const today = new Date();
        const end = today.toISOString().slice(0,10);
        const startDate = new Date(today);
        startDate.setDate(startDate.getDate() - 7);
        const start = startDate.toISOString().slice(0,10);
        histStart.value = start;
        histEnd.value = end;
      }

      const startDay = histStart.value;
      const endDay = histEnd.value;
      const proId = histPro.value;
      const term = (histSearch.value || "").trim().toLowerCase();

      const { start: startTs } = dayRangeUTC(startDay);
      // endDay inclusive -> range at√© o final do dia
      const { end: endTs } = dayRangeUTC(endDay);

      let q = sb
        .from("appointments")
        .select("id, starts_at, ends_at, status, customer_name, customer_phone, professional_id, service_id")
        .eq("company_id", companyId)
        .eq("status", "done")
        .gte("starts_at", startTs)
        .lt("starts_at", endTs)
        .order("starts_at", { ascending: false });

      if(proId) q = q.eq("professional_id", proId);

      const { data, error } = await q;

      tbodyHistorico.innerHTML = "";
      if(error){
        tbodyHistorico.innerHTML = `<tr><td colspan="7">Erro ao carregar hist√≥rico.</td></tr>`;
        return;
      }

      let list = data || [];
      if(term){
        list = list.filter(x =>
          (x.customer_name||"").toLowerCase().includes(term) ||
          (x.customer_phone||"").toLowerCase().includes(term)
        );
      }

      if(!list.length){
        tbodyHistorico.innerHTML = `<tr><td colspan="7">Nenhum registro no per√≠odo.</td></tr>`;
        badgeHistorico.textContent = "0";
        return;
      }

      badgeHistorico.textContent = String(list.length);

      list.forEach(a=>{
        const d = fmtDate(a.starts_at);
        const t = fmtTime(a.starts_at);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${d}</td>
          <td>${t}</td>
          <td>${state.prosMap[a.professional_id] || "‚Äî"}</td>
          <td>${state.servMap[a.service_id] || "‚Äî"}</td>
          <td>
            <button class="linkBtn" onclick="openAppointmentComanda('${a.id}')">${a.customer_name || "‚Äî"}</button>
          </td>
          <td>
            <div class="phoneCell">
              <span>${a.customer_phone || "‚Äî"}</span>
              ${renderWhatsAppBtn(a.customer_phone, a.customer_name)}
            </div>
          </td>
          <td>${tagStatus(a.status)}</td>
        `;
        tbodyHistorico.appendChild(tr);
      });
    }

    // Bot√µes r√°pidos do Hist√≥rico
    if(btnHistToday){
      btnHistToday.onclick = async ()=>{
        const d = todayISO();
        histStart.value = d; histEnd.value = d;
        await loadHistory();
      };
    }
    if(btnHist7){
      btnHist7.onclick = async ()=>{
        const today = new Date();
        const end = today.toISOString().slice(0,10);
        const startDate = new Date(today); startDate.setDate(startDate.getDate()-7);
        histStart.value = startDate.toISOString().slice(0,10);
        histEnd.value = end;
        await loadHistory();
      };
    }
    if(btnHist30){
      btnHist30.onclick = async ()=>{
        const today = new Date();
        const end = today.toISOString().slice(0,10);
        const startDate = new Date(today); startDate.setDate(startDate.getDate()-30);
        histStart.value = startDate.toISOString().slice(0,10);
        histEnd.value = end;
        await loadHistory();
      };
    }
    if(btnHistReload){
      btnHistReload.onclick = loadHistory;
    }
    if(histSearch){
      histSearch.addEventListener("input", debounce(loadHistory, 250));
    }
    if(histPro){
      histPro.onchange = loadHistory;
    }
    if(histStart) histStart.onchange = loadHistory;
    if(histEnd) histEnd.onchange = loadHistory;

    // Excluir hist√≥rico por data (somente ADMIN)
    if(btnHistClear){
      btnHistClear.onclick = async ()=>{
        if(!state.isAdmin) return toastMsg("err","Apenas ADMIN pode excluir hist√≥rico.");
        const startDay = histStart.value;
        const endDay = histEnd.value;
        if(!startDay || !endDay) return toastMsg("err","Informe data inicial e final.");
        const ok = confirm(`Excluir hist√≥rico (DONE) de ${startDay} at√© ${endDay}?`);
        if(!ok) return;

        const { start: startTs } = dayRangeUTC(startDay);
        const { end: endTs } = dayRangeUTC(endDay);

        const { error } = await sb
          .from("appointments")
          .delete()
          .eq("company_id", state.profile.company_id)
          .eq("status", "done")
          .gte("starts_at", startTs)
          .lt("starts_at", endTs);

        if(error) return toastMsg("err","Erro ao excluir hist√≥rico (verifique policy/admin).");
        toastMsg("ok","Hist√≥rico exclu√≠do.");
        await loadHistory();
        await loadDashboard();
        await loadDashboardOverview();
      };
    }


    async function onAgendaAction(act, id){
      if(act==="del" && !state.isAdmin) return toastMsg("err","Apenas ADMIN pode excluir.");
      if(act==="del"){
        const ok = confirm("Excluir este agendamento? Essa a√ß√£o n√£o pode ser desfeita.");
        if(!ok) return;
        const { error } = await sb.from("appointments").delete().eq("id", id).eq("company_id", state.profile.company_id);
        if(error) return toastMsg("err","Erro ao excluir.");
        toastMsg("ok","Agendamento exclu√≠do.");
        await loadAgenda(); await loadDashboard(); await loadDashboardOverview();
      await loadDashboardOverview();
        return;
      }
      let status = "confirmed";
      if(act==="cancel") status = "cancelled";
      if(act==="done") status = "done";
      if(act==="confirm") status = "confirmed";

      const { error } = await sb.from("appointments").update({ status }).eq("id", id).eq("company_id", state.profile.company_id);
      if(error) return toastMsg("err","Erro ao atualizar status.");
      toastMsg("ok","Status atualizado.");
      await loadAgenda();
      // Se foi finalizado, atualiza tamb√©m o Hist√≥rico para aparecer imediatamente.
      if(status === "done"){
        try { await loadHistory(); } catch(e) {}
      }
      await loadDashboard();
      await loadDashboardOverview();
    }

    async function loadCustomers(){
      const term = (searchCustomer.value || "").trim().toLowerCase();
      const { data, error } = await sb
        .from("customers")
        .select("id, full_name, phone, email, document, birth_date, address, notes")
        .eq("company_id", state.profile.company_id)
        .order("full_name",{ascending:true})
        .limit(200);

      tbodyCustomers.innerHTML = "";
      if(error){ tbodyCustomers.innerHTML = `<tr><td colspan="5">Erro ao carregar clientes.</td></tr>`; return; }

      let list = data || [];
      if(term){
        list = list.filter(c =>
          (c.full_name||"").toLowerCase().includes(term) ||
          (c.phone||"").toLowerCase().includes(term)
        );
      }
      if(!list.length){
        tbodyCustomers.innerHTML = `<tr><td colspan="5">Nenhum cliente encontrado.</td></tr>`;
        badgeClientes.textContent = "0";
        return;
      }
      badgeClientes.textContent = String(list.length);

      list.forEach(c=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${c.full_name || "‚Äî"}</td>
          <td>
            <div class="phoneCell">
              <span>${c.phone || "‚Äî"}</span>
              ${renderWhatsAppBtn(c.phone, c.full_name, true)}
            </div>
          </td>
          <td>${c.email || "‚Äî"}</td>
          <td>${c.document || "‚Äî"}</td>
          <td>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn2" onclick="openCustomerModal(\'${encodeURIComponent(JSON.stringify(c))}\')">Editar</button>
              <button class="btn2" onclick="openCustomerHistory(\'${encodeURIComponent(JSON.stringify(c))}\')">Hist√≥rico</button>
              ${state.isAdmin ? '<button class="btn2 btnDanger" onclick="deleteCustomer(\'${c.id}\')">Excluir</button>' : ""}
            </div>
          </td>
        `;
        tbodyCustomers.appendChild(tr);
      });
    }

    async function loadProfessionals(){
      const { data, error } = await sb
        .from("professionals")
        .select("id,name,active")
        .eq("company_id", state.profile.company_id)
        .order("name",{ascending:true});

      tbodyPros.innerHTML = "";
      if(error){ tbodyPros.innerHTML = `<tr><td colspan="3">Erro ao carregar profissionais.</td></tr>`; return; }
      if(!data.length){ tbodyPros.innerHTML = `<tr><td colspan="3">Nenhum profissional cadastrado.</td></tr>`; return; }

      badgePros.textContent = String(data.length);

      data.forEach(p=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.name}</td>
          <td>${p.active ? `<span class="tag ok">Ativo</span>` : `<span class="tag bad">Inativo</span>`}</td>
          <td>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn2" onclick="openProModal(\'${encodeURIComponent(JSON.stringify(p))}\')">Editar</button>
              <button class="btn2" onclick="togglePro('${p.id}', ${p.active})">${p.active ? "Inativar" : "Ativar"}</button>
              ${state.isAdmin ? '<button class="btn2 btnDanger" onclick="deletePro(\'${p.id}\')">Excluir</button>' : ""}
            </div>
          </td>
        `;
        tbodyPros.appendChild(tr);
      });

      await loadMaps();
      await fillWorkingHoursPros();
      loadLocal(); seedLocalIfEmpty(); recalcLocalBadges();
    }

    async function loadServices(){
      const { data, error } = await sb
        .from("services")
        .select("id,name,duration_minutes,price_cents,active")
        .eq("company_id", state.profile.company_id)
        .order("name",{ascending:true});

      tbodyServ.innerHTML = "";
      if(error){ tbodyServ.innerHTML = `<tr><td colspan="5">Erro ao carregar servi√ßos.</td></tr>`; return; }
      if(!data.length){ tbodyServ.innerHTML = `<tr><td colspan="5">Nenhum servi√ßo cadastrado.</td></tr>`; return; }

      badgeServ.textContent = String(data.length);

      data.forEach(s=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${s.name}</td>
          <td>${s.duration_minutes} min</td>
          <td>${money(s.price_cents)}</td>
          <td>${s.active ? `<span class="tag ok">Ativo</span>` : `<span class="tag bad">Inativo</span>`}</td>
          <td>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn2" onclick="openServiceModal(\'${encodeURIComponent(JSON.stringify(s))}\')">Editar</button>
              <button class="btn2" onclick="toggleService('${s.id}', ${s.active})">${s.active ? "Inativar" : "Ativar"}</button>
              ${state.isAdmin ? '<button class="btn2 btnDanger" onclick="deleteService(\'${s.id}\')">Excluir</button>' : ""}
            </div>
          </td>
        `;
        tbodyServ.appendChild(tr);
      });

      await loadMaps();
    }
    async function loadWorkingHours(){
      const company_id = state.profile.company_id;
      const proId = whPro.value;

      const q1 = sb
        .from("working_hours")
        .select("id, professional_id, weekday, start_time, end_time, slot_minutes")
        .eq("company_id", company_id)
        .order("professional_id",{ascending:true})
        .order("weekday",{ascending:true})
        .order("start_time",{ascending:true});

      const q2 = sb
        .from("working_hours_dates")
        .select("id, professional_id, date, start_time, end_time, slot_minutes")
        .eq("company_id", company_id)
        .order("professional_id",{ascending:true})
        .order("date",{ascending:true})
        .order("start_time",{ascending:true});

      if(proId){ q1.eq("professional_id", proId); q2.eq("professional_id", proId); }

      const [{ data: wh, error: e1 }, { data: wd, error: e2 }] = await Promise.all([q1, q2]);

      tbodyHours.innerHTML = "";

      if(e1 && String(e1.message||'').toLowerCase().includes('relation') ){
        console.error(e1);
      }
      if(e2 && String(e2.message||'').toLowerCase().includes('relation') ){
        console.error(e2);
      }

      const rows=[];
      (wh||[]).forEach(w=>rows.push({
        kind:'weekday',
        id:w.id,
        professional_id:w.professional_id,
        day_label: weekdayLabel(w.weekday),
        start_time:w.start_time,
        end_time:w.end_time,
        slot_minutes:w.slot_minutes,
        type_label:'Recorrente'
      }));
      (wd||[]).forEach(w=>rows.push({
        kind:'date',
        id:w.id,
        professional_id:w.professional_id,
        day_label: fmtDate(w.date),
        start_time:w.start_time,
        end_time:w.end_time,
        slot_minutes:w.slot_minutes,
        type_label:'Por data'
      }));

      // ordena por profissional + tipo + dia
      rows.sort((a,b)=>{
        const pa=(state.prosMap[a.professional_id]||'').toLowerCase();
        const pb=(state.prosMap[b.professional_id]||'').toLowerCase();
        if(pa<pb) return -1; if(pa>pb) return 1;
        if(a.kind!==b.kind) return a.kind==='weekday' ? -1 : 1;
        return (a.day_label||'').localeCompare(b.day_label||'', 'pt-BR');
      });

      const colCount = 7;
      if((e1 && !wh) || (e2 && !wd)){
        tbodyHours.innerHTML = `<tr><td colspan="${colCount}">Erro ao carregar hor√°rios.</td></tr>`;
        return;
      }
      if(!rows.length){
        tbodyHours.innerHTML = `<tr><td colspan="${colCount}">Nenhum hor√°rio cadastrado.</td></tr>`;
        await loadCounts();
        return;
      }

      rows.forEach(r=>{
        const tr = document.createElement("tr");
        const delBtn = state.isAdmin ? `<button class="btn2 btnDanger" onclick="${r.kind==='weekday' ? `deleteWH('${r.id}')` : `deleteWHDate('${r.id}')`}">Excluir</button>` : "";
        const editBtn = r.kind==='weekday' ? `<button class="btn2" onclick="editWH('${r.id}')">Editar</button>` : `<button class="btn2" onclick="editWHDate('${r.id}')">Editar</button>`;

        tr.innerHTML = `
          <td>${state.prosMap[r.professional_id] || "‚Äî"}</td>
          <td>${r.day_label}</td>
          <td>${r.start_time}</td>
          <td>${r.end_time}</td>
          <td>${r.slot_minutes} min</td>
          <td>${r.type_label}</td>
          <td>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              ${editBtn}
              ${delBtn}
            </div>
          </td>
        `;
        tbodyHours.appendChild(tr);
      });

      await loadCounts();
    }


    // ----- MODAIS / CRUD -----

    function esc(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    window.openCustomerModal = (encoded)=>{
      let c=null;
      if(encoded) c = JSON.parse(decodeURIComponent(encoded));
      const isEdit = !!c;
      c = c || { id:null, full_name:"", phone:"", email:"", document:"", birth_date:"", address:"", notes:"" };

      openModal(
        isEdit ? "Editar Cliente" : "Novo Cliente",
        `
          <div class="row2">
            <div><label>Nome completo</label><input id="c_full_name" value="${esc(c.full_name)}"/></div>
            <div><label>Telefone</label><input id="c_phone" value="${esc(c.phone||"")}"/></div>
          </div>
          <div class="row2">
            <div><label>E-mail</label><input id="c_email" value="${esc(c.email||"")}"/></div>
            <div><label>Documento</label><input id="c_document" value="${esc(c.document||"")}"/></div>
          </div>
          <div class="row2">
            <div><label>Nascimento</label><input id="c_birth" type="date" value="${c.birth_date||""}"/></div>
            <div><label>Endere√ßo</label><input id="c_address" value="${esc(c.address||"")}"/></div>
          </div>
          <div><label>Observa√ß√µes</label><input id="c_notes" value="${esc(c.notes||"")}"/></div>
        `,
        `
          <button class="btn2" onclick="window.__closeModal()">Cancelar</button>
          <button class="btn" onclick="window.saveCustomer('${c.id||""}')">${isEdit ? "Salvar" : "Cadastrar"}</button>
        `
      );
    };

    window.saveCustomer = async (id)=>{
      if(!state?.profile?.company_id) return toastMsg("err","Sess√£o inv√°lida (sem company_id).");

      const payload = {
        company_id: state.profile.company_id,
        full_name: document.getElementById("c_full_name").value.trim(),
        phone: document.getElementById("c_phone").value.trim() || null,
        email: document.getElementById("c_email").value.trim() || null,
        document: document.getElementById("c_document").value.trim() || null,
        birth_date: document.getElementById("c_birth").value || null,
        address: document.getElementById("c_address").value.trim() || null,
        notes: document.getElementById("c_notes").value.trim() || null
      };
      if(payload.full_name.length < 2) return toastMsg("err","Nome inv√°lido.");

      let res;
      if(id){
        // update n√£o precisa regravar company_id, mas n√£o atrapalha
        res = await sb.from("customers").update(payload).eq("id", id).eq("company_id", state.profile.company_id);
      } else {
        res = await sb.from("customers").insert(payload);
      }

      if(res.error) return toastMsg("err","Erro ao salvar cliente.");
      toastMsg("ok", id ? "Cliente atualizado." : "Cliente cadastrado.");
      closeModal();
      await loadCustomers(); await loadCounts();
    };

    window.deleteCustomer = async (id)=>{
      if(!state.isAdmin) return toastMsg("err","Apenas ADMIN pode excluir.");
      if(!confirm("Excluir cliente?")) return;
      const { error } = await sb.from("customers").delete().eq("id", id).eq("company_id", state.profile.company_id);
      if(error) return toastMsg("err","Erro ao excluir.");
      toastMsg("ok","Cliente exclu√≠do.");
      await loadCustomers(); await loadCounts();
    };

    window.openProModal = (encoded)=>{
      let p=null;
      if(encoded) p = JSON.parse(decodeURIComponent(encoded));
      const isEdit = !!p;
      p = p || { id:null, name:"", active:true };

      openModal(
        isEdit ? "Editar Profissional" : "Novo Profissional",
        `
          <div class="row2">
            <div><label>Nome</label><input id="p_name" value="${esc(p.name)}"/></div>
            <div>
              <label>Status</label>
              <select id="p_active">
                <option value="true" ${p.active ? "selected":""}>Ativo</option>
                <option value="false" ${!p.active ? "selected":""}>Inativo</option>
              </select>
            </div>
          </div>
        `,
        `
          <button class="btn2" onclick="window.__closeModal()">Cancelar</button>
          <button class="btn" onclick="window.savePro('${p.id||""}')">${isEdit ? "Salvar" : "Cadastrar"}</button>
        `
      );
    };

    window.savePro = async (id)=>{
      if(!state?.profile?.company_id) return toastMsg("err","Sess√£o inv√°lida (sem company_id).");

      const name = document.getElementById("p_name").value.trim();
      const active = document.getElementById("p_active").value === "true";
      if(name.length < 2) return toastMsg("err","Nome inv√°lido.");

      let res;
      if(id){
        res = await sb.from("professionals").update({ name, active }).eq("id", id).eq("company_id", state.profile.company_id);
      } else {
        res = await sb.from("professionals").insert({ company_id: state.profile.company_id, name, active });
      }

      if(res.error) return toastMsg("err","Erro ao salvar profissional.");
      toastMsg("ok", id ? "Profissional atualizado." : "Profissional cadastrado.");
      closeModal();
      await loadProfessionals(); await loadCounts();
    };

    window.togglePro = async (id, active)=>{
      const { error } = await sb.from("professionals").update({ active: !active }).eq("id", id).eq("company_id", state.profile.company_id);
      if(error) return toastMsg("err","Erro ao atualizar.");
      toastMsg("ok","Atualizado.");
      await loadProfessionals(); await loadCounts();
    };

    window.deletePro = async (id)=>{
      if(!state.isAdmin) return toastMsg("err","Apenas ADMIN pode excluir.");
      if(!confirm("Excluir profissional?")) return;
      const { error } = await sb.from("professionals").delete().eq("id", id).eq("company_id", state.profile.company_id);
      if(error) return toastMsg("err","Erro ao excluir.");
      toastMsg("ok","Profissional exclu√≠do.");
      await loadProfessionals(); await loadCounts();
    };

    window.openServiceModal = (encoded)=>{
      let s=null;
      if(encoded) s = JSON.parse(decodeURIComponent(encoded));
      const isEdit = !!s;
      s = s || { id:null, name:"", duration_minutes:30, price_cents:0, active:true };

      openModal(
        isEdit ? "Editar Servi√ßo" : "Novo Servi√ßo",
        `
          <div class="row2">
            <div><label>Nome do servi√ßo</label><input id="s_name" value="${esc(s.name)}"/></div>
            <div><label>Dura√ß√£o (min)</label><input id="s_dur" type="number" min="10" max="480" value="${Number(s.duration_minutes||30)}"/></div>
          </div>
          <div class="row2">
            <div><label>Pre√ßo (R$)</label><input id="s_price" type="number" step="0.01" value="${(Number(s.price_cents||0)/100).toFixed(2)}"/></div>
            <div>
              <label>Status</label>
              <select id="s_active">
                <option value="true" ${s.active ? "selected":""}>Ativo</option>
                <option value="false" ${!s.active ? "selected":""}>Inativo</option>
              </select>
            </div>
          </div>
        `,
        `
          <button class="btn2" onclick="window.__closeModal()">Cancelar</button>
          <button class="btn" onclick="window.saveService('${s.id||""}')">${isEdit ? "Salvar" : "Cadastrar"}</button>
        `
      );
    };

    window.saveService = async (id)=>{
      if(!state?.profile?.company_id) return toastMsg("err","Sess√£o inv√°lida (sem company_id).");

      const name = document.getElementById("s_name").value.trim();
      const duration_minutes = Number(document.getElementById("s_dur").value || 30);
      const price = Number(document.getElementById("s_price").value || 0);
      const price_cents = Math.round(price * 100);
      const active = document.getElementById("s_active").value === "true";

      if(name.length < 2) return toastMsg("err","Nome inv√°lido.");
      if(duration_minutes < 10 || duration_minutes > 480) return toastMsg("err","Dura√ß√£o inv√°lida.");

      let res;
      if(id){
        res = await sb.from("services").update({ name, duration_minutes, price_cents, active }).eq("id", id).eq("company_id", state.profile.company_id);
      } else {
        res = await sb.from("services").insert({ company_id: state.profile.company_id, name, duration_minutes, price_cents, active });
      }

      if(res.error) return toastMsg("err","Erro ao salvar servi√ßo.");
      toastMsg("ok", id ? "Servi√ßo atualizado." : "Servi√ßo cadastrado.");
      closeModal();
      await loadServices(); await loadCounts();
    };

    window.toggleService = async (id, active)=>{
      const { error } = await sb.from("services").update({ active: !active }).eq("id", id).eq("company_id", state.profile.company_id);
      if(error) return toastMsg("err","Erro ao atualizar.");
      toastMsg("ok","Atualizado.");
      await loadServices(); await loadCounts();
    };

    window.deleteService = async (id)=>{
      // IMPORTANTE: no banco existe prote√ß√£o "DELETE bloqueado. Use active=false."
      // Ent√£o aqui fazemos "exclus√£o l√≥gica" (inativa o servi√ßo) para n√£o quebrar FK com appointments.
      if(!state.isAdmin) return toastMsg("err","Apenas ADMIN pode excluir.");
      if(!confirm("Excluir servi√ßo? (vai apenas INATIVAR)")) return;

      if(!state?.profile?.company_id) return toastMsg("err","Sess√£o inv√°lida (sem company_id).");

      const { error } = await sb
        .from("services")
        .update({ active: false })
        .eq("id", id)
        .eq("company_id", state.profile.company_id);

      if(error){
        console.error(error);
        return toastMsg("err", "N√£o foi poss√≠vel excluir (inativar).");
      }

      toastMsg("ok","Servi√ßo inativado.");
      await loadServices(); await loadCounts();
    };

    // Working hours edit/delete
    window.editWH = async (id)=>{
      const { data, error } = await sb.from("working_hours")
        .select("id, professional_id, weekday, start_time, end_time, slot_minutes")
        .eq("company_id", state.profile.company_id)
        .eq("id", id).maybeSingle();

      if(error || !data) return toastMsg("err","Erro ao abrir hor√°rio.");

      openModal(
        "Editar Hor√°rio",
        `
          <div class="row2">
            <div>
              <label>Profissional</label>
              <select id="wh_e_pro">
                ${state.pros.filter(p=>p.active).map(p=>`<option value="${p.id}" ${p.id===data.professional_id?"selected":""}>${p.name}</option>`).join("")}
              </select>
            </div>
            <div>
              <label>Dia</label>
              <select id="wh_e_day">
                ${[0,1,2,3,4,5,6].map(w=>`<option value="${w}" ${Number(w)===Number(data.weekday)?"selected":""}>${weekdayLabel(w)}</option>`).join("")}
              </select>
            </div>
          </div>
          <div class="row2">
            <div><label>In√≠cio</label><input id="wh_e_start" type="time" value="${data.start_time}"/></div>
            <div><label>Fim</label><input id="wh_e_end" type="time" value="${data.end_time}"/></div>
          </div>
          <div><label>Passo (min)</label><input id="wh_e_slot" type="number" min="5" max="180" value="${data.slot_minutes}"/></div>
        `,
        `
          <button class="btn2" onclick="window.__closeModal()">Cancelar</button>
          <button class="btn" onclick="window.saveWH('${data.id}')">Salvar</button>
        `
      );
    };

    window.saveWH = async (id)=>{
      if(!state?.profile?.company_id) return toastMsg("err","Sess√£o inv√°lida (sem company_id).");

      const professional_id = document.getElementById("wh_e_pro").value;
      const weekday = Number(document.getElementById("wh_e_day").value);
      const start_time = document.getElementById("wh_e_start").value;
      const end_time = document.getElementById("wh_e_end").value;
      const slot_minutes = Number(document.getElementById("wh_e_slot").value || 30);

      if(start_time >= end_time) return toastMsg("err","In√≠cio deve ser menor que fim.");
      if(slot_minutes < 5 || slot_minutes > 180) return toastMsg("err","Passo inv√°lido.");

      const { error } = await sb.from("working_hours")
        .update({ professional_id, weekday, start_time, end_time, slot_minutes })
        .eq("id", id)
        .eq("company_id", state.profile.company_id);

      if(error) return toastMsg("err","Erro ao salvar hor√°rio.");
      toastMsg("ok","Hor√°rio atualizado.");
      closeModal();
      await loadWorkingHours();
    };

    window.deleteWH = async (id)=>{
      if(!state.isAdmin) return toastMsg("err","Apenas ADMIN pode excluir.");
      if(!confirm("Excluir hor√°rio?")) return;
      const { error } = await sb.from("working_hours").delete().eq("id", id).eq("company_id", state.profile.company_id);
      if(error) return toastMsg("err","Erro ao excluir.");
      toastMsg("ok","Hor√°rio exclu√≠do.");
      await loadWorkingHours();
    };

    // Working hours (por data) edit/delete
    window.editWHDate = async (id)=>{
      const { data, error } = await sb.from('working_hours_dates')
        .select('id, professional_id, date, start_time, end_time, slot_minutes')
        .eq('company_id', state.profile.company_id)
        .eq('id', id).maybeSingle();

      if(error || !data) return toastMsg('err','Erro ao abrir hor√°rio por data.');

      openModal(
        'Editar Hor√°rio (por data)',
        `
          <div class="row2">
            <div>
              <label>Profissional</label>
              <select id="whd_e_pro">
                ${state.pros.filter(p=>p.active).map(p=>`<option value="${p.id}" ${p.id===data.professional_id?"selected":""}>${p.name}</option>`).join("")}
              </select>
            </div>
            <div>
              <label>Data</label>
              <input id="whd_e_date" type="date" value="${data.date}"/>
            </div>
          </div>
          <div class="row2">
            <div><label>In√≠cio</label><input id="whd_e_start" type="time" value="${data.start_time}"/></div>
            <div><label>Fim</label><input id="whd_e_end" type="time" value="${data.end_time}"/></div>
          </div>
          <div><label>Passo (min)</label><input id="whd_e_slot" type="number" min="5" max="180" value="${data.slot_minutes}"/></div>
        `,
        `
          <button class="btn2" onclick="window.__closeModal()">Cancelar</button>
          <button class="btn" onclick="window.saveWHDate('${data.id}')">Salvar</button>
        `
      );
    };

    window.saveWHDate = async (id)=>{
      if(!state?.profile?.company_id) return toastMsg('err','Sess√£o inv√°lida (sem company_id).');

      const professional_id = document.getElementById('whd_e_pro').value;
      const date = document.getElementById('whd_e_date').value;
      const start_time = document.getElementById('whd_e_start').value;
      const end_time = document.getElementById('whd_e_end').value;
      const slot_minutes = Number(document.getElementById('whd_e_slot').value || 5);

      if(!date) return toastMsg('err','Data inv√°lida.');
      if(start_time >= end_time) return toastMsg('err','In√≠cio deve ser menor que fim.');
      if(slot_minutes < 5 || slot_minutes > 180) return toastMsg('err','Passo inv√°lido.');

      const { error } = await sb.from('working_hours_dates')
        .update({ professional_id, date, start_time, end_time, slot_minutes })
        .eq('id', id)
        .eq('company_id', state.profile.company_id);

      if(error){
        console.error(error);
        return toastMsg('err','Erro ao salvar hor√°rio por data.');
      }
      toastMsg('ok','Hor√°rio por data atualizado.');
      closeModal();
      await loadWorkingHours();
    };

    window.deleteWHDate = async (id)=>{
      if(!state.isAdmin) return toastMsg('err','Apenas ADMIN pode excluir.');
      if(!confirm('Excluir hor√°rio por data?')) return;
      const { error } = await sb.from('working_hours_dates')
        .delete()
        .eq('id', id)
        .eq('company_id', state.profile.company_id);
      if(error){
        console.error(error);
        return toastMsg('err','Erro ao excluir hor√°rio por data.');
      }
      toastMsg('ok','Hor√°rio por data exclu√≠do.');
      await loadWorkingHours();
    };

    async function openHoursListModal(professional_id){
      if(!modalHoursList) return;
      tbodyHoursList.innerHTML = '';
      const proName = state.prosMap[professional_id] || 'Profissional';
      hoursListTitle.textContent = `Hor√°rios cadastrados ‚Ä¢ ${proName}`;

      const company_id = state.profile.company_id;
      const [a,b] = await Promise.all([
        sb.from('working_hours').select('weekday, start_time, end_time, slot_minutes').eq('company_id', company_id).eq('professional_id', professional_id).order('weekday',{ascending:true}).order('start_time',{ascending:true}),
        sb.from('working_hours_dates').select('date, start_time, end_time, slot_minutes').eq('company_id', company_id).eq('professional_id', professional_id).order('date',{ascending:true}).order('start_time',{ascending:true})
      ]);

      const wh = a.data || [];
      const wd = b.data || [];

      const all=[];
      wh.forEach(x=>all.push({ kind:'Recorrente', day: weekdayLabel(x.weekday), start:x.start_time, end:x.end_time, step:x.slot_minutes }));
      wd.forEach(x=>all.push({ kind:'Por data', day: fmtDate(x.date), start:x.start_time, end:x.end_time, step:x.slot_minutes }));

      if(!all.length){
        tbodyHoursList.innerHTML = `<tr><td colspan="5">Nenhum hor√°rio cadastrado.</td></tr>`;
      } else {
        all.forEach(r=>{
          const tr=document.createElement('tr');
          tr.innerHTML = `<td>${r.kind}</td><td>${r.day}</td><td>${r.start}</td><td>${r.end}</td><td>${r.step} min</td>`;
          tbodyHoursList.appendChild(tr);
        });
      }

      modalHoursList.style.display = 'flex';
    }



    // ----- NOVO AGENDAMENTO (com hor√°rios dispon√≠veis por profissional) -----
    function buildOptions(list, valueKey, labelKey, onlyActive=true){
      return (list||[])
        .filter(x => !onlyActive || x.active)
        .map(x => `<option value="${x[valueKey]}">${esc(x[labelKey])}</option>`)
        .join("");
    }

    // Extrai o campo de data/hora retornado pelo RPC (compat√≠vel com varia√ß√µes de nome)
    function pickSlotStart(row){
      if(!row) return null;
      return row.slot_start || row.starts_at || row.start || row.slot || row.datetime || row.time || null;
    }

    function getServiceDurationMinutes(service_id){
      const s = (state.serv||[]).find(x=>x.id===service_id);
      const d = Number(s?.duration_minutes || 0);
      return d>0 ? d : 30;
    }

    const toMin = (hhmm)=>{
      if(!hhmm) return 0;
      const [h,m] = String(hhmm).split(':');
      return (Number(h)||0)*60 + (Number(m)||0);
    };

    const minutesToHHMM = (min)=>{
      const h = String(Math.floor(min/60)).padStart(2,'0');
      const m = String(min%60).padStart(2,'0');
      return `${h}:${m}`;
    };

    async function computeAvailableSlotsFallback({ professional_id, service_id, dateISO }){
      // Fallback client-side: usa working_hours / working_hours_dates + appointments
      const company_id = state.profile.company_id;
      const duration = getServiceDurationMinutes(service_id);

      // 1) Busca hor√°rio por data (tem prioridade). Se n√£o existir, usa recorrente (weekday)
      const weekday = new Date(dateISO + 'T00:00:00').getDay();

      let blocks = [];
      try{
        const { data: wd } = await sb
          .from('working_hours_dates')
          .select('start_time,end_time,slot_minutes')
          .eq('company_id', company_id)
          .eq('professional_id', professional_id)
          .eq('date', dateISO);
        if(wd && wd.length){
          blocks = wd.map(x=>({start:x.start_time, end:x.end_time, step:Number(x.slot_minutes||5)}));
        }
      } catch(e){ /* tabela pode n√£o existir */ }

      if(!blocks.length){
        const { data: wh } = await sb
          .from('working_hours')
          .select('start_time,end_time,slot_minutes')
          .eq('company_id', company_id)
          .eq('professional_id', professional_id)
          .eq('weekday', weekday);
        blocks = (wh||[]).map(x=>({start:x.start_time, end:x.end_time, step:Number(x.slot_minutes||5)}));
      }

      if(!blocks.length) return [];

      // 2) Busca agendamentos do dia
      const range = dayRangeISO(dateISO);
      const { data: appts } = await sb
        .from('appointments')
        .select('starts_at, ends_at, status')
        .eq('company_id', company_id)
        .eq('professional_id', professional_id)
        .gte('starts_at', range.start)
        .lt('starts_at', range.end);

      const busy = (appts||[])
        .filter(a=>String(a.status||'').toLowerCase() !== 'cancelled')
        .map(a=>({
          start: new Date(a.starts_at).getTime(),
          end: new Date(a.ends_at || a.starts_at).getTime()
        }));

      const slots=[];
      const dateBase = new Date(dateISO + 'T00:00:00');

      for(const b of blocks){
        const step = Math.max(5, Number(b.step||5));
        const startMin = toMin(b.start);
        const endMin = toMin(b.end);

        for(let t=startMin; t+duration<=endMin; t+=step){
          const start = new Date(dateBase);
          start.setMinutes(t);
          start.setSeconds(0,0);
          const end = new Date(start.getTime() + duration*60000);

          const sMs = start.getTime();
          const eMs = end.getTime();

          const overlaps = busy.some(x => (sMs < x.end) && (eMs > x.start));
          if(!overlaps){
            slots.append(start.toISOString());
          }
        }
      }

      // unique + sort
      return Array.from(new Set(slots)).sort();
    }

    async function openNewAppointmentModal(){
      if(!state?.profile?.company_id) return toastMsg("err","Sess√£o inv√°lida (sem company_id).");
      if(!(state.pros||[]).length || !(state.serv||[]).length){
        await loadMaps();
      }

      const defaultDate = agendaDate.value || todayISO();

      const body = `
        <div class="row2">
          <div>
            <label>Profissional</label>
            <select id="na_pro">
              <option value="">Selecione</option>
              ${buildOptions(state.pros, "id", "name", true)}
            </select>
          </div>
          <div>
            <label>Servi√ßo</label>
            <select id="na_serv">
              <option value="">Selecione</option>
              ${buildOptions(state.serv, "id", "name", true)}
            </select>
          </div>
        </div>

        <div class="row2" style="margin-top:8px">
          <div>
            <label>Data</label>
            <input id="na_date" type="date" value="${defaultDate}" />
          </div>
          <div>
            <label>Telefone do cliente</label>
            <input id="na_phone" placeholder="DDD + n√∫mero" />
          </div>
        </div>

        <div style="margin-top:8px">
          <label>Cliente cadastrado (opcional)</label>
          <div style="position:relative">
            <input id="na_cust_search" placeholder="Buscar por nome ou telefone" autocomplete="off" />
            <div id="na_cust_list" style="position:absolute;left:0;right:0;top:calc(100% + 6px);z-index:60;display:none;max-height:220px;overflow:auto;border-radius:14px;border:1px solid rgba(255,255,255,.14);background: rgba(15,10,20,.98);backdrop-filter: blur(10px);"></div>
          </div>
          <div class="muted" style="font-size:12px;margin-top:6px">Selecione um cliente para preencher nome e telefone automaticamente, ou deixe em branco para cadastrar um novo cliente.</div>
          <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
            <button class="btn2" id="na_use_new" type="button">Cadastrar novo cliente</button>
          </div>
        </div>

        <div style="margin-top:8px">
          <label>Nome do cliente</label>
          <input id="na_name" placeholder="Nome completo" />
        </div>

        <div class="toolbar" style="margin-top:12px">
          <div class="left" style="gap:10px">
            <div style="font-weight:1000">Hor√°rios dispon√≠veis</div>
            <span id="na_dur" class="muted" style="font-size:13px">Dura√ß√£o do servi√ßo: ‚Äî</span>
            <span class="muted" style="font-size:13px">selecionar um hor√°rio cria o agendamento</span>
          </div>
          <div class="right">
            <button class="btn2" id="na_reload_slots">Carregar hor√°rios</button>
          </div>
        </div>

        <div id="na_slots" style="display:flex;flex-wrap:wrap;gap:10px;padding:10px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background: rgba(255,255,255,.03);min-height:64px"></div>
        <div id="na_msg" class="muted" style="margin-top:10px;font-size:13px"></div>
      `;

      const footer = `
        <button class="btn2" onclick="window.__closeModal()">Fechar</button>
      `;

      openModal("Novo Agendamento", body, footer);

      // Wire events after render
      const elPro = document.getElementById("na_pro");
      const elServ = document.getElementById("na_serv");
      const elDate = document.getElementById("na_date");
      const elName = document.getElementById("na_name");
      const elPhone = document.getElementById("na_phone");
      const elCustSearch = document.getElementById("na_cust_search");
      const elCustList = document.getElementById("na_cust_list");
      const elUseNew = document.getElementById("na_use_new");
      let selectedCustomer = null;

      function renderCustomerList(items){
        if(!elCustList) return;
        if(!items || !items.length){
          elCustList.style.display = 'none';
          elCustList.innerHTML = '';
          return;
        }
        elCustList.innerHTML = items.map(c=>{
          const name = esc(c.full_name || '');
          const phone = esc(c.phone || '');
          return `
            <div class="rowHover" data-id="${c.id}" style="padding:10px 12px;cursor:pointer;display:flex;justify-content:space-between;gap:12px">
              <div style="font-weight:800">${name}</div>
              <div class="muted" style="font-size:12px;white-space:nowrap">${phone || '‚Äî'}</div>
            </div>`;
        }).join('');
        elCustList.style.display = 'block';

        [...elCustList.querySelectorAll('.rowHover')].forEach(row=>{
          row.onclick = ()=>{
            const id = row.getAttribute('data-id');
            const c = items.find(x=>String(x.id)===String(id));
            if(!c) return;
            selectedCustomer = c;
            if(elCustSearch) elCustSearch.value = `${c.full_name || ''}${c.phone ? ' ‚Ä¢ ' + c.phone : ''}`;
            if(elName) elName.value = c.full_name || '';
            if(elPhone) elPhone.value = c.phone || '';
            elCustList.style.display = 'none';
            elCustList.innerHTML = '';
          };
        });
      }

      async function searchCustomersLive(){
        if(!elCustSearch) return;
        const term = (elCustSearch.value || '').trim();
        if(!term || term.length < 2){
          renderCustomerList([]);
          return;
        }
        const q = term.replace(/[%_]/g, '');
        const { data, error } = await sb
          .from('customers')
          .select('id, full_name, phone')
          .eq('company_id', state.profile.company_id)
          .or(`full_name.ilike.%${q}%,phone.ilike.%${q}%`)
          .order('full_name',{ascending:true})
          .limit(8);
        if(error){
          console.error(error);
          renderCustomerList([]);
          return;
        }
        renderCustomerList(data || []);
      }

      const searchCustomersDebounced = debounce(searchCustomersLive, 250);
      elCustSearch?.addEventListener('input', ()=>{
        selectedCustomer = null;
        searchCustomersDebounced();
      });

      // Fecha lista ao clicar fora
      document.addEventListener('click', (ev)=>{
        try{
          if(!elCustList || elCustList.style.display==='none') return;
          const t = ev.target;
          if(t === elCustSearch || elCustList.contains(t)) return;
          elCustList.style.display='none';
        }catch(e){}
      }, { capture: true });

      elUseNew?.addEventListener('click', ()=>{
        selectedCustomer = null;
        if(elCustSearch) elCustSearch.value = '';
        if(elName) elName.value = '';
        if(elPhone) elPhone.value = '';
        renderCustomerList([]);
      });

      const elSlots = document.getElementById("na_slots");
      const elMsg = document.getElementById("na_msg");
      const elReload = document.getElementById("na_reload_slots");

      const elDur = document.getElementById("na_dur");
      function updateDur(){
        const d = elServ.value ? getServiceDurationMinutes(elServ.value) : null;
        if(elDur) elDur.textContent = d ? `Dura√ß√£o do servi√ßo: ${d} min` : "Dura√ß√£o do servi√ßo: ‚Äî";
      }
      elServ.addEventListener('change', ()=>{ updateDur(); loadSlots(); });
      elPro.addEventListener('change', loadSlots);
      elDate.addEventListener('change', loadSlots);
      updateDur();

      const setMsg = (t)=>{ if(elMsg) elMsg.textContent = t || ""; };

      async function loadSlots(){
        setMsg("");
        elSlots.innerHTML = "";

        const p_professional_id = elPro.value;
        const p_service_id = elServ.value;
        const p_date = elDate.value;

        if(!p_professional_id || !p_service_id || !p_date){
          setMsg("Selecione profissional, servi√ßo e data para listar hor√°rios.");
          return;
        }

        // RPC: get_available_slots(p_professional_id, p_service_id, p_date)
        let rpcData = null;
        const rpc = await sb.rpc("get_available_slots", {
          p_professional_id,
          p_service_id,
          p_date
        });
        rpcData = rpc.data;

        if(rpc.error){
          console.error(rpc.error);
          // Fallback: calcula slots no frontend (n√£o depende de RPC) usando dura√ß√£o do servi√ßo
          try{
            rpcData = await computeAvailableSlotsFallback({ professional_id: p_professional_id, service_id: p_service_id, dateISO: p_date });
            setMsg("RPC get_available_slots indispon√≠vel; usando c√°lculo local (fallback).");
          } catch(e){
            console.error(e);
            setMsg("Erro ao buscar hor√°rios dispon√≠veis. Verifique se a RPC get_available_slots existe ou se a tabela working_hours_dates foi criada.");
            return;
          }
        }

        const slots = (rpcData||[])
          .map(pickSlotStart)
          .filter(Boolean);

        if(!slots.length){
          setMsg("Nenhum hor√°rio dispon√≠vel para este profissional nesta data.");
          return;
        }

        // Render buttons
        slots.forEach(iso=>{
          const hhmm = fmtTime(iso);
          const btn = document.createElement("button");
          btn.className = "btn2";
          btn.textContent = hhmm;
          btn.style.minWidth = "90px";
          btn.onclick = ()=> createAppointment(iso);
          elSlots.appendChild(btn);
        });

        setMsg(`Total de hor√°rios livres: ${slots.length}`);
      }

      async function createAppointment(p_starts_at){
        setMsg("");

        const p_professional_id = elPro.value;
        const p_service_id = elServ.value;

        // Cliente: pode ser selecionado (cadastrado) ou digitado (novo)
        let p_customer_name = (elName.value||"").trim();
        let p_customer_phone = (elPhone.value||"").trim();

        if(selectedCustomer){
          p_customer_name = (selectedCustomer.full_name || p_customer_name || '').trim();
          p_customer_phone = (selectedCustomer.phone || p_customer_phone || '').trim();
        }

        if(!p_professional_id || !p_service_id) return setMsg("Selecione profissional e servi√ßo.");
        if(!p_customer_name || p_customer_name.length < 2) return setMsg("Informe o nome do cliente.");

        // Garante que cliente novo seja salvo (sem duplicar por telefone)
        try{
          if(!selectedCustomer){
            const phoneKey = (p_customer_phone||'').replace(/\D/g,'');
            let existing = null;
            if(phoneKey && phoneKey.length >= 8){
              const chk = await sb
                .from('customers')
                .select('id, full_name, phone')
                .eq('company_id', state.profile.company_id)
                .eq('phone', p_customer_phone)
                .maybeSingle();
              if(!chk.error) existing = chk.data;
            }
            if(existing){
              selectedCustomer = existing;
            } else {
              const payloadCust = {
                company_id: state.profile.company_id,
                full_name: p_customer_name,
                phone: p_customer_phone || null
              };
              const insCust = await sb.from('customers').insert(payloadCust).select('id, full_name, phone').single();
              if(!insCust.error && insCust.data){
                selectedCustomer = insCust.data;
              }
            }
          }
        } catch(e){
          // N√£o bloqueia o agendamento se o cadastro do cliente falhar (por RLS/colunas), mas registra no console
          console.error(e);
        }
        // telefone pode ser vazio, mas √© recomendado
        // Desabilita bot√µes para evitar clique duplo
        [...elSlots.querySelectorAll("button")].forEach(b=>b.disabled = true);

        const { data, error } = await sb.rpc("create_appointment", {
          p_professional_id,
          p_service_id,
          p_customer_name,
          p_customer_phone,
          p_starts_at
        });

        if(error){
          console.error(error);

          const msg = String(error?.message || '').toLowerCase();
          const isMissingRpc = msg.includes('function') && msg.includes('create_appointment');

          if(isMissingRpc){
            // Fallback: inserir direto em appointments (se o RLS permitir)
            try{
              const duration = getServiceDurationMinutes(p_service_id);
              const starts = new Date(p_starts_at);
              const ends = new Date(starts.getTime() + duration*60000);

              const payload = {
                company_id: state.profile.company_id,
                professional_id: p_professional_id,
                service_id: p_service_id,
                customer_name: p_customer_name,
                customer_phone: p_customer_phone || null,
                starts_at: starts.toISOString(),
                ends_at: ends.toISOString(),
                status: 'confirmed'
              };

              const ins = await sb.from('appointments').insert(payload);
              if(ins.error) throw ins.error;

              toastMsg('ok','Agendamento criado (fallback).');
              await loadAgenda();
              await loadDashboard();
              await loadDashboardOverview();
              await loadCounts();
              await loadSlots();
              return;
            } catch(e){
              console.error(e);
              toastMsg('err','N√£o foi poss√≠vel agendar (fallback). Verifique pol√≠ticas/RLS e campos da tabela appointments.');
              [...elSlots.querySelectorAll('button')].forEach(b=>b.disabled = false);
              return;
            }
          }

          // Caso cl√°ssico: unique violation / slot ocupado no exato momento
          toastMsg("err","N√£o foi poss√≠vel agendar: hor√°rio pode ter sido ocupado. Recarregue os hor√°rios.");
          [...elSlots.querySelectorAll("button")].forEach(b=>b.disabled = false);
          return;
        }

        toastMsg("ok","Agendamento criado com sucesso.");
        // Atualiza agenda e KPIs
        await loadAgenda();
        await loadDashboard();
        await loadDashboardOverview();
        await loadCounts();

        // Recarrega slots para "sumir" o hor√°rio rec√©m-ocupado
        await loadSlots();
      }

      elReload?.addEventListener("click", loadSlots);
      elPro?.addEventListener("change", loadSlots);
      elServ?.addEventListener("change", loadSlots);
      elDate?.addEventListener("change", loadSlots);

      // Carrega automaticamente se j√° houver dados preenchidos
      await loadSlots();
    }
    window.__closeModal = closeModal;


    // =========================
    // M√ìDULO LOCAL: PRODUTOS / ESTOQUE / PDV / COMANDA
    // - Enquanto n√£o conectamos ao Supabase, tudo fica salvo no navegador (localStorage)
    // =========================
    
    function ensureLocal(){
      if(!state.local || typeof state.local !== "object"){
        state.local = {
          products: [],
          stock: {},
          movements: [],
          carts: { pdv: [] },
          apptItems: {},
          sales: []
        };
      } else {
        state.local.products = state.local.products || [];
        state.local.stock = state.local.stock || {};
        state.local.movements = state.local.movements || [];
        state.local.carts = state.local.carts || { pdv: [] };
        state.local.carts.pdv = state.local.carts.pdv || [];
        state.local.apptItems = state.local.apptItems || {};
        state.local.sales = state.local.sales || [];
      }
      return state.local;
    }

    const LS_KEY = "agendapro_local_v1";
    function loadLocal(){
      ensureLocal();
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return;
        const parsed = JSON.parse(raw);
        if(parsed && typeof parsed === "object"){
          state.local = Object.assign(state.local, parsed);
        }
      } catch(e){ /* ignore */ }
    }
    function saveLocal(){
      ensureLocal();
      try{ localStorage.setItem(LS_KEY, JSON.stringify(state.local)); } catch(e){ /* ignore */ }
    }
    function uid(){
      try { return crypto.randomUUID(); } catch(e){ return (Date.now().toString(16) + Math.random().toString(16).slice(2)); }
    }
    function localMoney(cents){
      return (Number(cents||0)/100).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
    }
    function ensureStockRow(product_id){
      ensureLocal();
      if(!state.local.stock) state.local.stock = {};
      if(!state.local.stock[product_id]) state.local.stock[product_id] = { qty: 0, min_qty: 0 };
      return state.local.stock[product_id];
    }
    function productById(id){ return (state.local.products||[]).find(p=>p.id===id) || null; }
    function recalcLocalBadges(){
      if(badgeProdutos) badgeProdutos.textContent = String((state.local.products||[]).length);
      if(badgeEstoque) badgeEstoque.textContent = String(Object.keys(state.local.stock||{}).length);
      if(badgePDV) badgePDV.textContent = String((state.local.carts?.pdv||[]).length);
    }
    function seedLocalIfEmpty(){
      ensureLocal();
      // IMPORTANTE:
      // - Os 3 produtos "pr√©-cadastrados" eram apenas para facilitar o 1¬∫ teste.
      // - Antes, quando voc√™ apagava o √∫ltimo produto, essa fun√ß√£o "recriava" tudo de novo.
      // - Agora ela roda NO M√ÅXIMO 1 vez por navegador (flag persisted).
      const seededKey = LS_KEY + ":seeded";
      if(localStorage.getItem(seededKey) === "1") return;

      // Se j√° existe qualquer produto (criado por voc√™), marca como seeded e sai
      if((state.local.products||[]).length){
        try{ localStorage.setItem(seededKey,"1"); }catch(e){}
        return;
      }

      const p1 = { id: uid(), name: "√Ågua com g√°s", barcode: "789000000001", price_cents: 400, active: true };
      const p2 = { id: uid(), name: "Refrigerante lata", barcode: "789000000002", price_cents: 600, active: true };
      const p3 = { id: uid(), name: "Cerveja long neck", barcode: "789000000003", price_cents: 900, active: true };
      state.local.products = [p1,p2,p3];
      ensureStockRow(p1.id).qty = 10;
      ensureStockRow(p2.id).qty = 10;
      ensureStockRow(p3.id).qty = 10;

      try{ localStorage.setItem(seededKey,"1"); }catch(e){}
      saveLocal();
    }

    // ---------- PRODUTOS ----------
    function loadLocalProducts(){
      loadLocal(); seedLocalIfEmpty(); recalcLocalBadges();
      const term = (prodSearch?.value||"").trim().toLowerCase();
      const list = (state.local.products||[])
        .filter(p => !term || (p.name||"").toLowerCase().includes(term) || String(p.barcode||"").toLowerCase().includes(term))
        .sort((a,b)=> (a.name||"").localeCompare(b.name||""));
      tbodyProducts.innerHTML = "";
      if(!list.length){
        tbodyProducts.innerHTML = `<tr><td colspan="5">Nenhum produto cadastrado.</td></tr>`;
        return;
      }
      list.forEach(p=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${esc(p.name||"‚Äî")}</td>
          <td>${esc(p.barcode||"‚Äî")}</td>
          <td>${localMoney(p.price_cents||0)}</td>
          <td>${p.active ? `<span class="tag ok">Ativo</span>` : `<span class="tag bad">Inativo</span>`}</td>
          <td>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn2" onclick="openProductModal('${p.id}')">Editar</button>
              <button class="btn2" onclick="toggleProduct('${p.id}')">${p.active ? "Inativar" : "Ativar"}</button>
              ${state.isAdmin ? `<button class="btn2 btnDanger" onclick="deleteProduct('${p.id}')">Excluir</button>` : ""}
            </div>
          </td>
        `;
        tbodyProducts.appendChild(tr);
      });
    }
    function openProductModal(id){
      loadLocal();
      const isEdit = !!id;
      let p = isEdit ? productById(id) : null;
      p = p || { id:null, name:"", barcode:"", price_cents:0, active:true };
      openModal(
        isEdit ? "Editar Produto" : "Novo Produto",
        `
          <div class="row2">
            <div><label>Nome</label><input id="lp_name" value="${esc(p.name)}" /></div>
            <div><label>C√≥digo / Barras</label><input id="lp_barcode" value="${esc(p.barcode||"")}" /></div>
          </div>
          <div class="row2" style="margin-top:8px">
            <div><label>Pre√ßo (R$)</label><input id="lp_price" type="number" step="0.01" value="${(Number(p.price_cents||0)/100).toFixed(2)}" /></div>
            <div>
              <label>Status</label>
              <select id="lp_active">
                <option value="true" ${p.active?"selected":""}>Ativo</option>
                <option value="false" ${!p.active?"selected":""}>Inativo</option>
              </select>
            </div>
          </div>
          <div class="muted" style="font-size:13px;margin-top:10px">Estoque √© gerenciado na aba <b>Estoque</b>.</div>
        `,
        `
          <button class="btn2" onclick="window.__closeModal()">Cancelar</button>
          <button class="btn" onclick="saveProduct('${p.id||""}')">${isEdit ? "Salvar" : "Cadastrar"}</button>
        `
      );
    }
    window.openProductModal = openProductModal;

    function saveProduct(id){
      const name = (document.getElementById("lp_name").value||"").trim();
      const barcode = (document.getElementById("lp_barcode").value||"").trim() || null;
      const price = Number(document.getElementById("lp_price").value||0);
      const price_cents = Math.round(price*100);
      const active = document.getElementById("lp_active").value === "true";
      if(name.length < 2) return toastMsg("err","Nome do produto inv√°lido.");
      if(price_cents < 0) return toastMsg("err","Pre√ßo inv√°lido.");
      loadLocal();
      if(id){
        const idx = (state.local.products||[]).findIndex(p=>p.id===id);
        if(idx >= 0) state.local.products[idx] = Object.assign({}, state.local.products[idx], { name, barcode, price_cents, active });
      } else {
        const newId = uid();
        state.local.products.push({ id:newId, name, barcode, price_cents, active:true });
        ensureStockRow(newId);
      }
      saveLocal();
      closeModal();
      toastMsg("ok", id ? "Produto atualizado." : "Produto cadastrado.");
      loadLocalProducts();
      loadLocalStock();
      renderPdvProducts();
      recalcLocalBadges();
    }
    window.saveProduct = saveProduct;

    function toggleProduct(id){
      loadLocal();
      const p = productById(id);
      if(!p) return;
      p.active = !p.active;
      saveLocal();
      loadLocalProducts();
      renderPdvProducts();
    }
    window.toggleProduct = toggleProduct;

    function deleteProduct(id){
      if(!state.isAdmin) return toastMsg("err","Apenas ADMIN pode excluir.");
      if(!confirm("Excluir produto?")) return;
      loadLocal();
      state.local.products = (state.local.products||[]).filter(p=>p.id!==id);
      if(state.local.stock) delete state.local.stock[id];
      state.local.carts.pdv = (state.local.carts?.pdv||[]).filter(i=>i.product_id!==id);
      if(state.local.apptItems){
        Object.keys(state.local.apptItems).forEach(k=>{
          state.local.apptItems[k] = (state.local.apptItems[k]||[]).filter(i=>i.product_id!==id);
        });
      }
      saveLocal();
      toastMsg("ok","Produto exclu√≠do.");
      loadLocalProducts();
      loadLocalStock();
      renderPdvProducts();
      renderPdvCart();
      recalcLocalBadges();
    }
    window.deleteProduct = deleteProduct;

    // ---------- ESTOQUE ----------
    function stockStatusTag(qty, min){
      if(qty <= 0) return `<span class="tag bad">Sem estoque</span>`;
      if(qty <= (min||0)) return `<span class="tag warn">Baixo</span>`;
      return `<span class="tag ok">OK</span>`;
    }
    function loadLocalStock(){
      loadLocal(); seedLocalIfEmpty(); recalcLocalBadges();
      const term = (stockSearch?.value||"").trim().toLowerCase();
      const rows = (state.local.products||[])
        .map(p=>({ p, qty: Number(ensureStockRow(p.id).qty||0), min_qty: Number(ensureStockRow(p.id).min_qty||0) }))
        .filter(x => !term || (x.p.name||"").toLowerCase().includes(term) || String(x.p.barcode||"").toLowerCase().includes(term))
        .sort((a,b)=> (a.p.name||"").localeCompare(b.p.name||""));
      tbodyStock.innerHTML = "";
      if(!rows.length){
        tbodyStock.innerHTML = `<tr><td colspan="5">Nenhum item de estoque.</td></tr>`;
        return;
      }
      rows.forEach(r=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${esc(r.p.name||"‚Äî")}</td>
          <td><b>${r.qty}</b></td>
          <td>${r.min_qty}</td>
          <td>${stockStatusTag(r.qty, r.min_qty)}</td>
          <td><button class="btn2" onclick="openStockAdjust('${r.p.id}')">Ajustar</button></td>
        `;
        tbodyStock.appendChild(tr);
      });
    }
    function openStockMovement(type){
      loadLocal();
      const opts = (state.local.products||[]).filter(p=>p.active).map(p=>`<option value="${p.id}">${esc(p.name)}</option>`).join("");
      const isIn = type === "in";
      openModal(
        isIn ? "Entrada de Estoque" : "Sa√≠da de Estoque",
        `
          <div class="row2">
            <div>
              <label>Produto</label>
              <select id="sm_prod"><option value="">Selecione</option>${opts}</select>
            </div>
            <div>
              <label>Quantidade</label>
              <input id="sm_qty" type="number" step="1" min="1" value="1" />
            </div>
          </div>
          <div style="margin-top:8px">
            <label>Motivo</label>
            <input id="sm_reason" placeholder="${isIn ? "compra, reposi√ß√£o..." : "consumo, perda..." }" />
          </div>
        `,
        `
          <button class="btn2" onclick="window.__closeModal()">Cancelar</button>
          <button class="btn" onclick="saveStockMovement('${type}')">Salvar</button>
        `
      );
    }
    window.openStockMovement = openStockMovement;

    function saveStockMovement(type){
      const product_id = document.getElementById("sm_prod").value;
      const qty = Number(document.getElementById("sm_qty").value||0);
      const reason = (document.getElementById("sm_reason").value||"").trim() || null;
      if(!product_id) return toastMsg("err","Selecione um produto.");
      if(!(qty>0)) return toastMsg("err","Quantidade inv√°lida.");
      loadLocal();
      const row = ensureStockRow(product_id);
      const current = Number(row.qty||0);
      const next = type==="in" ? (current + qty) : (current - qty);
      if(type==="out" && next < 0) return toastMsg("err","Saldo insuficiente para sa√≠da.");
      row.qty = next;
      state.local.movements.push({ id: uid(), type, product_id, qty, reason, created_at: new Date().toISOString() });
      saveLocal();
      closeModal();
      toastMsg("ok","Estoque atualizado.");
      loadLocalStock();
      renderPdvProducts();
    }
    window.saveStockMovement = saveStockMovement;

    function openStockAdjust(product_id){
      loadLocal();
      const p = productById(product_id);
      const s = ensureStockRow(product_id);
      openModal(
        "Ajustar Estoque",
        `
          <div style="font-weight:1000">${esc(p?.name||"Produto")}</div>
          <div class="row2" style="margin-top:10px">
            <div><label>Saldo atual</label><input disabled value="${Number(s.qty||0)}" /></div>
            <div><label>Novo saldo</label><input id="sa_qty" type="number" step="1" min="0" value="${Number(s.qty||0)}" /></div>
          </div>
          <div class="row2" style="margin-top:8px">
            <div><label>M√≠nimo (alerta)</label><input id="sa_min" type="number" step="1" min="0" value="${Number(s.min_qty||0)}" /></div>
            <div><label>Motivo</label><input id="sa_reason" placeholder="ajuste, invent√°rio..." /></div>
          </div>
        `,
        `
          <button class="btn2" onclick="window.__closeModal()">Cancelar</button>
          <button class="btn" onclick="saveStockAdjust('${product_id}')">Salvar</button>
        `
      );
    }
    window.openStockAdjust = openStockAdjust;

    function saveStockAdjust(product_id){
      const qty = Number(document.getElementById("sa_qty").value||0);
      const min_qty = Number(document.getElementById("sa_min").value||0);
      const reason = (document.getElementById("sa_reason").value||"").trim() || "ajuste";
      if(qty < 0 || min_qty < 0) return toastMsg("err","Valores inv√°lidos.");
      loadLocal();
      const row = ensureStockRow(product_id);
      const prev = Number(row.qty||0);
      row.qty = qty;
      row.min_qty = min_qty;
      const delta = qty - prev;
      if(delta !== 0){
        state.local.movements.push({ id: uid(), type: delta>0 ? "in":"out", product_id, qty: Math.abs(delta), reason, created_at: new Date().toISOString() });
      }
      saveLocal();
      closeModal();
      toastMsg("ok","Ajuste salvo.");
      loadLocalStock();
      renderPdvProducts();
    }
    window.saveStockAdjust = saveStockAdjust;

    // ---------- PDV ----------
    function getCart(){
      state.local.carts = state.local.carts || { pdv: [] };
      state.local.carts.pdv = state.local.carts.pdv || [];
      return state.local.carts.pdv;
    }
    function cartTotalCents(cart){ return (cart||[]).reduce((s,i)=> s + Number(i.unit_price_cents||0)*Number(i.qty||0), 0); }

    function cartAdd(product_id, qty=1){
      loadLocal();
      const p = productById(product_id);
      if(!p || !p.active) return toastMsg("err","Produto indispon√≠vel.");
      const stock = ensureStockRow(product_id);
      if(Number(stock.qty||0) < qty) return toastMsg("err","Estoque insuficiente.");
      const cart = getCart();
      const ex = cart.find(i=>i.product_id===product_id);
      if(ex){
        if(Number(stock.qty||0) < (ex.qty + qty)) return toastMsg("err","Estoque insuficiente.");
        ex.qty += qty;
      } else {
        cart.push({ product_id, qty, unit_price_cents: Number(p.price_cents||0) });
      }
      saveLocal();
      renderPdvCart();
      recalcLocalBadges();
    }
    function cartRemove(product_id){
      loadLocal();
      state.local.carts.pdv = (getCart()||[]).filter(i=>i.product_id!==product_id);
      saveLocal();
      renderPdvCart();
      recalcLocalBadges();
    }
    function cartQty(product_id, delta){
      loadLocal();
      const cart = getCart();
      const item = cart.find(i=>i.product_id===product_id);
      if(!item) return;
      const stock = ensureStockRow(product_id);
      const next = item.qty + delta;
      if(next <= 0) return cartRemove(product_id);
      if(Number(stock.qty||0) < next) return toastMsg("err","Estoque insuficiente.");
      item.qty = next;
      saveLocal();
      renderPdvCart();
      recalcLocalBadges();
    }

    function renderPdvProducts(){
      if(!tbodyPdvProducts) return;
      loadLocal(); seedLocalIfEmpty();

      const termRaw = (pdvSearch?.value||"");
      const term = termRaw.trim().toLowerCase();

      tbodyPdvProducts.innerHTML = "";

      // Regra do PDV: s√≥ mostra a lista quando o usu√°rio pesquisar.
      const MIN_CHARS = 1;
      if(!term || term.length < MIN_CHARS){
        tbodyPdvProducts.innerHTML = `<tr><td colspan="4">Pesquise um produto para exibir resultados.</td></tr>`;
        return;
      }

      const list = (state.local.products||[])
        .filter(p=>p.active)
        .filter(p=> (p.name||"").toLowerCase().includes(term) || String(p.barcode||"").toLowerCase().includes(term))
        .sort((a,b)=> (a.name||"").localeCompare(b.name||""));

      if(!list.length){
        tbodyPdvProducts.innerHTML = `<tr><td colspan="4">Nenhum produto encontrado.</td></tr>`;
        return;
      }

      list.forEach(p=>{
        const qty = Number(ensureStockRow(p.id).qty||0);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${esc(p.name)}</td>
          <td>${localMoney(p.price_cents||0)}</td>
          <td>${qty}</td>
          <td><button class="btn2" onclick="cartAdd('${p.id}', 1)">Adicionar</button></td>
        `;
        tbodyPdvProducts.appendChild(tr);
      });
    }


    function renderPdvCart(){
      if(!tbodyPdvCart) return;
      loadLocal();
      const cart = getCart();
      tbodyPdvCart.innerHTML = "";
      if(!cart.length){
        tbodyPdvCart.innerHTML = `<tr><td colspan="5">Carrinho vazio.</td></tr>`;
        if(pdvTotal) pdvTotal.textContent = "Total: ‚Äî";
        if(pdvMsg) pdvMsg.textContent = "‚Äî";
        return;
      }
      cart.forEach(i=>{
        const p = productById(i.product_id);
        const unit = Number(i.unit_price_cents||0);
        const total = unit * Number(i.qty||0);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${esc(p?.name||"Produto")}</td>
          <td>
            <div style="display:flex;gap:6px;align-items:center">
              <button class="btn2" style="padding:6px 10px;min-height:auto" onclick="cartQty('${i.product_id}', -1)">-</button>
              <b>${i.qty}</b>
              <button class="btn2" style="padding:6px 10px;min-height:auto" onclick="cartQty('${i.product_id}', 1)">+</button>
            </div>
          </td>
          <td>${localMoney(unit)}</td>
          <td>${localMoney(total)}</td>
          <td><button class="btn2 btnDanger" onclick="cartRemove('${i.product_id}')">X</button></td>
        `;
        tbodyPdvCart.appendChild(tr);
      });
      const sub = cartTotalCents(cart);
      const disc = Math.round(Number(pdvDiscount?.value||0) * 100);
      const tot = Math.max(0, sub - (disc||0));
      if(pdvTotal) pdvTotal.textContent = `Total: ${localMoney(tot)}`;
      if(pdvMsg) pdvMsg.textContent = `Subtotal: ${localMoney(sub)} ‚Ä¢ Desconto: ${localMoney(disc||0)}`;
    }

    function fillPdvAppointmentsOfDay(){
      if(!pdvApptLink) return;
      pdvApptLink.innerHTML = `<option value="">Vincular a agendamento (opcional)</option>`;
      const appts = state.__todayAppts || [];
      appts.forEach(a=>{
        const label = `${fmtTime(a.starts_at)} ‚Ä¢ ${a.customer_name||"Cliente"} ‚Ä¢ ${state.servMap[a.service_id]||"Servi√ßo"}`;
        const opt = document.createElement("option");
        opt.value = a.id; opt.textContent = label;
        pdvApptLink.appendChild(opt);
      });
    }

    function loadPDV(){
      loadLocal(); seedLocalIfEmpty();
      renderPdvProducts();
      renderPdvCart();
      fillPdvAppointmentsOfDay();
      recalcLocalBadges();
    }
    function pdvClear(){
      loadLocal();
      state.local.carts.pdv = [];
      saveLocal();
      renderPdvCart();
      recalcLocalBadges();
    }
    async function pdvFinalize(){
      loadLocal();
      const cart = getCart();
      if(!cart.length) return toastMsg("err","Carrinho vazio.");
      const disc = Math.round(Number(pdvDiscount?.value||0) * 100);
      const sub = cartTotalCents(cart);
      const tot = Math.max(0, sub - (disc||0));

      // valida e baixa estoque
      for(const item of cart){
        const row = ensureStockRow(item.product_id);
        if(Number(row.qty||0) < Number(item.qty||0)) return toastMsg("err","Estoque insuficiente (revalide carrinho).");
      }
      for(const item of cart){
        const row = ensureStockRow(item.product_id);
        row.qty = Number(row.qty||0) - Number(item.qty||0);
        state.local.movements.push({ id: uid(), type:"out", product_id:item.product_id, qty:item.qty, reason:"venda", created_at:new Date().toISOString() });
      }

      const apptId = pdvApptLink?.value || "";
      if(apptId){
        state.local.apptItems = state.local.apptItems || {};
        state.local.apptItems[apptId] = (state.local.apptItems[apptId] || []);
        cart.forEach(i=>{
          const ex = state.local.apptItems[apptId].find(x=>x.product_id===i.product_id);
          if(ex) ex.qty += i.qty;
          else state.local.apptItems[apptId].push({ product_id:i.product_id, qty:i.qty, unit_price_cents:i.unit_price_cents });
        });
      }

      state.local.sales = state.local.sales || [];
      state.local.sales.push({
        id: uid(),
        appointment_id: apptId || null,
        payment_method: pdvPay?.value || "dinheiro",
        subtotal_cents: sub,
        discount_cents: disc,
        total_cents: tot,
        items: cart.map(i=>({ ...i })),
        created_at: new Date().toISOString()
      });
      // grava no Supabase (hist√≥rico oficial)
      try{
        const companyId = state?.profile?.company_id;
        const userId = state?.user?.id || null;
        if(companyId){
          const payload = {
            company_id: companyId,
            user_id: userId,
            appointment_id: apptId || null,
            payment_method: (pdvPay?.value || "dinheiro"),
            subtotal_cents: sub,
            discount_cents: disc,
            total_cents: tot,
            items: cart.map(i=>({ ...i })),
            created_at: new Date().toISOString()
          };
          const { error: sErr } = await sb.from("sales").insert(payload);
          if(sErr){
            console.warn("sales insert error", sErr);
            toastMsg("warn","Venda registrada localmente; falha ao salvar no Supabase.");
          }
        }
      }catch(e){
        console.warn(e);
        toastMsg("warn","Venda registrada localmente; n√£o foi poss√≠vel salvar no Supabase.");
      }


      state.local.carts.pdv = [];
      saveLocal();

      toastMsg("ok", "Venda registrada.");
      if(pdvDiscount) pdvDiscount.value = "";
      renderPdvCart();
      renderPdvProducts();
      loadLocalStock();
      recalcLocalBadges();
    }

    window.cartAdd = cartAdd;
    window.cartRemove = cartRemove;
    window.cartQty = cartQty;
    window.pdvFinalize = pdvFinalize;
    window.pdvClear = pdvClear;

    // ---------- COMANDA DO AGENDAMENTO ----------
    async function openAppointmentComanda(id){
      loadLocal();
      const companyId = state?.profile?.company_id;
      if(!companyId) return toastMsg("err","Sess√£o inv√°lida.");

      const { data: appt, error } = await sb
        .from("appointments")
        .select("id, starts_at, status, customer_name, customer_phone, professional_id, service_id")
        .eq("company_id", companyId)
        .eq("id", id)
        .maybeSingle();

      if(error || !appt) return toastMsg("err","N√£o foi poss√≠vel abrir a comanda.");

      const serviceName = state.servMap[appt.service_id] || "Servi√ßo";
      const servicePrice = Number(state.servPriceMap[appt.service_id]||0);

      const items = (state.local.apptItems?.[id] || []);
      const rows = items.map(i=>{
        const p = productById(i.product_id);
        const unit = Number(i.unit_price_cents||0);
        const total = unit * Number(i.qty||0);
        return `
          <tr>
            <td>${esc(p?.name||"Produto")}</td>
            <td>${i.qty}</td>
            <td>${localMoney(unit)}</td>
            <td>${localMoney(total)}</td>
            <td><button class="btn2 btnDanger" onclick="comandaRemoveItem('${id}','${i.product_id}')">X</button></td>
          </tr>
        `;
      }).join("");

      const subProducts = items.reduce((s,i)=> s + Number(i.unit_price_cents||0)*Number(i.qty||0), 0);
      const total = servicePrice + subProducts;

      const productOptions = (state.local.products||[]).filter(p=>p.active)
        .map(p=>`<option value="${p.id}">${esc(p.name)} ‚Ä¢ ${localMoney(p.price_cents||0)}</option>`).join("");

      openModal(
        "Comanda do Atendimento",
        `
          <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap">
            <div>
              <div style="font-weight:1000;font-size:16px;color:var(--text)">${esc(appt.customer_name||"Cliente")}</div>
              <div class="muted" style="font-size:13px;margin-top:4px">Hor√°rio: ${fmtDateTime(appt.starts_at)} ‚Ä¢ Profissional: ${esc(state.prosMap[appt.professional_id]||"‚Äî")}</div>
              <div class="muted" style="font-size:13px;margin-top:4px">Servi√ßo: <b>${esc(serviceName)}</b> (${localMoney(servicePrice)})</div>
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
              ${renderWhatsAppBtn(appt.customer_phone, appt.customer_name, true)}
              <span class="pill">Total: ${localMoney(total)}</span>
            </div>
          </div>

          <div class="toolbar" style="margin-top:12px">
            <div class="left" style="gap:10px">
              <select class="miniInput" id="ci_prod">
                <option value="">Selecione um produto</option>
                ${productOptions}
              </select>
              <input class="miniInput" id="ci_qty" type="number" step="1" min="1" value="1" style="min-width:120px"/>
            </div>
            <div class="right">
              <button class="btn2" onclick="comandaAddItem('${id}')">Adicionar</button>
            </div>
          </div>

          <div style="overflow:auto;max-height:340px">
            <table>
              <thead>
                <tr><th>Item</th><th>Qtd</th><th>Unit</th><th>Total</th><th></th></tr>
              </thead>
              <tbody>
                ${rows || `<tr><td colspan="5">Nenhum consumo lan√ßado.</td></tr>`}
              </tbody>
            </table>
          </div>

          <div class="muted" style="font-size:13px;margin-top:10px">Obs.: a comanda baixa estoque <b>ao adicionar</b>. Se preferir, podemos baixar somente no pagamento.</div>
        `,
        `
          <button class="btn2" onclick="window.__closeModal()">Fechar</button>
          <button class="btn" onclick="comandaCheckout('${id}')">Finalizar e Receber</button>
        `
      );
    }
    window.openAppointmentComanda = openAppointmentComanda;

    function comandaAddItem(apptId){
      const product_id = document.getElementById("ci_prod").value;
      const qty = Number(document.getElementById("ci_qty").value||0);
      if(!product_id) return toastMsg("err","Selecione um produto.");
      if(!(qty>0)) return toastMsg("err","Quantidade inv√°lida.");

      loadLocal();
      const p = productById(product_id);
      const stock = ensureStockRow(product_id);
      if(Number(stock.qty||0) < qty) return toastMsg("err","Estoque insuficiente.");

      stock.qty = Number(stock.qty||0) - qty;
      state.local.movements.push({ id: uid(), type:"out", product_id, qty, reason:"consumo (comanda)", created_at:new Date().toISOString(), ref: apptId });

      state.local.apptItems = state.local.apptItems || {};
      state.local.apptItems[apptId] = state.local.apptItems[apptId] || [];
      const ex = state.local.apptItems[apptId].find(i=>i.product_id===product_id);
      if(ex) ex.qty += qty;
      else state.local.apptItems[apptId].push({ product_id, qty, unit_price_cents: Number(p?.price_cents||0) });

      saveLocal();
      toastMsg("ok","Item adicionado na comanda.");
      openAppointmentComanda(apptId);
      loadLocalStock();
      renderPdvProducts();
    }
    window.comandaAddItem = comandaAddItem;

    function comandaRemoveItem(apptId, product_id){
      loadLocal();
      const items = state.local.apptItems?.[apptId] || [];
      const item = items.find(i=>i.product_id===product_id);
      if(!item) return;

      const row = ensureStockRow(product_id);
      row.qty = Number(row.qty||0) + Number(item.qty||0);
      state.local.movements.push({ id: uid(), type:"in", product_id, qty:item.qty, reason:"estorno (comanda)", created_at:new Date().toISOString(), ref: apptId });

      state.local.apptItems[apptId] = items.filter(i=>i.product_id!==product_id);
      saveLocal();
      toastMsg("ok","Item removido.");
      openAppointmentComanda(apptId);
      loadLocalStock();
      renderPdvProducts();
    }
    window.comandaRemoveItem = comandaRemoveItem;

    async function comandaCheckout(apptId){
      loadLocal();
      const items = state.local.apptItems?.[apptId] || [];
      const serviceId = (await sb.from("appointments").select("service_id, company_id").eq("id", apptId).eq("company_id", state.profile.company_id).maybeSingle()).data?.service_id;
      const servicePrice = Number(state.servPriceMap[serviceId]||0);
      const productsTotal = items.reduce((s,i)=> s + Number(i.unit_price_cents||0)*Number(i.qty||0), 0);
      const total = servicePrice + productsTotal;

      state.local.sales = state.local.sales || [];
      state.local.sales.push({
        id: uid(),
        appointment_id: apptId,
        payment_method: "dinheiro",
        subtotal_cents: total,
        discount_cents: 0,
        total_cents: total,
        items: items.map(i=>({ ...i })),
        created_at: new Date().toISOString()
      });
      saveLocal();
      toastMsg("ok","Recebimento registrado.");
      closeModal();

      // opcional: marcar como done no Supabase (se policy permitir)
      try{
        await sb.from("appointments").update({ status:"done" }).eq("id", apptId).eq("company_id", state.profile.company_id);
      } catch(e){ /* ignore */ }

      try{
        await loadAgenda();
        await loadHistory();
        await loadDashboard();
        await loadDashboardOverview();
      } catch(e){ /* ignore */ }

      // Ap√≥s finalizar, leva para o Hist√≥rico e mant√©m a comanda dispon√≠vel ao clicar no cliente.
      try{ selectTab('historico'); }catch(e){}

      recalcLocalBadges();
    }
    window.comandaCheckout = comandaCheckout;


    // Auto start
    (async ()=>{
      const { data: sess } = await sb.auth.getSession();
      if(sess?.session){
        await bootstrap();
      } else {
        resetState();
        showLogin();
      }
    })();
  </script>


<!-- MODAL: LISTA DE HOR√ÅRIOS DO PROFISSIONAL -->
<div class="modalBack" id="modalHoursList" aria-hidden="true">
  <div class="card modal" style="max-width:920px">
    <div class="modalHeader">
      <h3 id="hoursListTitle">Hor√°rios do Profissional</h3>
      <button class="btn2" id="btnCloseHoursList">Fechar</button>
    </div>
    <div class="modalBody" style="display:grid; gap:14px">
      <div class="hint" style="margin:0">
        Aqui voc√™ v√™ os hor√°rios j√° cadastrados (recorrentes por dia da semana e hor√°rios espec√≠ficos por data).
      </div>

      <div style="overflow:auto">
        <table>
          <thead>
            <tr><th>Tipo</th><th>Dia/Data</th><th>In√≠cio</th><th>Fim</th><th>Passo</th></tr>
          </thead>
          <tbody id="tbodyHoursList"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>


<!-- FeNix (Mini-IA) -->
<div id="fenix-btn" aria-label="Abrir FeNix" title="Abrir FeNix">‚ú®</div>

<div id="fenix-panel" class="fenix-hidden" role="dialog" aria-label="FeNix">
  <div class="fenix-header" id="fenix-drag-handle" title="Arraste para mover">
    <div class="fenix-title">
      <span class="fenix-badge">‚ö°</span>
      <strong>FeNix</strong>
      <span class="fenix-sub">Assistente r√°pida</span>
    </div>
    <div class="fenix-actions">
      <button id="fenix-pin" type="button" title="Fixar / Desfixar posi√ß√£o" aria-label="Fixar">üìå</button>
      <button id="fenix-clear" type="button" title="Limpar conversa" aria-label="Limpar">üßπ</button>
      <button id="fenix-close" type="button" title="Fechar" aria-label="Fechar">√ó</button>
    </div>
  </div>

  <div class="fenix-body" id="fenix-body" aria-live="polite">
    <p class="fenix-msg">Ol√° üëã Sou a <b>FeNix</b>, sua assistente inteligente. Como posso ajudar?</p>

    <div class="fenix-quick" id="fenix-quick">
      <button type="button" data-q="agendamento">Como criar um agendamento?</button>
      <button type="button" data-q="cliente">Como cadastrar um cliente?</button>
      <button type="button" data-q="servico">Como cadastrar um servi√ßo?</button>
      <button type="button" data-q="profissional">Como adicionar um profissional?</button>
      <button type="button" data-q="pdv">Como funciona o PDV?</button>
      <button type="button" data-q="produto-pdv">Como vender um produto no PDV?</button>
      <button type="button" data-q="excluir-servico">Como excluir ou desativar um servi√ßo?</button>
      <button type="button" data-q="excluir-produto">Por que n√£o consigo excluir um produto?</button>
      <button type="button" data-q="relatorio">Como imprimir relat√≥rio de vendas?</button>
      <button type="button" data-q="senha">Por que pede senha no hist√≥rico de vendas?</button>
      <button type="button" data-q="trocar-empresa">Como trocar de empresa no sistema?</button>
      <button type="button" data-q="multi">Como funciona o multi-empresa?</button>
      <button type="button" data-q="faturamento">Como ver meu faturamento do dia?</button>
      <button type="button" data-q="erro">Erro ao carregar dados, o que fazer?</button>
      <button type="button" data-q="suporte">Como falar com o suporte?</button>
    </div>
  </div>
</div>

<style>
  /* FeNix ‚Äî widget flutuante premium */
  #fenix-btn{
    position: fixed;
    right: 22px;
    bottom: 22px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    color: #fff;
    cursor: pointer;
    user-select: none;
    z-index: 99999;
    background: linear-gradient(135deg, #a855f7, #6d28d9);
    border: 1px solid rgba(255,255,255,.16);
    box-shadow: 0 18px 50px rgba(0,0,0,.45), 0 0 26px rgba(168,85,247,.28);
  }
  #fenix-btn:hover{ filter: brightness(1.05); transform: translateY(-1px); }

  #fenix-panel{
    position: fixed;
    right: 22px;
    bottom: 90px;
    width: 380px;
    max-width: calc(100vw - 18px);
    max-height: 72vh;
    display: flex;
    flex-direction: column;
    z-index: 99999;
    border-radius: 18px;
    overflow: hidden;

    background: rgba(12, 6, 18, .88);
    border: 1px solid rgba(255,255,255,.12);
    box-shadow: 0 26px 80px rgba(0,0,0,.55), 0 0 30px rgba(168,85,247,.18);
    backdrop-filter: blur(14px);
  }
  #fenix-panel.fenix-dragging{ opacity: .96; }
  .fenix-hidden{ display: none !important; }

  .fenix-header{
    padding: 10px 12px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    background: linear-gradient(180deg, rgba(168,85,247,.18), rgba(168,85,247,.06));
    cursor: grab;
  }
  #fenix-panel.pinned .fenix-header{ cursor: default; }

  .fenix-title{ display:flex; align-items:center; gap:10px; min-width:0; }
  .fenix-badge{
    width: 28px; height: 28px;
    border-radius: 10px;
    display:flex; align-items:center; justify-content:center;
    background: rgba(255,255,255,.07);
    border: 1px solid rgba(255,255,255,.12);
  }
  .fenix-sub{ font-size: 12px; opacity: .72; white-space: nowrap; }

  .fenix-actions{ display:flex; align-items:center; gap:8px; }
  .fenix-actions button{
    width: 34px;
    height: 34px;
    border-radius: 12px;
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(255,255,255,.12);
    color:#fff;
    font-size: 16px;
    cursor:pointer;
  }
  .fenix-actions button:hover{ background: rgba(255,255,255,.10); }

  .fenix-body{
    padding: 14px;
    overflow: auto;
    color: #fff;
    font-size: 14px;
  }
  .fenix-msg{
    margin: 0 0 10px 0;
    line-height: 1.35;
  }

  .fenix-quick{
    display: grid;
    gap: 8px;
  }
  .fenix-quick button{
    width: 100%;
    padding: 10px 12px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(168,85,247,.18);
    color: #fff;
    cursor: pointer;
    text-align: left;
    transition: transform .12s ease, background .12s ease, border-color .12s ease;
  }
  .fenix-quick button:hover{
    transform: translateY(-1px);
    background: rgba(168,85,247,.26);
    border-color: rgba(255,255,255,.16);
  }

  /* Mobile */
  @media (max-width: 520px){
    #fenix-panel{ width: calc(100vw - 18px); right: 9px; }
    #fenix-btn{ right: 14px; bottom: 14px; }
  }
</style>

<script>
/* =========================
   FeNix (Mini-IA local) ‚Äî Premium
   - Fecha/minimiza sem perder conversa
   - Salva estado (aberto/fechado), posi√ß√£o e hist√≥rico no localStorage
   - Arrastar para mover (desative com üìå Fixar)
   ========================= */

(function(){
  const FENIX_LS_KEY = "agendapro_fenix_v1";

  const fenixAnswers = {
    agendamento: "V√° em Agenda ‚Üí Novo agendamento ‚Üí selecione cliente, servi√ßo e hor√°rio.",
    cliente: "Abra Clientes ‚Üí Novo cliente ‚Üí preencha os dados e salve.",
    servico: "Abra Servi√ßos ‚Üí Novo servi√ßo ‚Üí defina pre√ßo e dura√ß√£o.",
    profissional: "Abra Profissionais ‚Üí Adicionar ‚Üí vincule servi√ßos.",
    pdv: "O PDV registra vendas e pagamentos de forma r√°pida.",
    "produto-pdv": "No PDV, selecione Produto ‚Üí finalize a venda.",
    "excluir-servico": "Se o servi√ßo j√° foi usado em agendamentos, ele n√£o pode ser exclu√≠do por integridade. O recomendado √© DESATIVAR (active=false).",
    "excluir-produto": "Produtos usados em vendas podem ficar bloqueados para auditoria. O recomendado √© DESATIVAR (active=false).",
    relatorio: "Abra Hist√≥rico de vendas ‚Üí filtre a data ‚Üí clique em ‚ÄúImprimir relat√≥rio‚Äù.",
    senha: "O hist√≥rico √© protegido por senha para seguran√ßa financeira e evitar acesso indevido.",
    "trocar-empresa": "Use o seletor de empresa no topo do painel (Empresa: ...).",
    multi: "Multi-empresa: cada empresa tem dados isolados por company_id (sem vazamento entre empresas).",
    faturamento: "Abra Dashboard ou Hist√≥rico de vendas e filtre a data de hoje.",
    erro: "Verifique internet, recarregue a p√°gina. Se persistir, saia e fa√ßa login novamente.",
    suporte: "Abra a aba Suporte ou use o contato informado no painel."
  };

  const fenixBtn   = document.getElementById("fenix-btn");
  const fenixPanel = document.getElementById("fenix-panel");
  const fenixBody  = document.getElementById("fenix-body");
  const btnClose   = document.getElementById("fenix-close");
  const btnClear   = document.getElementById("fenix-clear");
  const btnPin     = document.getElementById("fenix-pin");
  const dragHandle = document.getElementById("fenix-drag-handle");

  if(!fenixBtn || !fenixPanel || !fenixBody || !btnClose || !btnClear || !btnPin || !dragHandle){
    console.warn("FeNix: elementos n√£o encontrados no DOM.");
    return;
  }

  function safeParse(json){
    try { return JSON.parse(json); } catch(e){ return null; }
  }
  function loadState(){
    const raw = localStorage.getItem(FENIX_LS_KEY);
    const st = raw ? safeParse(raw) : null;
    return (st && typeof st === "object") ? st : {};
  }
  function saveState(patch){
    const cur = loadState();
    const next = Object.assign({}, cur, patch);
    try{ localStorage.setItem(FENIX_LS_KEY, JSON.stringify(next)); }catch(e){}
    return next;
  }

  function setOpen(isOpen){
    fenixPanel.classList.toggle("fenix-hidden", !isOpen);
    saveState({ open: !!isOpen });
  }

  function appendMsg(html){
    const p = document.createElement("p");
    p.className = "fenix-msg";
    p.innerHTML = html;
    fenixBody.appendChild(p);
    fenixBody.scrollTop = fenixBody.scrollHeight;
    saveConversation();
  }

  function bindQuickButtons(){
    fenixPanel.querySelectorAll(".fenix-quick button").forEach((b)=>{
      b.onclick = ()=>{
        const key = b.dataset.q || "";
        const ans = fenixAnswers[key] || "N√£o encontrei essa op√ß√£o. Tente outra pergunta do menu.";
        appendMsg("<b>FeNix:</b> " + ans);
      };
    });
  }

  function saveConversation(){
    try{
      saveState({ bodyHTML: fenixBody.innerHTML, scrollTop: fenixBody.scrollTop });
    }catch(e){}
  }


// Snapshot do menu r√°pido para que "Limpar conversa" nunca apague as op√ß√µes pr√©-programadas
const FENIX_QUICK_TEMPLATE = (() => {
  const el = document.getElementById("fenix-quick");
  return el ? el.outerHTML : "";
})();

function ensureQuickMenu(){
  if(!FENIX_QUICK_TEMPLATE) return;
  // remove menus duplicados (caso existam)
  fenixBody.querySelectorAll("#fenix-quick, .fenix-quick").forEach((n)=>{
    if(n && n.parentNode) n.parentNode.removeChild(n);
  });
  const tmp = document.createElement("div");
  tmp.innerHTML = FENIX_QUICK_TEMPLATE;
  const node = tmp.firstElementChild;
  if(node) fenixBody.appendChild(node);
  bindQuickButtons();
}

  function restoreConversation(){
    const st = loadState();
    if(st.bodyHTML && typeof st.bodyHTML === "string"){
      fenixBody.innerHTML = st.bodyHTML;
    }
    // garante menu r√°pido (sempre recriado a partir do template)
    if(!fenixBody.querySelector("#fenix-quick")){
      ensureQuickMenu();
    }else{
      bindQuickButtons();
    }
    // recoloca scroll
    const st2 = loadState();
    if(typeof st2.scrollTop === "number"){
      requestAnimationFrame(()=>{ fenixBody.scrollTop = st2.scrollTop; });
    }
  }

  function resetConversation(){
    fenixBody.innerHTML = '<p class="fenix-msg">Ol√° üëã Sou a <b>FeNix</b>, sua assistente inteligente. Como posso ajudar?</p>';
    ensureQuickMenu();
    saveState({ bodyHTML: fenixBody.innerHTML, scrollTop: 0 });
  }

  /* Drag & position */
  function applySavedPosition(){
    const st = loadState();
    if(st && st.pos && typeof st.pos.x === "number" && typeof st.pos.y === "number"){
      fenixPanel.style.left = st.pos.x + "px";
      fenixPanel.style.top  = st.pos.y + "px";
      fenixPanel.style.right = "auto";
      fenixPanel.style.bottom = "auto";
    }
    fenixPanel.classList.toggle("pinned", !!st.pinned);
  }

  function clampToViewport(x,y){
    const rect = fenixPanel.getBoundingClientRect();
    const maxX = Math.max(8, window.innerWidth - rect.width - 8);
    const maxY = Math.max(8, window.innerHeight - rect.height - 8);
    return {
      x: Math.min(Math.max(8, x), maxX),
      y: Math.min(Math.max(8, y), maxY)
    };
  }

  function enableDrag(){
    let dragging=false, startX=0, startY=0, originX=0, originY=0;

    function onDown(ev){
      if(fenixPanel.classList.contains("pinned")) return;
      const t = ev.target;
      if(t && t.tagName === "BUTTON") return;

      dragging = true;
      fenixPanel.classList.add("fenix-dragging");
      const rect = fenixPanel.getBoundingClientRect();
      originX = rect.left; originY = rect.top;
      startX = (ev.touches ? ev.touches[0].clientX : ev.clientX);
      startY = (ev.touches ? ev.touches[0].clientY : ev.clientY);

      fenixPanel.style.right = "auto";
      fenixPanel.style.bottom = "auto";
      fenixPanel.style.left = originX + "px";
      fenixPanel.style.top  = originY + "px";

      document.addEventListener("mousemove", onMove);
      document.addEventListener("mouseup", onUp);
      document.addEventListener("touchmove", onMove, { passive:false });
      document.addEventListener("touchend", onUp);
    }

    function onMove(ev){
      if(!dragging) return;
      if(ev.cancelable) ev.preventDefault();
      const cx = (ev.touches ? ev.touches[0].clientX : ev.clientX);
      const cy = (ev.touches ? ev.touches[0].clientY : ev.clientY);
      const cl = clampToViewport(originX + (cx-startX), originY + (cy-startY));
      fenixPanel.style.left = cl.x + "px";
      fenixPanel.style.top  = cl.y + "px";
    }

    function onUp(){
      if(!dragging) return;
      dragging = false;
      fenixPanel.classList.remove("fenix-dragging");
      const rect = fenixPanel.getBoundingClientRect();
      saveState({ pos: { x: Math.round(rect.left), y: Math.round(rect.top) } });

      document.removeEventListener("mousemove", onMove);
      document.removeEventListener("mouseup", onUp);
      document.removeEventListener("touchmove", onMove);
      document.removeEventListener("touchend", onUp);
    }

    dragHandle.addEventListener("mousedown", onDown);
    dragHandle.addEventListener("touchstart", onDown, { passive:true });
  }

  function init(){
    restoreConversation();
    bindQuickButtons();
    applySavedPosition();

    const st = loadState();
    setOpen(!!st.open);

    fenixBtn.onclick = ()=>{
      const hidden = fenixPanel.classList.contains("fenix-hidden");
      setOpen(hidden);
      if(hidden){
        // garante dentro da tela
        const rect = fenixPanel.getBoundingClientRect();
        if(rect.right > window.innerWidth || rect.bottom > window.innerHeight || rect.left < 0 || rect.top < 0){
          fenixPanel.style.left = "auto";
          fenixPanel.style.top = "auto";
          fenixPanel.style.right = "22px";
          fenixPanel.style.bottom = "90px";
          saveState({ pos: null });
        }
      }
    };

    btnClose.onclick = ()=>{
      saveConversation();
      setOpen(false);
    };

    btnClear.onclick = ()=>{
      if(confirm("Limpar a conversa da FeNix?")){
        resetConversation();
      }
    };

    btnPin.onclick = ()=>{
      const pinned = !fenixPanel.classList.contains("pinned");
      fenixPanel.classList.toggle("pinned", pinned);
      saveState({ pinned });
    };

    window.addEventListener("beforeunload", saveConversation);
    window.addEventListener("resize", ()=>{
      const s = loadState();
      if(s && s.pos && typeof s.pos.x === "number"){
        const cl = clampToViewport(s.pos.x, s.pos.y);
        fenixPanel.style.left = cl.x + "px";
        fenixPanel.style.top  = cl.y + "px";
        saveState({ pos: cl });
      }
    });

    enableDrag();
  }

  init();
})();
</script>


</body>
</html>
