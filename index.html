<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Agenda Online</title>

  <style>
    :root{
      --bg:#fbf7fb;
      --card:#ffffff;

      /* Mais roxo no visual */
      --primary:#ec4899;   /* rosa */
      --primary2:#7c3aed;  /* roxo mais forte */
      --primary3:#a855f7;  /* roxo */
      --purpleGlow: rgba(124,58,237,.18);

      --text:#111827;
      --muted:#6b7280;
      --border:#efe7ff;
      --shadow:0 18px 50px rgba(17,24,39,.10);
      --radius:18px;

      --okbg:#ecfdf5; --oktx:#065f46; --okbd:#a7f3d0;
      --erbg:#fff1f2; --ertx:#be123c; --erbd:#fecdd3;
      --infbg:#eff6ff; --inftx:#1d4ed8; --infbd:#bfdbfe;
      --warnbg:#fffbeb; --warntx:#92400e; --warnbd:#fde68a;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(circle at top left, rgba(124,58,237,.25), transparent 45%),
        radial-gradient(circle at bottom right, rgba(168,85,247,.22), transparent 45%),
        radial-gradient(circle at 20% 30%, rgba(236,72,153,.16), transparent 40%),
        var(--bg);
      min-height:100vh;
    }
    .center{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px}
    .card{
      width:100%;
      max-width:680px;
      background:rgba(255,255,255,.95);
      border:1px solid var(--border);
      border-radius:calc(var(--radius) + 2px);
      box-shadow:var(--shadow);
      padding:22px;
      backdrop-filter: blur(10px);
    }

    .top{
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
      margin-bottom:10px;
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logoDot{
      width:14px;height:14px;border-radius:999px;
      background:linear-gradient(90deg,var(--primary2),var(--primary3));
      box-shadow:0 18px 40px var(--purpleGlow);
      flex:0 0 auto;
      margin-top:6px;
    }
    h1{
      margin:0;
      font-size:30px;
      font-weight:950;
      line-height:1.05;
      background:linear-gradient(90deg,var(--primary2),var(--primary3),var(--primary));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }
    .sub{
      color:var(--muted);
      margin:8px 0 0;
      font-size:14px;
      line-height:1.45;
    }

    .pill{
      border:1px solid var(--border);
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      color:var(--muted);
      background:rgba(255,255,255,.75);
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
      height:fit-content;
      box-shadow:0 10px 30px rgba(124,58,237,.08);
    }
    .lock{
      width:10px;height:10px;border-radius:3px;
      background:linear-gradient(90deg,var(--primary2),var(--primary3));
      display:inline-block;
    }

    .benefits{
      margin:14px 0 16px;
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(124,58,237,.06), rgba(255,255,255,.7));
      border-radius:16px;
      padding:12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .benefit{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:10px;
      border-radius:14px;
      border:1px dashed rgba(124,58,237,.18);
      background:rgba(255,255,255,.88);
    }
    .ico{
      width:30px;height:30px;border-radius:12px;
      display:flex;align-items:center;justify-content:center;
      background:linear-gradient(90deg,rgba(124,58,237,.14),rgba(168,85,247,.14));
      border:1px solid rgba(124,58,237,.15);
      flex:0 0 auto;
      font-weight:900;
      color:#6d28d9;
    }
    .benefit b{display:block;font-size:13px}
    .benefit span{display:block;color:var(--muted);font-size:12px;margin-top:2px}

    .section{
      margin-top:14px;
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      background:linear-gradient(180deg, rgba(124,58,237,.05), rgba(255,255,255,.78));
    }
    .sectionTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:6px;
    }
    .sectionTitle h2{
      margin:0;
      font-size:14px;
      font-weight:950;
      color:#111827;
      letter-spacing:.2px;
    }
    .hint{font-size:12px;color:var(--muted)}

    .grid2{display:grid;grid-template-columns: 1fr 1fr;gap:12px}
    @media (max-width:640px){
      .benefits{grid-template-columns:1fr}
      .grid2{grid-template-columns:1fr}
      .top{flex-direction:column;align-items:flex-start}
      .pill{width:100%;justify-content:center}
    }

    label{font-size:12px;color:var(--muted);display:block;margin-top:10px}
    select,input{
      width:100%;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--border);
      margin-top:6px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    input:focus,select:focus{
      border-color:#c4b5fd;
      box-shadow:0 0 0 4px rgba(124,58,237,.12);
    }

    .helperRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
      align-items:center;
      justify-content:space-between;
    }
    .meta{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .badge{
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(124,58,237,.18);
      color:#374151;
      background:rgba(255,255,255,.9);
    }
    .badge strong{font-weight:950}
    .badge.muted{color:var(--muted);border-color:var(--border)}
    .badge .star{color:#f59e0b}

    /* Dias dispon√≠veis (chips) */
    .daysBar{
      margin-top:10px;
      border:1px solid rgba(124,58,237,.18);
      border-radius:16px;
      background:rgba(255,255,255,.88);
      padding:10px;
    }
    .daysTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .daysTop b{
      font-size:12px;
      color:#111827;
    }
    .daysHint{
      font-size:12px;
      color:var(--muted);
    }
    .daysChips{
      display:flex;
      gap:8px;
      overflow:auto;
      padding-bottom:2px;
      scrollbar-width: thin;
    }
    .dayChip{
      border:1px solid var(--border);
      background:#fff;
      border-radius:14px;
      padding:10px 10px;
      min-width:112px;
      cursor:pointer;
      user-select:none;
      transition: transform .06s ease, background .12s ease, border-color .12s ease;
    }
    .dayChip:hover{transform: translateY(-1px);border-color:rgba(124,58,237,.30)}
    .dayChip .d1{font-weight:950;font-size:12px;color:#111827}
    .dayChip .d2{font-size:12px;color:var(--muted);margin-top:2px}
    .dayChip .d3{font-size:12px;margin-top:6px;color:#6d28d9;font-weight:900}
    .dayChip.disabled{
      opacity:.55;
      cursor:not-allowed;
    }
    .dayChip.active{
      border-color:transparent;
      background:linear-gradient(90deg,var(--primary2),var(--primary3));
      box-shadow:0 16px 40px rgba(124,58,237,.18);
    }
    .dayChip.active .d1,
    .dayChip.active .d2,
    .dayChip.active .d3{color:#fff}

    .slots{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(98px,1fr));
      gap:10px;
      margin-top:12px;
    }
    .slot{
      padding:10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      text-align:center;
      cursor:pointer;
      font-weight:950;
      user-select:none;
      transition: transform .06s ease, background .12s ease;
    }
    .slot:hover{background:#faf5ff;transform: translateY(-1px)}
    .slot.active{
      background:linear-gradient(90deg,var(--primary2),var(--primary3));
      color:#fff;
      border-color:transparent;
    }

    .btn{
      width:100%;
      border:0;
      padding:14px;
      border-radius:14px;
      font-weight:950;
      cursor:pointer;
      color:#fff;
      background:linear-gradient(90deg,var(--primary2),var(--primary3),var(--primary));
      margin-top:14px;
      letter-spacing:.2px;
      box-shadow:0 16px 35px rgba(124,58,237,.18);
    }
    .btn:disabled{opacity:.6;cursor:not-allowed;box-shadow:none}

    .msg{
      margin-top:12px;
      padding:12px;
      border-radius:14px;
      font-size:14px;
      display:none;
      border:1px solid transparent;
      line-height:1.4;
    }
    .ok{background:var(--okbg);color:var(--oktx);border-color:var(--okbd)}
    .err{background:var(--erbg);color:var(--ertx);border-color:var(--erbd)}
    .info{background:var(--infbg);color:var(--inftx);border-color:var(--infbd)}
    .warn{background:var(--warnbg);color:var(--warntx);border-color:var(--warnbd)}
    .mini{
      font-size:12px;
      color:var(--muted);
      margin-top:12px;
      text-align:center;
      line-height:1.4;
    }

    .summary{
      margin-top:12px;
      border:1px solid rgba(124,58,237,.18);
      border-radius:16px;
      padding:12px;
      background:rgba(255,255,255,.9);
      display:none;
    }
    .summary h3{
      margin:0 0 8px;
      font-size:13px;
      font-weight:950;
    }
    .sumGrid{display:grid;grid-template-columns: 1fr 1fr;gap:10px}
    .sumItem{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
      background:#fff;
      font-size:12px;
      color:#374151;
    }
    .sumItem b{display:block;font-size:12px;color:#111827;margin-bottom:3px}
    @media (max-width:640px){ .sumGrid{grid-template-columns:1fr} }

    .smallNote{font-size:12px;color:var(--muted);margin-top:10px}
  </style>
</head>

<body>
<div class="center">
  <div class="card">

    <div class="top">
      <div class="brand">
        <span class="logoDot"></span>
        <div>
          <h1>Agende seu atendimento com praticidade e inova√ß√£o</h1>
          <div class="sub">
            Escolha o servi√ßo, o profissional ideal e o melhor hor√°rio em poucos cliques.
            R√°pido, simples e totalmente online.
          </div>
        </div>
      </div>

      <div class="pill" title="Seguran√ßa e privacidade">
        <span class="lock"></span>
        Seus dados est√£o protegidos
      </div>
    </div>

    <div class="benefits">
      <div class="benefit">
        <div class="ico">‚è±</div>
        <div><b>Agendamento r√°pido</b><span>Fluxo simples e objetivo, sem complica√ß√µes.</span></div>
      </div>
      <div class="benefit">
        <div class="ico">üìÖ</div>
        <div><b>Hor√°rios em tempo real</b><span>Mostramos apenas hor√°rios dispon√≠veis.</span></div>
      </div>
      <div class="benefit">
        <div class="ico">‚úÖ</div>
        <div><b>Confirma√ß√£o imediata</b><span>Ao confirmar, o sistema registra e reserva o hor√°rio.</span></div>
      </div>
      <div class="benefit">
        <div class="ico">üì≤</div>
        <div><b>WhatsApp para confirma√ß√£o</b><span>Usamos seu n√∫mero apenas para confirmar.</span></div>
      </div>
    </div>

    <!-- SE√á√ÉO 1 -->
    <div class="section">
      <div class="sectionTitle">
        <h2>1) Sobre o atendimento</h2>
        <div class="hint">Defina o servi√ßo e o profissional.</div>
      </div>

      <div class="grid2">
        <div>
          <label for="service">Servi√ßo</label>
          <select id="service"></select>
        </div>

        <div>
          <label for="professional">Profissional</label>
          <select id="professional"></select>
        </div>
      </div>

      <div class="helperRow">
        <div class="meta">
          <div class="badge muted" id="metaDuration">‚è≥ Dura√ß√£o: ‚Äî</div>
          <div class="badge" id="metaRating"><span class="star">‚≠ê</span> Avalia√ß√£o: ‚Äî</div>
        </div>
        <div class="hint" id="metaServiceName"></div>
      </div>

      <div class="smallNote">
        Ap√≥s escolher o servi√ßo e o profissional, veja os pr√≥ximos dias dispon√≠veis e selecione um hor√°rio.
      </div>
    </div>

    <!-- SE√á√ÉO 2 -->
    <div class="section">
      <div class="sectionTitle">
        <h2>2) Dias e hor√°rios dispon√≠veis</h2>
        <div class="hint">Escolha o dia e depois o hor√°rio.</div>
      </div>

      <div class="grid2">
        <div>
          <label for="date">Data (opcional)</label>
          <input type="date" id="date" />
        </div>

        <div>
          <label>Status do agendamento</label>
          <input id="statusField" value="Aguardando sele√ß√£o..." readonly />
        </div>
      </div>

      <!-- NOVO: dias dispon√≠veis -->
      <div class="daysBar">
        <div class="daysTop">
          <b>Pr√≥ximos dias com disponibilidade</b>
          <div class="daysHint" id="daysHint">Selecione servi√ßo e profissional para carregar.</div>
        </div>
        <div id="daysChips" class="daysChips"></div>
      </div>

      <!-- Hor√°rios -->
      <div id="slots" class="slots"></div>

      <div class="smallNote" id="slotsNote">
        Mostramos apenas hor√°rios dispon√≠veis em tempo real.
      </div>
    </div>

    <!-- SE√á√ÉO 3 -->
    <div class="section">
      <div class="sectionTitle">
        <h2>3) Seus dados para confirma√ß√£o</h2>
        <div class="hint">Usaremos apenas para confirmar o atendimento.</div>
      </div>

      <div class="grid2">
        <div>
          <label for="customerName">Nome completo</label>
          <input id="customerName" placeholder="Ex: Maria Silva" autocomplete="name" />
        </div>

        <div>
          <label for="customerPhone">WhatsApp para confirma√ß√£o</label>
          <input id="customerPhone" placeholder="(00) 00000-0000" autocomplete="tel" />
        </div>
      </div>

      <button id="btnConfirm" class="btn" disabled>Confirmar agendamento agora</button>

      <div id="summary" class="summary">
        <h3>Resumo do seu agendamento</h3>
        <div class="sumGrid">
          <div class="sumItem"><b>Servi√ßo</b><span id="sumService">‚Äî</span></div>
          <div class="sumItem"><b>Profissional</b><span id="sumProf">‚Äî</span></div>
          <div class="sumItem"><b>Data</b><span id="sumDate">‚Äî</span></div>
          <div class="sumItem"><b>Hor√°rio</b><span id="sumTime">‚Äî</span></div>
        </div>
      </div>

      <div id="msgOk" class="msg ok"></div>
      <div id="msgErr" class="msg err"></div>
      <div id="msgInfo" class="msg info"></div>
      <div id="msgWarn" class="msg warn"></div>

      <div class="mini">
        Desenvolvido por <b>LEP Sistemas</b> ‚Ä¢ Agenda Online Inteligente<br/>
        Tecnologia para facilitar seu dia a dia
      </div>
    </div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // FIXO (j√° preenchido com seus dados)
  const SUPABASE_URL = "https://lbjkxslawyqbuncrnmbl.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_a6VPFRKUWl4iQsrz6LVFMA_qYLJ4p-L";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const serviceSel = document.getElementById("service");
  const profSel = document.getElementById("professional");
  const dateInput = document.getElementById("date");
  const slotsDiv = document.getElementById("slots");
  const btnConfirm = document.getElementById("btnConfirm");

  const msgOk = document.getElementById("msgOk");
  const msgErr = document.getElementById("msgErr");
  const msgInfo = document.getElementById("msgInfo");
  const msgWarn = document.getElementById("msgWarn");

  const statusField = document.getElementById("statusField");

  const metaDuration = document.getElementById("metaDuration");
  const metaRating = document.getElementById("metaRating");
  const metaServiceName = document.getElementById("metaServiceName");

  const daysChips = document.getElementById("daysChips");
  const daysHint = document.getElementById("daysHint");

  const summary = document.getElementById("summary");
  const sumService = document.getElementById("sumService");
  const sumProf = document.getElementById("sumProf");
  const sumDate = document.getElementById("sumDate");
  const sumTime = document.getElementById("sumTime");

  let selectedSlot = null;
  let COMPANY_ID = null;

  const servicesById = new Map();
  const professionalsById = new Map();

  // Avalia√ß√£o fixa (conforme pedido)
  const DEFAULT_RATING = 4.9;

  // Config: quantos dias mostrar como "dispon√≠veis"
  const DAYS_LOOKAHEAD = 14;

  function hideAllMsgs(){ [msgOk,msgErr,msgInfo,msgWarn].forEach(m=>m.style.display="none"); }
  function showOk(t){ hideAllMsgs(); msgOk.style.display="block"; msgOk.textContent=t; }
  function showErr(t){ hideAllMsgs(); msgErr.style.display="block"; msgErr.textContent=t; }
  function showInfo(t){ hideAllMsgs(); msgInfo.style.display="block"; msgInfo.textContent=t; }
  function showWarn(t){ hideAllMsgs(); msgWarn.style.display="block"; msgWarn.textContent=t; }

  function setStatus(text){ statusField.value = text; }

  function fmtTime(iso){
    const d = new Date(iso);
    return d.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});
  }
  function fmtDateBR(yyyyMmDd){
    if(!yyyyMmDd) return "‚Äî";
    const [y,m,d] = yyyyMmDd.split("-");
    return `${d}/${m}/${y}`;
  }
  function ymd(dateObj){
    const d = new Date(dateObj);
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const da = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  }
  function dowShortPt(dateObj){
    return dateObj.toLocaleDateString("pt-BR",{weekday:"short"}).replace(".","");
  }
  function monthShortPt(dateObj){
    return dateObj.toLocaleDateString("pt-BR",{month:"short"}).replace(".","");
  }

  function updateMeta(){
    const s = servicesById.get(serviceSel.value);
    const p = professionalsById.get(profSel.value);

    const durationMin = s?.duration_minutes ?? 40;
    metaDuration.textContent = `‚è≥ Dura√ß√£o: ${durationMin} min`;

    metaRating.innerHTML = `<span class="star">‚≠ê</span> Avalia√ß√£o: <strong>${DEFAULT_RATING.toFixed(1)}</strong>/5`;

    const svcName = s?.name ? `Servi√ßo: ${s.name}` : "";
    const profName = p?.name ? ` ‚Ä¢ Profissional: ${p.name}` : "";
    metaServiceName.textContent = (svcName || profName) ? `${svcName}${profName}` : "";
  }

  function updateSummary(){
    const s = servicesById.get(serviceSel.value);
    const p = professionalsById.get(profSel.value);

    sumService.textContent = s?.name ?? "‚Äî";
    sumProf.textContent = p?.name ?? "‚Äî";
    sumDate.textContent = fmtDateBR(dateInput.value);
    sumTime.textContent = selectedSlot ? fmtTime(selectedSlot) : "‚Äî";

    const canShow = !!(serviceSel.value && profSel.value);
    summary.style.display = canShow ? "block" : "none";
  }

  function resetSlotsUI(){
    slotsDiv.innerHTML = "";
    selectedSlot = null;
    btnConfirm.disabled = true;
    updateSummary();
  }

  function renderDayChips(items, activeYmd){
    daysChips.innerHTML = "";
    if(!items.length){
      daysChips.innerHTML = `<div style="color:#6b7280;font-size:12px;padding:6px 2px;">Nenhum dia dispon√≠vel no per√≠odo.</div>`;
      return;
    }

    items.forEach(it=>{
      const chip = document.createElement("div");
      chip.className = "dayChip" + (it.disabled ? " disabled" : "") + (it.ymd===activeYmd ? " active" : "");
      chip.innerHTML = `
        <div class="d1">${it.dow} ‚Ä¢ ${it.dd} ${it.mon}</div>
        <div class="d2">${it.ymd === ymd(new Date()) ? "Hoje" : "Dispon√≠vel"}</div>
        <div class="d3">${it.count} hor√°rios</div>
      `;

      if(!it.disabled){
        chip.onclick = ()=>{
          // seleciona o dia (atualiza dateInput) e carrega hor√°rios
          dateInput.value = it.ymd;
          document.querySelectorAll(".dayChip").forEach(x=>x.classList.remove("active"));
          chip.classList.add("active");
          loadSlots(); // carrega hor√°rios do dia clicado
        };
      }
      daysChips.appendChild(chip);
    });
  }

  async function fetchSlotsForDate(dateStr){
    // Busca disponibilidade via seu RPC existente
    const { data, error } = await supabase.rpc("get_available_slots",{
      p_company_id: COMPANY_ID,
      p_professional_id: profSel.value,
      p_service_id: serviceSel.value,
      p_date: dateStr
    });
    if(error) return { dateStr, count: 0, error: true };
    return { dateStr, count: (data?.length || 0), data: data || [] };
  }

  async function loadAvailableDays(){
    daysChips.innerHTML = "";
    daysHint.textContent = "Selecione servi√ßo e profissional para carregar.";

    if(!COMPANY_ID) return;
    if(!serviceSel.value || !profSel.value){
      return;
    }

    daysHint.textContent = "Carregando pr√≥ximos dias dispon√≠veis...";
    // monta lista de pr√≥ximos N dias
    const base = new Date();
    const dates = [];
    for(let i=0;i<DAYS_LOOKAHEAD;i++){
      const d = new Date(base);
      d.setDate(base.getDate()+i);
      dates.push(ymd(d));
    }

    // Faz consultas em paralelo (N=14). Se preferir mais leve, posso limitar concorr√™ncia.
    const results = await Promise.all(dates.map(ds => fetchSlotsForDate(ds)));

    const chips = results.map(r=>{
      const d = new Date(r.dateStr + "T00:00:00");
      return {
        ymd: r.dateStr,
        dow: dowShortPt(d),
        dd: String(d.getDate()).padStart(2,"0"),
        mon: monthShortPt(d),
        count: r.count,
        disabled: r.count === 0
      };
    });

    const availableCount = chips.filter(c=>!c.disabled).length;
    if(availableCount === 0){
      daysHint.textContent = "Nenhum dia dispon√≠vel nos pr√≥ximos dias.";
      renderDayChips(chips, dateInput.value);
      return;
    }

    daysHint.textContent = "Escolha um dia para ver os hor√°rios.";

    // se a data atual n√£o tiver hor√°rios, pula para o primeiro dia com disponibilidade
    const current = dateInput.value;
    const hasCurrent = chips.some(c => c.ymd === current && !c.disabled);
    if(!hasCurrent){
      const firstAvail = chips.find(c => !c.disabled);
      if(firstAvail){
        dateInput.value = firstAvail.ymd;
      }
    }

    renderDayChips(chips, dateInput.value);
  }

  async function loadSlots(){
    hideAllMsgs();
    resetSlotsUI();

    updateMeta();
    updateSummary();

    if(!COMPANY_ID) return;

    const serviceId = serviceSel.value;
    const profId = profSel.value;
    const date = dateInput.value;

    if(!serviceId || !profId){
      setStatus("Aguardando sele√ß√£o...");
      return;
    }

    // Sempre que trocar servi√ßo/profissional, atualiza a barra de dias
    await loadAvailableDays();

    if(!date){
      setStatus("Selecione um dia");
      return;
    }

    setStatus("Consultando disponibilidade...");
    showInfo("Consultando hor√°rios dispon√≠veis...");

    const { data, error } = await supabase.rpc("get_available_slots",{
      p_company_id: COMPANY_ID,
      p_professional_id: profId,
      p_service_id: serviceId,
      p_date: date
    });

    if (error) {
      setStatus("Falha ao buscar hor√°rios");
      showErr("Erro ao buscar hor√°rios.");
      return;
    }

    hideAllMsgs();

    if(!data || !data.length){
      setStatus("Sem hor√°rios no dia");
      slotsDiv.innerHTML = "<div style='grid-column:1/-1;color:#6b7280'>Sem hor√°rios dispon√≠veis para esta data.</div>";
      btnConfirm.disabled = true;
      return;
    }

    setStatus("Selecione um hor√°rio");
    data.forEach(s=>{
      const b = document.createElement("div");
      b.className="slot";
      b.textContent = fmtTime(s.slot_start);
      b.onclick = ()=>{
        document.querySelectorAll(".slot").forEach(x=>x.classList.remove("active"));
        b.classList.add("active");
        selectedSlot = s.slot_start;
        btnConfirm.disabled = false;
        setStatus("Pronto para confirmar");
        updateSummary();
      };
      slotsDiv.appendChild(b);
    });
  }

  btnConfirm.onclick = async ()=>{
    const name = document.getElementById("customerName").value.trim();
    const phone = document.getElementById("customerPhone").value.trim();

    if(name.length < 2) return showErr("Informe seu nome completo.");
    if(!selectedSlot) return showErr("Selecione um hor√°rio.");
    if(!COMPANY_ID) return showErr("Empresa n√£o carregada.");

    btnConfirm.disabled = true;
    setStatus("Confirmando agendamento...");
    showInfo("Confirmando seu agendamento...");

    const { data, error } = await supabase.rpc("create_public_appointment",{
      p_company_id: COMPANY_ID,
      p_professional_id: profSel.value,
      p_service_id: serviceSel.value,
      p_customer_name: name,
      p_customer_phone: phone,
      p_starts_at: selectedSlot
    });

    if (error) {
      btnConfirm.disabled = false;
      setStatus("Falha ao confirmar");
      return showErr(error.message);
    }

    setStatus("Agendamento confirmado");
    showOk("Agendamento confirmado com sucesso! Seu hor√°rio foi reservado.");
    updateSummary();

    // Recarrega dias e hor√°rios (para remover o slot ocupado e atualizar contagens)
    await loadAvailableDays();
    await loadSlots();
  };

  async function loadCompany(){
    const { data, error } = await supabase
      .from("companies")
      .select("id,status,paid_until")
      .eq("slug","empresa-demo")
      .single();

    if (error || !data) {
      showErr("Empresa n√£o encontrada (slug empresa-demo).");
      setStatus("Indispon√≠vel");
      return;
    }

    COMPANY_ID = data.id;

    if (data.status !== "active") {
      showWarn("Empresa est√° inativa no momento.");
    }

    const today = new Date(new Date().toISOString().slice(0,10));
    if (data.paid_until && new Date(data.paid_until) < today) {
      showWarn("Empresa est√° com pagamento vencido.");
    }
  }

  async function loadServices(){
    let res = await supabase
      .from("services")
      .select("id,name,duration_minutes")
      .eq("active",true)
      .order("name",{ascending:true});

    if (res.error) {
      res = await supabase
        .from("services")
        .select("id,name")
        .eq("active",true)
        .order("name",{ascending:true});
    }

    if (res.error) { showErr("Erro ao carregar servi√ßos."); return; }

    servicesById.clear();
    serviceSel.innerHTML = `<option value="">Selecione</option>`;
    (res.data||[]).forEach(s=>{
      servicesById.set(String(s.id), s);
      serviceSel.innerHTML += `<option value="${s.id}">${s.name}</option>`;
    });
  }

  async function loadProfessionals(){
    const { data, error } = await supabase
      .from("professionals")
      .select("id,name")
      .eq("active",true)
      .order("name",{ascending:true});

    if (error) { showErr("Erro ao carregar profissionais."); return; }

    professionalsById.clear();
    profSel.innerHTML = `<option value="">Selecione</option>`;
    (data||[]).forEach(p=>{
      professionalsById.set(String(p.id), p);
      profSel.innerHTML += `<option value="${p.id}">${p.name}</option>`;
    });
  }

  function onSelectionChange(){
    updateMeta();
    updateSummary();
    // limpa slots e carrega dias/hor√°rios novamente
    loadSlots();
  }

  serviceSel.onchange = onSelectionChange;
  profSel.onchange = onSelectionChange;

  // Se o usu√°rio mudar manualmente a data, recarrega hor√°rios e marca chip se existir
  dateInput.onchange = async ()=>{
    updateSummary();
    await loadSlots();
    // tenta real√ßar chip ativo
    document.querySelectorAll(".dayChip").forEach(ch => ch.classList.remove("active"));
    const active = Array.from(document.querySelectorAll(".dayChip")).find(ch => {
      // checa pelo texto? melhor re-render; ent√£o chamamos loadAvailableDays que re-renderiza com active
      return false;
    });
    await loadAvailableDays();
  };

  (async ()=>{
    dateInput.value = ymd(new Date());
    setStatus("Carregando...");
    await loadCompany();
    await loadServices();
    await loadProfessionals();

    updateMeta();
    updateSummary();

    setStatus("Aguardando sele√ß√£o...");
    // j√° tenta carregar dias (se j√° tiver sele√ß√£o)
    await loadAvailableDays();
  })();
</script>
</body>
</html>
