<!doctype html>
<!--
  Painel Administrativo • AgendaPro (Multi-empresa • Supabase)
  - Este arquivo é 100% estático (HTML + JS) e consome Supabase.
  - Configure SUPABASE_URL e SUPABASE_ANON_KEY no bloco <script> (logo abaixo).
  - Requisitos atendidos: multi-tenant por company_id, autenticação Supabase, RLS no banco.
-->
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Painel ADM • AgendaPro</title>

  <style>

@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');

:root{
  /* Base */
  --bg:#07020b; /* mantém seu fundo */
  --text:#F5F3FF;
  --text2:#E7E3F7;
  --muted:#B9B3D4;
  --muted2:#9C96B8;

  /* Surfaces (glass premium) */
  --surface: rgba(14, 8, 20, .72);
  --surface2: rgba(12, 6, 16, .58);
  --surface3: rgba(10, 6, 14, .46);

  /* Accents */
  --accent1:#C084FC;   /* lilás premium */
  --accent2:#A855F7;   /* roxo intenso */
  --accent3:#FF4FD8;   /* pink neon controlado */

  /* Lines + shadow */
  --border:rgba(255,255,255,.10);
  --border2:rgba(255,255,255,.14);
  --shadow: 0 24px 70px rgba(0,0,0,.58);
  --shadow2: 0 14px 34px rgba(0,0,0,.40);
  --radius: 18px;

  /* Status */
  --ok:#22c55e;
  --bad:#fb7185;
  --done:#a78bfa;

  /* Glows */
  --glowA: rgba(192,132,252,.28);
  --glowB: rgba(168,85,247,.24);
  --glowP: rgba(255,79,216,.20);
}

*{box-sizing:border-box}
html,body{height:100%}

body{
  margin:0;
  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  color:var(--text);
  background:
    radial-gradient(1200px 620px at 16% 12%, rgba(255,79,216,.15), transparent 55%),
    radial-gradient(980px 620px at 86% 28%, rgba(168,85,247,.16), transparent 56%),
    radial-gradient(1200px 740px at 42% 96%, rgba(192,132,252,.10), transparent 60%),
    var(--bg);
  min-height:100vh;
  overflow-x:hidden;
  text-rendering: geometricPrecision;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

body::before, body::after{
  content:"";
  position:fixed;
  inset:-120px;
  z-index:-1;
  pointer-events:none;
  filter: blur(26px);
  opacity:.86;
  transform: translate3d(0,0,0);
}

body::before{
  background:
    radial-gradient(circle at 18% 20%, rgba(255,79,216,.36), transparent 36%),
    radial-gradient(circle at 84% 34%, rgba(168,85,247,.36), transparent 40%),
    radial-gradient(circle at 40% 90%, rgba(192,132,252,.18), transparent 44%);
  animation: floatGlow 11s ease-in-out infinite;
}

body::after{
  background:
    radial-gradient(circle at 64% 14%, rgba(255,255,255,.07), transparent 32%),
    radial-gradient(circle at 10% 70%, rgba(168,85,247,.14), transparent 36%),
    radial-gradient(circle at 92% 86%, rgba(255,79,216,.12), transparent 40%);
  animation: floatGlow2 15s ease-in-out infinite;
  opacity:.55;
}

@keyframes floatGlow{
  0%,100%{ transform: translate3d(0,0,0) scale(1); }
  50%{ transform: translate3d(18px,-10px,0) scale(1.03); }
}
@keyframes floatGlow2{
  0%,100%{ transform: translate3d(0,0,0) scale(1); }
  50%{ transform: translate3d(-16px,12px,0) scale(1.02); }
}

.hidden{display:none!important}

.wrap{max-width:1480px;margin:0 auto;padding:26px 32px}
@media (min-width:1600px){.wrap{max-width:1600px}}
@media (max-width:640px){.wrap{padding:18px}}

.card{
  background: linear-gradient(180deg, rgba(255,255,255,.045), rgba(255,255,255,.02)) , var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  backdrop-filter: blur(14px);
}

.card.soft{
  background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.015)) , var(--surface2);
}

.brand{
  font-weight:900;
  font-size:24px;
  margin:0;
  letter-spacing:.2px;
  background: linear-gradient(90deg, var(--accent3), var(--accent2), var(--accent1));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  text-shadow: 0 0 22px rgba(168,85,247,.12);
}

.muted{color:var(--muted)}
.smallMuted{color:var(--muted2)}

.pill{
  padding:8px 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background: linear-gradient(90deg, rgba(255,79,216,.10), rgba(168,85,247,.10));
  font-weight:800;
  font-size:13px;
  white-space:nowrap;
  color: var(--text);
}

/* LOGIN */
.center{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px}
.login{width:420px;padding:24px}
label{font-size:12px;color:var(--muted);display:block;margin-top:10px}

input, select{
  width:100%;
  padding:12px 14px;
  min-height:46px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.14);
  outline:none;
  margin-top:6px;
  font-size:14px;
  background: rgba(10,6,14,.68);
  color: var(--text);
  box-shadow: 0 0 0 0 rgba(0,0,0,0);
}

input::placeholder{color: rgba(245,243,255,.45)}

input:focus, select:focus{
  border-color: rgba(192,132,252,.55);
  box-shadow:
    0 0 0 4px rgba(168,85,247,.14),
    0 0 0 1px rgba(255,255,255,.08) inset;
}

.btn{
  border:0;
  padding:12px 14px;
  border-radius:14px;
  font-weight:900;
  cursor:pointer;
  color:#0b0410;
  background: linear-gradient(135deg, var(--accent2), var(--accent1));
  box-shadow: 0 16px 34px rgba(168,85,247,.28), 0 10px 22px rgba(0,0,0,.35);
  transition: transform .16s ease, filter .16s ease, box-shadow .16s ease;
}

.btn:hover{
  transform: translateY(-1px);
  filter: brightness(1.03);
  box-shadow: 0 18px 42px rgba(168,85,247,.32), 0 10px 22px rgba(0,0,0,.35);
}

.btn:disabled{opacity:.6;cursor:not-allowed;transform:none;filter:none}

.btn2{
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.04);
  padding:10px 14px;
  min-height:46px;
  border-radius:14px;
  cursor:pointer;
  font-weight:900;
  color: var(--text);
  transition: transform .16s ease, background .16s ease, border-color .16s ease, filter .16s ease;
}

.btn2:hover{
  background: rgba(255,255,255,.07);
  border-color: rgba(255,255,255,.20);
  transform: translateY(-1px);
}

.btn2:active{transform: translateY(0px); filter: brightness(.98);}

.btnDanger{
  border:1px solid rgba(251,113,133,.55);
  background: rgba(251,113,133,.10);
  color:#fecdd3;
}
.btnDanger:hover{background: rgba(251,113,133,.14);}

.error{
  display:none;
  margin-top:10px;
  padding:10px 12px;
  border-radius:14px;
  background: rgba(251,113,133,.12);
  border:1px solid rgba(251,113,133,.35);
  color:#fecdd3;
  font-size:13px;
}

.toast{
  position:fixed;
  right:18px;
  bottom:18px;
  min-width:260px;
  max-width:380px;
  padding:12px 14px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(10,6,14,.78);
  box-shadow:var(--shadow2);
  display:none;
  z-index:9999;
  color: var(--text);
  backdrop-filter: blur(14px);
}
.toast.ok{border-color: rgba(34,197,94,.50)}
.toast.err{border-color: rgba(251,113,133,.55)}

/* LAYOUT */
.topbar{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:16px 18px;
  margin-top:14px;
  gap:10px;
  position:sticky;
  top:14px;
  z-index:50;
}

.row{display:flex;gap:16px;flex-wrap:wrap;margin-top:14px}

.sidebar{
  position:sticky;
  top:94px;
  align-self:flex-start;
  width:280px;
  padding:16px;
  background: linear-gradient(180deg, rgba(255,255,255,.035), rgba(255,255,255,.015)), var(--surface2);
  border:1px solid var(--border);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  backdrop-filter: blur(14px);
}

.menu{margin-top:14px;display:flex;flex-direction:column;gap:8px}

.menu button{
  position:relative;
  text-align:left;
  border:1px solid transparent;
  background:transparent;
  padding:12px 12px 12px 12px;
  border-radius:14px;
  font-weight:900;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  color: var(--text2);
  transition: transform .16s ease, background .16s ease, border-color .16s ease;
}

.menu button:hover{
  background: rgba(255,255,255,.06);
  border-color: rgba(255,255,255,.16);
  transform: translateY(-1px);
}

.menu .active{
  background: rgba(255,255,255,.07);
  border-color: rgba(192,132,252,.28);
}

.menu .active::before{
  content:"";
  position:absolute;
  left:-1px;
  top:10px;
  bottom:10px;
  width:3px;
  border-radius:8px;
  background: linear-gradient(180deg, var(--accent1), var(--accent2));
  box-shadow: 0 0 18px rgba(168,85,247,.30);
}

.content{flex:1;min-width:300px;min-height:70vh}

.section{padding:18px}
.section h2{
  margin:0 0 6px 0;
  font-size:24px;
  letter-spacing:.2px;
  color: var(--text);
}
.section p{
  margin:0 0 14px 0;
  color:var(--muted);
  font-size:15px;
  line-height:1.45;
}

.grid{
  display:grid;
  grid-template-columns: repeat(4, minmax(0,1fr));
  gap:14px;
}
@media (max-width:1100px){.grid{grid-template-columns: repeat(2, minmax(0,1fr));}}
@media (max-width:760px){.grid{grid-template-columns: 1fr;}.sidebar{width:100%}}

.kpi{
  padding:16px;
  position:relative;
  overflow:hidden;
  background: linear-gradient(180deg, rgba(255,255,255,.045), rgba(255,255,255,.02)) , var(--surface3);
  border:1px solid rgba(255,255,255,.10);
  box-shadow: var(--shadow2);
  transition: transform .16s ease, border-color .16s ease, background .16s ease;
}
.kpi:hover{
  transform: translateY(-2px);
  border-color: rgba(192,132,252,.22);
  background: linear-gradient(180deg, rgba(192,132,252,.06), rgba(255,255,255,.015)) , var(--surface3);
}
.kpi::after{
  content:"";
  position:absolute;
  right:-60px;
  top:-60px;
  width:160px;
  height:160px;
  border-radius:999px;
  background: radial-gradient(circle at 30% 30%, rgba(192,132,252,.22), transparent 55%),
              radial-gradient(circle at 65% 65%, rgba(255,79,216,.16), transparent 60%);
  filter: blur(1px);
  opacity:.9;
}
.kpi h3{margin:0 0 6px 0;font-size:12px;color:var(--muted);letter-spacing:.08em;text-transform:uppercase}
.kpi .big{font-size:34px;font-weight:900;margin:0;color:var(--text);letter-spacing:.2px}

.toolbar{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  align-items:center;
  justify-content:space-between;
  margin:12px 0 14px;
  padding:14px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.03);
  backdrop-filter: blur(14px);
}

.toolbar .left,.toolbar .right{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.miniInput{width:auto;min-width:220px}

/* TABLE */
table{width:100%;border-collapse:separate;border-spacing:0 10px}
th{
  font-size:12px;
  color: rgba(245,243,255,.70);
  text-align:left;
  padding:12px 10px;
  position:sticky;
  top:0;
  background: rgba(10,6,14,.84);
  backdrop-filter: blur(14px);
  border-bottom:1px solid rgba(255,255,255,.08);
  z-index:2;
  letter-spacing:.08em;
  text-transform:uppercase
}

td{
  background: rgba(10,6,14,.56);
  border:1px solid rgba(255,255,255,.10);
  padding:12px 10px;
  vertical-align:middle;
  color: var(--text);
  backdrop-filter: blur(10px);
  transition: background .16s ease, border-color .16s ease, transform .16s ease;
}
td:first-child{border-radius:14px 0 0 14px}
td:last-child{border-radius:0 14px 14px 0}
tbody tr:hover td{
  background: rgba(255,255,255,.065);
  border-color: rgba(255,255,255,.16);
}

/* Tags */
.tag{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:900;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.04);
  color: var(--text);
  white-space:nowrap;
}
.tag.ok{border-color: rgba(34,197,94,.45);background: rgba(34,197,94,.12);color: #86efac}
.tag.bad{border-color: rgba(251,113,133,.45);background: rgba(251,113,133,.12);color: #fecdd3}
.tag.done{border-color: rgba(167,139,250,.45);background: rgba(167,139,250,.12);color: #ddd6fe}

/* MODAL */
.modalBack{
  position:fixed; inset:0;
  background: rgba(0,0,0,.58);
  display:none;
  align-items:center;
  justify-content:center;
  padding:18px;
  z-index:9998;
}
.modal{width:100%;max-width:560px;padding:16px}
.modalHeader{display:flex;justify-content:space-between;gap:10px;align-items:center}
.modalHeader h3{margin:0}
.modalBody{margin-top:10px}
.modalBody .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media (max-width:640px){.modalBody .row2{grid-template-columns:1fr}}
.modalFooter{display:flex;gap:10px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap}

/* Accessibility */
:focus-visible{
  outline: 2px solid rgba(192,132,252,.55);
  outline-offset: 2px;
}

  
/* WhatsApp quick action */
.waBtn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  padding:8px 10px;
  border-radius:12px;
  border:1px solid rgba(34,197,94,.45);
  background: rgba(34,197,94,.10);
  color:#86efac;
  font-weight:900;
  font-size:12px;
  text-decoration:none;
  white-space:nowrap;
  transition: transform .16s ease, filter .16s ease, background .16s ease, border-color .16s ease;
}
.waBtn:hover{
  transform: translateY(-1px);
  filter: brightness(1.03);
  background: rgba(34,197,94,.14);
  border-color: rgba(34,197,94,.55);
}
.waBtn:active{transform: translateY(0px); filter: brightness(.98);}
.waBtn.small{padding:6px 9px; font-size:12px; border-radius:999px}
.phoneCell{display:flex;align-items:center;gap:10px;flex-wrap:wrap}

/* Status warning (Aguardando) */
.tag.warn{border-color: rgba(250,204,21,.50);background: rgba(250,204,21,.12);color: #fde68a}

/* Clickable customer name */
.linkBtn{
  background:transparent;
  border:0;
  padding:0;
  margin:0;
  color: var(--text);
  font-weight:900;
  cursor:pointer;
  text-decoration: underline;
  text-decoration-color: rgba(192,132,252,.35);
  text-underline-offset: 3px;
}
.linkBtn:hover{ text-decoration-color: rgba(192,132,252,.65); }

/* Menu modal */
.menuGrid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
}
@media (max-width:640px){.menuGrid{grid-template-columns:1fr}}
.menuTile{
  text-align:left;
  padding:14px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.04);
  cursor:pointer;
  transition: transform .16s ease, background .16s ease, border-color .16s ease;
}
.menuTile:hover{
  transform: translateY(-1px);
  background: rgba(255,255,255,.07);
  border-color: rgba(255,255,255,.20);
}
.menuTile .t{font-weight:1000;color:var(--text);margin-bottom:4px}
.menuTile .d{font-size:12px;color:var(--muted)}


/* PREMIUM LOGIN */
.premium-login{
  max-width:420px;
  padding:34px 30px;
  text-align:center;
}
.login-brand{
  margin-bottom:26px;
}
.login-brand h1{
  margin:14px 0 4px;
  font-size:30px;
  font-weight:900;
  letter-spacing:.5px;
}
.login-brand h1 span{
  color:var(--accent1);
}
.login-brand p{
  font-size:14px;
  color:var(--muted);
}
.logo-circle{
  width:68px;
  height:68px;
  border-radius:50%;
  margin:0 auto;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:900;
  font-size:22px;
  background:linear-gradient(135deg,var(--accent2),var(--accent1));
  color:#0b0410;
  box-shadow:0 0 30px rgba(168,85,247,.45);
}
.login-form{
  text-align:left;
}
.login-btn{
  width:100%;
  margin-top:16px;
  font-size:15px;
}
.login-footer{
  margin-top:20px;
  font-size:12px;
  color:var(--muted2);
}

</style>
</head>

<body>

  
  <!-- LOGIN (Premium) -->
  <div id="loginView" class="center">
    <div class="card login premium-login">
      <div class="login-brand">
        <div class="logo-circle">AP</div>
        <h1>Agenda<span>PRO</span></h1>
        <p>Sistema profissional de agendamentos</p>
      </div>

      <div class="login-form">
        <label>E-mail</label>
        <input id="email" placeholder="seu@email.com" />

        <label>Senha</label>
        <input id="password" type="password" placeholder="••••••••" />

        <div id="err" class="error"></div>

        <button id="btnLogin" class="btn login-btn">Entrar no sistema</button>
      </div>

      <div class="login-footer">
        <span>LEP Sistemas • Agenda Online</span>
      </div>
    </div>
  </div>


  <!-- APP -->
  <div id="appView" class="wrap hidden">
    <div class="topbar card">
      <div>
        <div class="brand">AgendaPro</div>
        <div class="muted" id="who" style="font-size:13px;margin-top:2px;">—</div>
      </div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end">
        <span class="pill" id="companyPill">Empresa: —</span>
        <button class="btn2" id="btnOpenMenu">Menu</button>
        <button class="btn2" id="btnRefresh">Atualizar</button>
        <button class="btn2" id="btnLogout">Sair</button>
      </div>
    </div>

    <div class="row">
      <aside class="sidebar">
        <div class="pill">Menu</div>
        <div class="menu">
          <button class="active" data-tab="dash"><span>Dashboard</span><span class="tag" id="badgeToday">—</span></button>
          <button data-tab="agenda"><span>Agenda</span><span class="tag" id="badgeAgenda">—</span></button>
          <button data-tab="historico"><span>Histórico</span><span class="tag" id="badgeHistorico">—</span></button>
          <button data-tab="clientes"><span>Clientes</span><span class="tag" id="badgeClientes">—</span></button>
          <button data-tab="profissionais"><span>Profissionais</span><span class="tag" id="badgePros">—</span></button>
          <button data-tab="servicos"><span>Serviços</span><span class="tag" id="badgeServ">—</span></button>
          <button data-tab="horarios"><span>Horários</span><span class="tag" id="badgeHours">—</span></button>
        </div>

        <div style="margin-top:14px" class="muted">
          <div style="font-weight:900;color:var(--text)">Ações rápidas</div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
            <button class="btn2" id="quickNewCustomer">+ Cliente</button>
            <button class="btn2" id="quickNewPro">+ Profissional</button>
            <button class="btn2" id="quickNewService">+ Serviço</button>
          </div>
        </div>

        <div style="margin-top:14px" class="muted">
          <div style="font-weight:900;color:var(--text)">Permissão</div>
          <div id="roleBox" class="pill" style="margin-top:8px;display:inline-block">—</div>
        </div>
      </aside>

      <main class="content">
        <!-- DASH -->
        <section id="tab-dash" class="card section">
          <h2>Dashboard</h2>
          <p>Resumo do dia e próximos agendamentos.</p>

          <div class="grid">
            <div class="card kpi"><h3>Hoje</h3><p class="big" id="kpiToday">—</p></div>
            <div class="card kpi"><h3>Confirmados</h3><p class="big" id="kpiConf">—</p></div>
            <div class="card kpi"><h3>Cancelados</h3><p class="big" id="kpiCanc">—</p></div>
            <div class="card kpi"><h3>Concluídos</h3><p class="big" id="kpiDone">—</p></div>
          </div>


          <div class="grid" style="margin-top:14px">
            <div class="card kpi"><h3>Atendimentos hoje</h3><p class="big" id="kpiApptToday">—</p></div>
            <div class="card kpi"><h3>Faturamento estimado hoje</h3><p class="big" id="kpiRevenueToday">—</p></div>
            <div class="card kpi"><h3>Profissional mais ocupado (semana)</h3><p class="big" id="kpiBusiestPro">—</p></div>
            <div class="card kpi"><h3>Horário mais usado (semana)</h3><p class="big" id="kpiBusiestHour">—</p></div>
          </div>

          <div style="margin-top:14px" class="card section">
            <div class="toolbar">
              <div class="left">
                <div style="font-weight:1000">Alertas</div>
                <span class="muted" style="font-size:13px">detecção automática</span>
              </div>
              <div class="right">
                <span class="tag" id="alertBadge">—</span>
              </div>
            </div>

            <div id="alertsBox" class="muted" style="font-size:14px;line-height:1.6">
              <div>—</div>
            </div>
          </div>

          <div style="margin-top:14px" class="card section">
            <div class="toolbar">
              <div class="left">
                <div style="font-weight:1000">Próximos agendamentos</div>
                <span class="muted" style="font-size:13px">até 20 itens</span>
              </div>
              <div class="right">
                <button class="btn2" id="btnGoAgenda">Abrir Agenda</button>
              </div>
            </div>

            <div style="overflow:auto">
              <table>
                <thead>
                  <tr><th>Data/Hora</th><th>Profissional</th><th>Serviço</th><th>Cliente</th><th>Status</th></tr>
                </thead>
                <tbody id="tbodyNext"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- AGENDA -->
        <section id="tab-agenda" class="card section hidden">
          <h2>Agenda</h2>
          <p>Filtre por data e profissional, altere status e gerencie agendamentos.</p>

          <div class="toolbar">
            <div class="left">
              <input class="miniInput" id="agendaDate" type="date" />
              <select class="miniInput" id="agendaPro"></select>
              <input class="miniInput" id="agendaSearch" placeholder="Buscar cliente/telefone..." />
            </div>
            <div class="right">
              <button class="btn2" id="btnNewAppointment">+ Novo Agendamento</button>
              <button class="btn2" id="btnAgendaReload">Recarregar</button>
            </div>
          </div>

          <div style="overflow:auto">
            <table>
              <thead>
                <tr><th>Hora</th><th>Profissional</th><th>Serviço</th><th>Cliente</th><th>Telefone</th><th>Status</th><th>Ações</th></tr>
              </thead>
              <tbody id="tbodyAgenda"></tbody>
            </table>
          </div>
        </section>

        <!-- HISTÓRICO -->
        <section id="tab-historico" class="card section hidden">
          <h2>Histórico</h2>
          <p>Atendimentos finalizados (status: <strong>done</strong>). Filtre por datas e profissional. Você pode excluir por período para manter leve.</p>

          <div class="toolbar">
            <div class="left">
              <input class="miniInput" id="histStart" type="date" />
              <input class="miniInput" id="histEnd" type="date" />
              <select class="miniInput" id="histPro"></select>
              <input class="miniInput" id="histSearch" placeholder="Buscar cliente/telefone..." />
            </div>
            <div class="right">
              <button class="btn2" id="btnHistToday">Hoje</button>
              <button class="btn2" id="btnHist7">7 dias</button>
              <button class="btn2" id="btnHist30">30 dias</button>
              <button class="btn2" id="btnHistReload">Recarregar</button>
              <button class="btn2 btnDanger" id="btnHistClear">Excluir por data</button>
            </div>
          </div>

          <div style="overflow:auto">
            <table>
              <thead>
                <tr><th>Data</th><th>Hora</th><th>Profissional</th><th>Serviço</th><th>Cliente</th><th>Telefone</th><th>Status</th></tr>
              </thead>
              <tbody id="tbodyHistorico"></tbody>
            </table>
          </div>
        </section>

        <!-- CLIENTES -->
        <section id="tab-clientes" class="card section hidden">
          <h2>Clientes</h2>
          <p>Cadastre, edite e busque clientes.</p>

          <div class="toolbar">
            <div class="left">
              <input class="miniInput" id="searchCustomer" placeholder="Buscar por nome/telefone..." />
            </div>
            <div class="right">
              <button class="btn2" id="btnNewCustomer">+ Novo Cliente</button>
              <button class="btn2" id="btnCustomersReload">Recarregar</button>
            </div>
          </div>

          <div style="overflow:auto">
            <table>
              <thead>
                <tr><th>Nome</th><th>Telefone</th><th>E-mail</th><th>Documento</th><th>Ações</th></tr>
              </thead>
              <tbody id="tbodyCustomers"></tbody>
            </table>
          </div>
        </section>

        <!-- PROFISSIONAIS -->
        <section id="tab-profissionais" class="card section hidden">
          <h2>Profissionais</h2>
          <p>Gerencie equipe.</p>

          <div class="toolbar">
            <div class="left"></div>
            <div class="right">
              <button class="btn2" id="btnNewPro">+ Novo Profissional</button>
              <button class="btn2" id="btnProsReload">Recarregar</button>
            </div>
          </div>

          <div style="overflow:auto">
            <table>
              <thead>
                <tr><th>Nome</th><th>Status</th><th>Ações</th></tr>
              </thead>
              <tbody id="tbodyPros"></tbody>
            </table>
          </div>
        </section>

        <!-- SERVIÇOS -->
        <section id="tab-servicos" class="card section hidden">
          <h2>Serviços</h2>
          <p>Cadastre serviços com duração e preço.</p>

          <div class="toolbar">
            <div class="left"></div>
            <div class="right">
              <button class="btn2" id="btnNewService">+ Novo Serviço</button>
              <button class="btn2" id="btnServReload">Recarregar</button>
            </div>
          </div>

          <div style="overflow:auto">
            <table>
              <thead>
                <tr><th>Serviço</th><th>Duração</th><th>Preço</th><th>Status</th><th>Ações</th></tr>
              </thead>
              <tbody id="tbodyServ"></tbody>
            </table>
          </div>
        </section>

        <!-- HORÁRIOS -->
        <section id="tab-horarios" class="card section hidden">
          <h2>Horários</h2>
          <p>Defina dias e horários disponíveis por profissional.</p>

          <div class="toolbar">
            <div class="left" style="gap:10px">
              <select class="miniInput" id="whPro"></select>
              <select id="whWeekday" class="miniInput">
                <option value="0">Domingo</option>
                <option value="1">Segunda</option>
                <option value="2">Terça</option>
                <option value="3">Quarta</option>
                <option value="4">Quinta</option>
                <option value="5">Sexta</option>
                <option value="6">Sábado</option>
              </select>
              <input id="whStart" class="miniInput" type="time" value="09:00" />
              <input id="whEnd" class="miniInput" type="time" value="18:00" />
              <input id="whSlot" class="miniInput" type="number" min="10" max="180" value="30" />
            </div>
            <div class="right">
              <button class="btn2" id="btnWhAdd">Salvar Horário</button>
              <button class="btn2" id="btnWhDefault">Aplicar Seg–Sex 09:00–18:00</button>
              <button class="btn2" id="btnWhReload">Recarregar</button>
            </div>
          </div>

          <div style="overflow:auto">
            <table>
              <thead>
                <tr><th>Profissional</th><th>Dia</th><th>Início</th><th>Fim</th><th>Slot</th><th>Ações</th></tr>
              </thead>
              <tbody id="tbodyHours"></tbody>
            </table>
          </div>
        </section>

      </main>
    </div>
  </div>

  <!-- MODAL -->
  <div id="modalBack" class="modalBack">
    <div class="card modal">
      <div class="modalHeader">
        <h3 id="modalTitle">—</h3>
        <button class="btn2" id="modalClose">Fechar</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
      <div class="modalFooter" id="modalFooter"></div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SB_URL = "https://nsmvnfhdohpvmtoimsub.supabase.co";
    const SB_KEY = "sb_publishable_tn76OaKxjctgngA6jj9NSw_KXfWqt-f";
    const sb = window.supabase.createClient(SB_URL, SB_KEY);

    // UI refs
    const loginView = document.getElementById("loginView");
    const appView = document.getElementById("appView");
    const btnLogin = document.getElementById("btnLogin");
    const btnLogout = document.getElementById("btnLogout");
    const btnRefresh = document.getElementById("btnRefresh");
    const err = document.getElementById("err");

    const who = document.getElementById("who");
    const companyPill = document.getElementById("companyPill");
    const roleBox = document.getElementById("roleBox");

    const kpiToday = document.getElementById("kpiToday");
    const kpiConf  = document.getElementById("kpiConf");
    const kpiCanc  = document.getElementById("kpiCanc");
    const kpiDone  = document.getElementById("kpiDone");

    const kpiApptToday = document.getElementById("kpiApptToday");
    const kpiRevenueToday = document.getElementById("kpiRevenueToday");
    const kpiBusiestPro = document.getElementById("kpiBusiestPro");
    const kpiBusiestHour = document.getElementById("kpiBusiestHour");

    const alertsBox = document.getElementById("alertsBox");
    const alertBadge = document.getElementById("alertBadge");


    const badgeToday = document.getElementById("badgeToday");
    const badgeAgenda = document.getElementById("badgeAgenda");
    const badgeHistorico = document.getElementById("badgeHistorico");
const badgeClientes = document.getElementById("badgeClientes");
    const badgePros = document.getElementById("badgePros");
    const badgeServ = document.getElementById("badgeServ");
    const badgeHours = document.getElementById("badgeHours");

    const tbodyNext = document.getElementById("tbodyNext");
    const tbodyAgenda = document.getElementById("tbodyAgenda");
    // HISTÓRICO
    const histStart = document.getElementById("histStart");
    const histEnd = document.getElementById("histEnd");
    const histPro = document.getElementById("histPro");
    const histSearch = document.getElementById("histSearch");
    const btnHistToday = document.getElementById("btnHistToday");
    const btnHist7 = document.getElementById("btnHist7");
    const btnHist30 = document.getElementById("btnHist30");
    const btnHistReload = document.getElementById("btnHistReload");
    const btnHistClear = document.getElementById("btnHistClear");
    const tbodyHistorico = document.getElementById("tbodyHistorico");

    const agendaDate = document.getElementById("agendaDate");
    const agendaPro = document.getElementById("agendaPro");

    const tbodyCustomers = document.getElementById("tbodyCustomers");
    const searchCustomer = document.getElementById("searchCustomer");

    const tbodyPros = document.getElementById("tbodyPros");
    const tbodyServ = document.getElementById("tbodyServ");

    const btnGoAgenda = document.getElementById("btnGoAgenda");
    const btnAgendaReload = document.getElementById("btnAgendaReload");
    const btnNewAppointment = document.getElementById("btnNewAppointment");

    const btnNewCustomer = document.getElementById("btnNewCustomer");
    const btnCustomersReload = document.getElementById("btnCustomersReload");

    const btnNewPro = document.getElementById("btnNewPro");
    const btnProsReload = document.getElementById("btnProsReload");

    const btnNewService = document.getElementById("btnNewService");
    const btnServReload = document.getElementById("btnServReload");

    const quickNewCustomer = document.getElementById("quickNewCustomer");
    const quickNewPro = document.getElementById("quickNewPro");
    const quickNewService = document.getElementById("quickNewService");

    // Working Hours refs
    const whPro = document.getElementById("whPro");
    const whWeekday = document.getElementById("whWeekday");
    const whStart = document.getElementById("whStart");
    const whEnd = document.getElementById("whEnd");
    const whSlot = document.getElementById("whSlot");
    const btnWhAdd = document.getElementById("btnWhAdd");
    const btnWhDefault = document.getElementById("btnWhDefault");
    const btnWhReload = document.getElementById("btnWhReload");
    const tbodyHours = document.getElementById("tbodyHours");

    // Modal
    const modalBack = document.getElementById("modalBack");
    const modalTitle = document.getElementById("modalTitle");
    const modalBody = document.getElementById("modalBody");
    const modalFooter = document.getElementById("modalFooter");
    const modalClose = document.getElementById("modalClose");

    // Toast
    const toast = document.getElementById("toast");
    // Menu (modal)
    const btnOpenMenu = document.getElementById("btnOpenMenu");

    // Agenda search
    const agendaSearch = document.getElementById("agendaSearch");

    // Helpers: WhatsApp link and phone normalization (BR default)
    function normalizePhoneToE164(phone){
      const raw = String(phone||"").trim();
      if(!raw) return null;
      const digits = raw.replace(/\D/g,"");
      if(!digits) return null;

      // If starts with 55 already (Brazil), keep; else assume BR when length <= 11
      if(digits.startsWith("55")) return digits;
      if(digits.length <= 11) return "55" + digits;
      return digits; // fallback
    }

    function waLink(phone, text){
      const e164 = normalizePhoneToE164(phone);
      if(!e164) return null;
      const base = "https://wa.me/" + e164;
      if(!text) return base;
      return base + "?text=" + encodeURIComponent(text);
    }

    function renderWhatsAppBtn(phone, name, small=false){
      const url = waLink(phone, name ? `Olá ${name}!` : "Olá!");
      if(!url) return "";
      const cls = "waBtn" + (small ? " small" : "");
      return `<a class="${cls}" href="${url}" target="_blank" rel="noopener">WhatsApp</a>`;
    }

    // Open Menu modal (clean navigation / more visibility)
    function openMenuModal(){
      const body = `
        <div class="menuGrid">
          <button class="menuTile" onclick="selectTab('dash', true)">
            <div class="t">Dashboard</div><div class="d">Resumo do dia e próximos</div>
          </button>
          <button class="menuTile" onclick="selectTab('agenda', true)">
            <div class="t">Agenda</div><div class="d">Gerenciar agendamentos</div>
          </button>
          <button class="menuTile" onclick="selectTab('clientes', true)">
            <div class="t">Clientes</div><div class="d">Cadastro, busca e histórico</div>
          </button>
          <button class="menuTile" onclick="selectTab('profissionais', true)">
            <div class="t">Profissionais</div><div class="d">Equipe e disponibilidade</div>
          </button>
          <button class="menuTile" onclick="selectTab('servicos', true)">
            <div class="t">Serviços</div><div class="d">Preço e duração</div>
          </button>
          <button class="menuTile" onclick="selectTab('horarios', true)">
            <div class="t">Horários</div><div class="d">Regras de agenda por profissional</div>
          </button>
        </div>
      `;
      openModal("Menu", body, `<button class="btn" onclick="window.__closeModal()">Fechar</button>`);
    }

    window.selectTab = (tab, close=true)=>{
      document.querySelectorAll(".menu button").forEach(b=>b.classList.remove("active"));
      const btn = document.querySelector(`.menu button[data-tab="${tab}"]`);
      if(btn) btn.classList.add("active");
      document.querySelectorAll("main section").forEach(sec=>sec.classList.add("hidden"));
      const sec = document.getElementById("tab-" + tab);
      if(sec) sec.classList.remove("hidden");

      if(tab==="agenda") loadAgenda();
      if(tab==="historico") loadHistory();
      if(tab==="clientes") loadCustomers();
      if(tab==="profissionais") loadProfessionals();
      if(tab==="servicos") loadServices();
      if(tab==="horarios") loadWorkingHours();

      if(close) closeModal();
    };

    btnOpenMenu?.addEventListener("click", openMenuModal);

    // Debounce agenda search
    let agendaSearchTimer = null;
    agendaSearch?.addEventListener("input", ()=>{
      clearTimeout(agendaSearchTimer);
      agendaSearchTimer = setTimeout(loadAgenda, 250);
    });

    // Customer history (simple / premium)
    window.openCustomerHistory = async (encoded)=>{
      let c = encoded ? JSON.parse(decodeURIComponent(encoded)) : null;
      if(!c) return toastMsg("err","Cliente inválido.");
      await openHistoryByCustomer(c.full_name, c.phone);
    };

    window.openCustomerHistoryFromAgenda = async (name, phone)=>{
      await openHistoryByCustomer(name, phone);
    };

    async function openHistoryByCustomer(name, phone){
      const companyId = state?.profile?.company_id;
      if(!companyId) return toastMsg("err","Sessão inválida.");

      const phoneNorm = (phone||"").trim();
      const nameNorm = (name||"").trim();

      // Prefer phone match when available
      let q = sb.from("appointments")
        .select("id, starts_at, status, customer_name, customer_phone, professional_id, service_id")
        .eq("company_id", companyId)
        .order("starts_at",{ascending:false})
        .limit(10);

      if(phoneNorm){
        q = q.eq("customer_phone", phoneNorm);
      } else if(nameNorm){
        q = q.ilike("customer_name", "%" + nameNorm + "%");
      }

      const { data, error } = await q;
      if(error) return toastMsg("err","Erro ao carregar histórico.");

      const rows = (data||[]).map(a=>`
        <tr>
          <td>${fmtDateTime(a.starts_at)}</td>
          <td>${state.prosMap[a.professional_id] || "—"}</td>
          <td>${state.servMap[a.service_id] || "—"}</td>
          <td>${tagStatus(a.status)}</td>
        </tr>
      `).join("");

      const wa = phoneNorm ? `
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 2px 0">
          <a class="waBtn" target="_blank" rel="noopener" href="${waLink(phoneNorm, `Olá ${nameNorm||""}! Estou confirmando seu agendamento.`) || "#"}">Confirmar</a>
          <a class="waBtn" target="_blank" rel="noopener" href="${waLink(phoneNorm, `Olá ${nameNorm||""}! Podemos remarcar seu horário?`) || "#"}">Remarcar</a>
          <a class="waBtn" target="_blank" rel="noopener" href="${waLink(phoneNorm, `Olá ${nameNorm||""}! Obrigado pelo atendimento.`) || "#"}">Pós</a>
        </div>
      ` : `<div class="muted" style="font-size:13px;margin-top:10px">Sem telefone para WhatsApp.</div>`;

      openModal(
        "Histórico do Cliente",
        `
          <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap">
            <div>
              <div style="font-weight:1000;font-size:16px;color:var(--text)">${esc(nameNorm) || "Cliente"}</div>
              <div class="muted" style="font-size:13px;margin-top:4px">Telefone: ${esc(phoneNorm)||"—"}</div>
            </div>
            ${phoneNorm ? renderWhatsAppBtn(phoneNorm, nameNorm) : ""}
          </div>

          ${wa}

          <div style="margin-top:12px; overflow:auto">
            <table>
              <thead>
                <tr><th>Data/Hora</th><th>Profissional</th><th>Serviço</th><th>Status</th></tr>
              </thead>
              <tbody>
                ${rows || `<tr><td colspan="4">Nenhum histórico encontrado.</td></tr>`}
              </tbody>
            </table>
          </div>
        `,
        `<button class="btn" onclick="window.__closeModal()">Fechar</button>`
      );
    }


    let state = {
      user: null,
      profile: null,
      company: null,
      role: "staff",
      isAdmin: false,
      pros: [],
      serv: [],
      prosMap: {},
      servMap: {}
    };

    const pad2 = (n)=>String(n).padStart(2,"0");
    const todayISO = ()=> {
      const d = new Date();
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    };

    // Converte um dia (YYYY-MM-DD) em intervalo UTC equivalente ao dia LOCAL
    // Ex.: 2026-01-09 (local) -> start/end em ISO UTC para filtrar timestamptz corretamente
    function dayRangeUTC(dateStr){
      const startLocal = new Date(dateStr + "T00:00:00");
      const endLocal = new Date(dateStr + "T00:00:00");
      endLocal.setDate(endLocal.getDate() + 1);
      return { start: startLocal.toISOString(), end: endLocal.toISOString() };
    }
    const fmtTime = (iso)=> new Date(iso).toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});
    const fmtDateTime = (iso)=> new Date(iso).toLocaleString("pt-BR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"});
    const money = (cents)=>{
      if (cents===null || cents===undefined || cents==="") return "—";
      return (Number(cents)/100).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
    };

    const weekdayLabel = (w)=>{
      const a=["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"];
      return a[Number(w)] ?? String(w);
    };

    function resetState(){
      state = { user:null, profile:null, company:null, role:"staff", isAdmin:false, pros:[], serv:[], prosMap:{}, servMap:{} };
      who.textContent = "—";
      companyPill.textContent = "Empresa: —";
      roleBox.textContent = "—";
      kpiToday.textContent="—"; kpiConf.textContent="—"; kpiCanc.textContent="—"; kpiDone.textContent="—";
      kpiApptToday.textContent="—"; kpiRevenueToday.textContent="—"; kpiBusiestPro.textContent="—"; kpiBusiestHour.textContent="—";
      alertBadge.textContent="—"; alertsBox.innerHTML = "<div>—</div>";
      badgeToday.textContent="—"; badgeAgenda.textContent="—"; badgeClientes.textContent="—"; badgePros.textContent="—"; badgeServ.textContent="—"; badgeHours.textContent="—";
      tbodyNext.innerHTML=""; tbodyAgenda.innerHTML=""; tbodyCustomers.innerHTML=""; tbodyPros.innerHTML=""; tbodyServ.innerHTML=""; tbodyHours.innerHTML="";
      agendaPro.innerHTML=""; whPro.innerHTML="";
      document.querySelectorAll(".menu button").forEach(b=>b.classList.remove("active"));
      document.querySelector('.menu button[data-tab="dash"]').classList.add("active");
      document.querySelectorAll("main section").forEach(sec=>sec.classList.add("hidden"));
      document.getElementById("tab-dash").classList.remove("hidden");
    }

    function showLogin(){ appView.classList.add("hidden"); loginView.classList.remove("hidden"); }
    function showApp(){ loginView.classList.add("hidden"); appView.classList.remove("hidden"); }
    function showError(msg){ err.style.display="block"; err.textContent=msg; }
    function clearError(){ err.style.display="none"; err.textContent=""; }

    function toastMsg(type, msg){
      toast.className = "toast " + (type==="ok" ? "ok" : "err");
      toast.textContent = msg;
      toast.style.display = "block";
      setTimeout(()=> toast.style.display="none", 2600);
    }

    function tagStatus(status){
      if(status==="confirmed") return `<span class="tag ok">Confirmado</span>`;
      if(status==="cancelled") return `<span class="tag bad">Cancelado</span>`;
      if(status==="done") return `<span class="tag done">Concluído</span>`;
      if(status==="pending" || status==="awaiting") return `<span class="tag warn">Aguardando</span>`;
      return `<span class="tag">${status || "—"}</span>`;
    }

    function openModal(title, bodyHTML, footerHTML){
      modalTitle.textContent = title;
      modalBody.innerHTML = bodyHTML;
      modalFooter.innerHTML = footerHTML || "";
      modalBack.style.display = "flex";
    }
    function closeModal(){ modalBack.style.display = "none"; }
    modalClose.onclick = closeModal;
    modalBack.addEventListener("click",(e)=>{ if(e.target===modalBack) closeModal(); });

    document.querySelectorAll(".menu button").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".menu button").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        const tab = btn.dataset.tab;
        document.querySelectorAll("main section").forEach(sec=>sec.classList.add("hidden"));
        document.getElementById("tab-" + tab).classList.remove("hidden");

        if(tab==="agenda") loadAgenda();
        if(tab==="clientes") loadCustomers();
        if(tab==="profissionais") loadProfessionals();
        if(tab==="servicos") loadServices();
        if(tab==="horarios") loadWorkingHours();
      });
    });

    btnGoAgenda.onclick = ()=>{
      document.querySelectorAll(".menu button").forEach(b=>b.classList.remove("active"));
      document.querySelector('.menu button[data-tab="agenda"]').classList.add("active");
      document.querySelectorAll("main section").forEach(sec=>sec.classList.add("hidden"));
      document.getElementById("tab-agenda").classList.remove("hidden");
      loadAgenda();
    };

    btnLogin.onclick = async ()=>{
      clearError();
      btnLogin.disabled = true;
      btnLogin.textContent = "Entrando...";
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;

      const { error } = await sb.auth.signInWithPassword({ email, password });

      btnLogin.disabled = false;
      btnLogin.textContent = "Entrar";
      if (error) return showError("E-mail ou senha inválidos.");

      await bootstrap();
    };

    btnLogout.onclick = async ()=>{
      try{
        await sb.auth.signOut();
      } finally {
        resetState();
        showLogin();
        toastMsg("ok","Sessão encerrada.");
      }
    };

    btnRefresh.onclick = async ()=>{
      await refreshAll();
      toastMsg("ok","Atualizado.");
    };

    quickNewCustomer.onclick = ()=> openCustomerModal();
    quickNewPro.onclick = ()=> openProModal();
    quickNewService.onclick = ()=> openServiceModal();

    btnAgendaReload.onclick = loadAgenda;
    btnNewAppointment && (btnNewAppointment.onclick = ()=> openNewAppointmentModal());
    btnCustomersReload.onclick = loadCustomers;
    btnProsReload.onclick = loadProfessionals;
    btnServReload.onclick = loadServices;

    btnNewCustomer.onclick = ()=> openCustomerModal();
    btnNewPro.onclick = ()=> openProModal();
    btnNewService.onclick = ()=> openServiceModal();

    agendaDate.onchange = loadAgenda;
    agendaPro.onchange = loadAgenda;

    let searchTimer = null;
    searchCustomer.oninput = ()=>{
      clearTimeout(searchTimer);
      searchTimer = setTimeout(loadCustomers, 250);
    };

    // Working hours actions
    btnWhReload.onclick = loadWorkingHours;

    // >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
    // IMPORTANTÍSSIMO MULTI-EMPRESA:
    // Todos inserts/updates usam state.profile.company_id
    // >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

    btnWhAdd.onclick = async ()=>{
      const professional_id = whPro.value;
      const weekday = Number(whWeekday.value);
      const start_time = whStart.value;
      const end_time = whEnd.value;
      const slot_minutes = Number(whSlot.value || 30);

      if(!professional_id) return toastMsg("err","Selecione um profissional.");
      if(!start_time || !end_time) return toastMsg("err","Informe início e fim.");
      if(start_time >= end_time) return toastMsg("err","Início deve ser menor que fim.");
      if(slot_minutes < 10 || slot_minutes > 180) return toastMsg("err","Slot inválido.");
      if(!state?.profile?.company_id) return toastMsg("err","Sessão inválida (sem company_id).");

      const payload = {
        company_id: state.profile.company_id,
        professional_id,
        weekday,
        start_time,
        end_time,
        slot_minutes
      };

      const { error } = await sb.from("working_hours").insert(payload);
      if(error) return toastMsg("err", "Erro ao salvar horário.");
      toastMsg("ok","Horário salvo.");
      await loadWorkingHours();
    };

    btnWhDefault.onclick = async ()=>{
      const professional_id = whPro.value;
      if(!professional_id) return toastMsg("err","Selecione um profissional.");
      if(!state?.profile?.company_id) return toastMsg("err","Sessão inválida (sem company_id).");

      const ok = confirm("Aplicar padrão Seg–Sex 09:00–18:00 (slot 30) para este profissional? Isso adiciona novos horários.");
      if(!ok) return;

      const rows = [1,2,3,4,5].map(weekday=>({
        company_id: state.profile.company_id,
        professional_id,
        weekday,
        start_time: "09:00",
        end_time: "18:00",
        slot_minutes: 30
      }));

      const { error } = await sb.from("working_hours").insert(rows);
      if(error) return toastMsg("err","Erro ao aplicar padrão (talvez duplicado).");
      toastMsg("ok","Padrão aplicado.");
      await loadWorkingHours();
    };

    async function bootstrap(){
      resetState();

      const { data: sess } = await sb.auth.getSession();
      if(!sess.session){ showLogin(); return; }
      showApp();

      const { data: u } = await sb.auth.getUser();
      state.user = u?.user || null;
      if(!state.user){ showLogin(); return; }

      const { data: prof, error: e1 } = await sb
        .from("profiles")
        .select("company_id, role, display_name")
        .eq("user_id", state.user.id)
        .maybeSingle();

      if(e1 || !prof){
        showError("Usuário sem vínculo no profiles. (Seu SQL já deveria ter criado esse vínculo).");
        await sb.auth.signOut();
        resetState();
        showLogin();
        return;
      }

      state.profile = prof;
      state.role = prof.role || "staff";
      state.isAdmin = state.role === "admin";

      roleBox.textContent = state.isAdmin ? "ADMIN" : "STAFF";

      const { data: comp, error: e2 } = await sb
        .from("companies")
        .select("name, slug, status, paid_until")
        .eq("id", prof.company_id)
        .maybeSingle();

      if(e2 || !comp){
        showError("Empresa não encontrada para este usuário.");
        await sb.auth.signOut();
        resetState();
        showLogin();
        return;
      }

      state.company = comp;

      who.textContent = `Usuário: ${prof.display_name || state.user.email} • Perfil: ${state.role}`;
      companyPill.textContent = `Empresa: ${comp.name}`;

      agendaDate.value = todayISO();

      await refreshAll();
    }

    async function refreshAll(){
      await loadMaps();
      await loadCounts();
      await loadDashboard();
      await loadDashboardOverview();
      await fillWorkingHoursPros();
    }

    async function loadMaps(){
      const companyId = state?.profile?.company_id;
      if(!companyId) return;

      const { data: pros } = await sb
        .from("professionals")
        .select("id,name,active,company_id")
        .eq("company_id", companyId)
        .order("name",{ascending:true});

      const { data: serv } = await sb
        .from("services")
        .select("id,name,active,duration_minutes,price_cents,company_id")
        .eq("company_id", companyId)
        .order("name",{ascending:true});

      state.pros = pros || [];
      state.serv = serv || [];
      state.prosMap = Object.fromEntries((pros||[]).map(p=>[p.id, p.name]));
      state.servMap = Object.fromEntries((serv||[]).map(s=>[s.id, s.name]));

      agendaPro.innerHTML = `<option value="">Todos os profissionais</option>`;
      (pros||[]).forEach(p=>{ if(p.active) agendaPro.innerHTML += `<option value="${p.id}">${p.name}</option>`; });
    }

    async function fillWorkingHoursPros(){
      whPro.innerHTML = `<option value="">Selecione um profissional</option>`;
      (state.pros || []).forEach(p=>{
        if(p.active) whPro.innerHTML += `<option value="${p.id}">${p.name}</option>`;
      });
      whPro.onchange = loadWorkingHours;
    }

    async function loadCounts(){
      const companyId = state?.profile?.company_id;
      if(!companyId) return;

      const { count: cAppt } = await sb.from("appointments").select("id",{count:"exact",head:true}).eq("company_id", companyId);
      const { count: cCust } = await sb.from("customers").select("id",{count:"exact",head:true}).eq("company_id", companyId);
      const { count: cPros } = await sb.from("professionals").select("id",{count:"exact",head:true}).eq("company_id", companyId);
      const { count: cServ } = await sb.from("services").select("id",{count:"exact",head:true}).eq("company_id", companyId);
      const { count: cWh }   = await sb.from("working_hours").select("id",{count:"exact",head:true}).eq("company_id", companyId);

      badgeAgenda.textContent = cAppt ?? "0";
      badgeClientes.textContent = cCust ?? "0";
      badgePros.textContent = cPros ?? "0";
      badgeServ.textContent = cServ ?? "0";
      badgeHours.textContent = cWh ?? "0";

      const d = agendaDate.value || todayISO();
      const { start, end } = dayRangeUTC(d);

      const { count: cToday } = await sb
        .from("appointments")
        .select("id",{count:"exact",head:true})
        .eq("company_id", companyId)
        .gte("starts_at", start)
        .lt("starts_at", end);

      badgeToday.textContent = cToday ?? "0";
    }

    async function loadDashboard(){
      const companyId = state?.profile?.company_id;
      if(!companyId){
        kpiToday.textContent="—"; kpiConf.textContent="—"; kpiCanc.textContent="—"; kpiDone.textContent="—";
      kpiApptToday.textContent="—"; kpiRevenueToday.textContent="—"; kpiBusiestPro.textContent="—"; kpiBusiestHour.textContent="—";
      alertBadge.textContent="—"; alertsBox.innerHTML = "<div>—</div>";
        tbodyNext.innerHTML = `<tr><td colspan="5">Sessão inválida (sem company_id).</td></tr>`;
        return;
      }

      const d = todayISO();
      const { start, end } = dayRangeUTC(d);

      const { data, error } = await sb
        .from("appointments")
        .select("status, starts_at")
        .eq("company_id", companyId)
        .gte("starts_at", start)
        .lt("starts_at", end);

      if(error){
        kpiToday.textContent="—"; kpiConf.textContent="—"; kpiCanc.textContent="—"; kpiDone.textContent="—";
      kpiApptToday.textContent="—"; kpiRevenueToday.textContent="—"; kpiBusiestPro.textContent="—"; kpiBusiestHour.textContent="—";
      alertBadge.textContent="—"; alertsBox.innerHTML = "<div>—</div>";
      } else {
        const total = (data||[]).length;
        const conf = (data||[]).filter(x=>x.status==="confirmed").length;
        const canc = (data||[]).filter(x=>x.status==="cancelled").length;
        const done = (data||[]).filter(x=>x.status==="done").length;
        kpiToday.textContent = total;
        kpiConf.textContent = conf;
        kpiCanc.textContent = canc;
        kpiDone.textContent = done;
      }

      const now = new Date().toISOString();
      const { data: next, error: e2 } = await sb
        .from("appointments")
        .select("id, starts_at, status, customer_name, professional_id, service_id")
        .eq("company_id", companyId)
        .gte("starts_at", now)
        .order("starts_at",{ascending:true})
        .limit(20);

      tbodyNext.innerHTML = "";
      if(e2 || !next || !next.length){
        tbodyNext.innerHTML = `<tr><td colspan="5">Nenhum agendamento futuro.</td></tr>`;
      } else {
        next.forEach(a=>{
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${fmtDateTime(a.starts_at)}</td>
            <td>${state.prosMap[a.professional_id] || "—"}</td>
            <td>${state.servMap[a.service_id] || "—"}</td>
            <td>${a.customer_name || "—"}</td>
            <td>${tagStatus(a.status)}</td>
          `;
          tbodyNext.appendChild(tr);
        });
      }
    }

    
    async function loadDashboardOverview(){
      const companyId = state?.profile?.company_id;
      if(!companyId){
        kpiApptToday.textContent="—";
        kpiRevenueToday.textContent="—";
        kpiBusiestPro.textContent="—";
        kpiBusiestHour.textContent="—";
        alertBadge.textContent="—";
        alertsBox.innerHTML = "<div>Sessão inválida (sem company_id).</div>";
        return;
      }

      const { data, error } = await sb.rpc("dashboard_overview");
      if(error || !data){
        // Fallback silencioso (mantém painel funcionando mesmo sem as functions)
        kpiApptToday.textContent="—";
        kpiRevenueToday.textContent="—";
        kpiBusiestPro.textContent="—";
        kpiBusiestHour.textContent="—";
        alertBadge.textContent="—";
        alertsBox.innerHTML = `<div>Não foi possível carregar as métricas avançadas.</div>`;
        return;
      }

      // TODAY
      const today = data.today || {};
      kpiApptToday.textContent = Number(today.appointments_today || 0);
      kpiRevenueToday.textContent = money(Number(today.revenue_today_cents || 0));

      // WEEK
      const week = data.week || {};
      const bProName = week.busiest_professional_name;
      const bProCount = Number(week.busiest_professional_count || 0);
      kpiBusiestPro.textContent = (bProName ? `${bProName} (${bProCount})` : "—");

      const bHour = week.busiest_hour;
      const bHourCount = Number(week.busiest_hour_count || 0);
      kpiBusiestHour.textContent = (bHour ? `${String(bHour).padStart(2,"0")}:00 (${bHourCount})` : "—");

      // ALERTS
      const alerts = data.alerts || {};
      const agendaEmptyTomorrow = !!alerts.agenda_empty_tomorrow;
      const prosWithoutHours = Array.isArray(alerts.professionals_without_hours) ? alerts.professionals_without_hours : [];

      const items = [];
      if(agendaEmptyTomorrow){
        items.push(`<div><span class="tag bad">Atenção</span> Agenda vazia amanhã.</div>`);
      } else {
        items.push(`<div><span class="tag ok">OK</span> Há agendamentos para amanhã.</div>`);
      }

      if(prosWithoutHours.length){
        const names = prosWithoutHours
          .map(x => x?.professional_name || x?.name || x?.professional || "Profissional")
          .slice(0, 8)
          .join(", ");
        items.push(`<div><span class="tag warn">Aviso</span> Profissionais sem horário cadastrado: <b>${esc(names)}</b>${prosWithoutHours.length>8 ? "…" : ""}</div>`);
      } else {
        items.push(`<div><span class="tag ok">OK</span> Todos os profissionais ativos possuem horário cadastrado.</div>`);
      }

      alertsBox.innerHTML = items.join("");
      const totalAlerts = (agendaEmptyTomorrow ? 1 : 0) + (prosWithoutHours.length ? 1 : 0);
      alertBadge.textContent = totalAlerts ? String(totalAlerts) : "0";
    }


    async function loadAgenda(){
      const companyId = state?.profile?.company_id;
      if(!companyId){
        tbodyAgenda.innerHTML = `<tr><td colspan="7">Sessão inválida (sem company_id).</td></tr>`;
        return;
      }

      const date = agendaDate.value || todayISO();
      const { start, end } = dayRangeUTC(date);
      const proId = agendaPro.value;

      let q = sb
        .from("appointments")
        .select("id, company_id, starts_at, status, customer_name, customer_phone, professional_id, service_id")
        .eq("company_id", companyId)
        .gte("starts_at", start)
        .lt("starts_at", end)
        .neq("status", "done")
        .order("starts_at",{ascending:true});

      if(proId) q = q.eq("professional_id", proId);

      const { data, error } = await q;

      // filtro local (rápido) para busca na tela sem complicar o SQL
      const aTerm = (agendaSearch?.value || "").trim().toLowerCase();
      let list = data || [];
      if(aTerm){
        list = list.filter(x =>
          (x.customer_name||"").toLowerCase().includes(aTerm) ||
          (x.customer_phone||"").toLowerCase().includes(aTerm)
        );
      }

      tbodyAgenda.innerHTML = "";
      if(error){
        tbodyAgenda.innerHTML = `<tr><td colspan="7">Erro ao carregar agenda.</td></tr>`;
        return;
      }
      if(!list?.length){
        tbodyAgenda.innerHTML = `<tr><td colspan="7">Nenhum agendamento para este filtro.</td></tr>`;
        return;
      }

      list.forEach(a=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${fmtTime(a.starts_at)}</td>
          <td>${state.prosMap[a.professional_id] || "—"}</td>
          <td>${state.servMap[a.service_id] || "—"}</td>
          <td>
            <button class="linkBtn" onclick="openCustomerHistoryFromAgenda('${a.customer_name||""}','${a.customer_phone||""}')">
              ${a.customer_name || "—"}
            </button>
          </td>
          <td>
            <div class="phoneCell">
              <span>${a.customer_phone || "—"}</span>
              ${renderWhatsAppBtn(a.customer_phone, a.customer_name)}
            </div>
          </td>
          <td>${tagStatus(a.status)}</td>
          <td>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn2" data-act="confirm" data-id="${a.id}">Confirmar</button>
              <button class="btn2" data-act="done" data-id="${a.id}">Finalizar</button>
              <button class="btn2 btnDanger" data-act="cancel" data-id="${a.id}">Cancelar</button>
              ${state.isAdmin ? `<button class="btn2 btnDanger" data-act="del" data-id="${a.id}">Excluir</button>` : ""}
            </div>
          </td>
        `;
        tbodyAgenda.appendChild(tr);
      });

      tbodyAgenda.querySelectorAll("button[data-act]").forEach(b=>{
        b.onclick = ()=> onAgendaAction(b.dataset.act, b.dataset.id);
      });

      await loadCounts();
    }

    async function loadHistory(){
      const companyId = state?.profile?.company_id;
      if(!companyId){
        tbodyHistorico.innerHTML = `<tr><td colspan="7">Sessão inválida (sem company_id).</td></tr>`;
        return;
      }

      // Defaults: últimos 7 dias
      if(!histStart.value || !histEnd.value){
        const today = new Date();
        const end = today.toISOString().slice(0,10);
        const startDate = new Date(today);
        startDate.setDate(startDate.getDate() - 7);
        const start = startDate.toISOString().slice(0,10);
        histStart.value = start;
        histEnd.value = end;
      }

      const startDay = histStart.value;
      const endDay = histEnd.value;
      const proId = histPro.value;
      const term = (histSearch.value || "").trim().toLowerCase();

      const { start: startTs } = dayRangeUTC(startDay);
      // endDay inclusive -> range até o final do dia
      const { end: endTs } = dayRangeUTC(endDay);

      let q = sb
        .from("appointments")
        .select("id, starts_at, ends_at, status, customer_name, customer_phone, professional_id, service_id")
        .eq("company_id", companyId)
        .eq("status", "done")
        .gte("starts_at", startTs)
        .lt("starts_at", endTs)
        .order("starts_at", { ascending: false });

      if(proId) q = q.eq("professional_id", proId);

      const { data, error } = await q;

      tbodyHistorico.innerHTML = "";
      if(error){
        tbodyHistorico.innerHTML = `<tr><td colspan="7">Erro ao carregar histórico.</td></tr>`;
        return;
      }

      let list = data || [];
      if(term){
        list = list.filter(x =>
          (x.customer_name||"").toLowerCase().includes(term) ||
          (x.customer_phone||"").toLowerCase().includes(term)
        );
      }

      if(!list.length){
        tbodyHistorico.innerHTML = `<tr><td colspan="7">Nenhum registro no período.</td></tr>`;
        badgeHistorico.textContent = "0";
        return;
      }

      badgeHistorico.textContent = String(list.length);

      list.forEach(a=>{
        const d = fmtDate(a.starts_at);
        const t = fmtTime(a.starts_at);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${d}</td>
          <td>${t}</td>
          <td>${state.prosMap[a.professional_id] || "—"}</td>
          <td>${state.servMap[a.service_id] || "—"}</td>
          <td>${a.customer_name || "—"}</td>
          <td>
            <div class="phoneCell">
              <span>${a.customer_phone || "—"}</span>
              ${renderWhatsAppBtn(a.customer_phone, a.customer_name)}
            </div>
          </td>
          <td>${tagStatus(a.status)}</td>
        `;
        tbodyHistorico.appendChild(tr);
      });
    }

    // Botões rápidos do Histórico
    if(btnHistToday){
      btnHistToday.onclick = async ()=>{
        const d = todayISO();
        histStart.value = d; histEnd.value = d;
        await loadHistory();
      };
    }
    if(btnHist7){
      btnHist7.onclick = async ()=>{
        const today = new Date();
        const end = today.toISOString().slice(0,10);
        const startDate = new Date(today); startDate.setDate(startDate.getDate()-7);
        histStart.value = startDate.toISOString().slice(0,10);
        histEnd.value = end;
        await loadHistory();
      };
    }
    if(btnHist30){
      btnHist30.onclick = async ()=>{
        const today = new Date();
        const end = today.toISOString().slice(0,10);
        const startDate = new Date(today); startDate.setDate(startDate.getDate()-30);
        histStart.value = startDate.toISOString().slice(0,10);
        histEnd.value = end;
        await loadHistory();
      };
    }
    if(btnHistReload){
      btnHistReload.onclick = loadHistory;
    }
    if(histSearch){
      histSearch.addEventListener("input", debounce(loadHistory, 250));
    }
    if(histPro){
      histPro.onchange = loadHistory;
    }
    if(histStart) histStart.onchange = loadHistory;
    if(histEnd) histEnd.onchange = loadHistory;

    // Excluir histórico por data (somente ADMIN)
    if(btnHistClear){
      btnHistClear.onclick = async ()=>{
        if(!state.isAdmin) return toastMsg("err","Apenas ADMIN pode excluir histórico.");
        const startDay = histStart.value;
        const endDay = histEnd.value;
        if(!startDay || !endDay) return toastMsg("err","Informe data inicial e final.");
        const ok = confirm(`Excluir histórico (DONE) de ${startDay} até ${endDay}?`);
        if(!ok) return;

        const { start: startTs } = dayRangeUTC(startDay);
        const { end: endTs } = dayRangeUTC(endDay);

        const { error } = await sb
          .from("appointments")
          .delete()
          .eq("company_id", state.profile.company_id)
          .eq("status", "done")
          .gte("starts_at", startTs)
          .lt("starts_at", endTs);

        if(error) return toastMsg("err","Erro ao excluir histórico (verifique policy/admin).");
        toastMsg("ok","Histórico excluído.");
        await loadHistory();
        await loadDashboard();
        await loadDashboardOverview();
      };
    }


    async function onAgendaAction(act, id){
      if(act==="del" && !state.isAdmin) return toastMsg("err","Apenas ADMIN pode excluir.");
      if(act==="del"){
        const ok = confirm("Excluir este agendamento? Essa ação não pode ser desfeita.");
        if(!ok) return;
        const { error } = await sb.from("appointments").delete().eq("id", id).eq("company_id", state.profile.company_id);
        if(error) return toastMsg("err","Erro ao excluir.");
        toastMsg("ok","Agendamento excluído.");
        await loadAgenda(); await loadDashboard(); await loadDashboardOverview();
      await loadDashboardOverview();
        return;
      }
      let status = "confirmed";
      if(act==="cancel") status = "cancelled";
      if(act==="done") status = "done";
      if(act==="confirm") status = "confirmed";

      const { error } = await sb.from("appointments").update({ status }).eq("id", id).eq("company_id", state.profile.company_id);
      if(error) return toastMsg("err","Erro ao atualizar status.");
      toastMsg("ok","Status atualizado.");
      await loadAgenda();
      // Se foi finalizado, atualiza também o Histórico para aparecer imediatamente.
      if(status === "done"){
        try { await loadHistory(); } catch(e) {}
      }
      await loadDashboard();
      await loadDashboardOverview();
    }

    async function loadCustomers(){
      const term = (searchCustomer.value || "").trim().toLowerCase();
      const { data, error } = await sb
        .from("customers")
        .select("id, full_name, phone, email, document, birth_date, address, notes")
        .eq("company_id", state.profile.company_id)
        .order("full_name",{ascending:true})
        .limit(200);

      tbodyCustomers.innerHTML = "";
      if(error){ tbodyCustomers.innerHTML = `<tr><td colspan="5">Erro ao carregar clientes.</td></tr>`; return; }

      let list = data || [];
      if(term){
        list = list.filter(c =>
          (c.full_name||"").toLowerCase().includes(term) ||
          (c.phone||"").toLowerCase().includes(term)
        );
      }
      if(!list.length){
        tbodyCustomers.innerHTML = `<tr><td colspan="5">Nenhum cliente encontrado.</td></tr>`;
        badgeClientes.textContent = "0";
        return;
      }
      badgeClientes.textContent = String(list.length);

      list.forEach(c=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${c.full_name || "—"}</td>
          <td>
            <div class="phoneCell">
              <span>${c.phone || "—"}</span>
              ${renderWhatsAppBtn(c.phone, c.full_name, true)}
            </div>
          </td>
          <td>${c.email || "—"}</td>
          <td>${c.document || "—"}</td>
          <td>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn2" onclick="openCustomerModal(\'${encodeURIComponent(JSON.stringify(c))}\')">Editar</button>
              <button class="btn2" onclick="openCustomerHistory(\'${encodeURIComponent(JSON.stringify(c))}\')">Histórico</button>
              ${state.isAdmin ? `<button class="btn2 btnDanger" onclick="deleteCustomer('${c.id}')">Excluir</button>` : ""}
            </div>
          </td>
        `;
        tbodyCustomers.appendChild(tr);
      });
    }

    async function loadProfessionals(){
      const { data, error } = await sb
        .from("professionals")
        .select("id,name,active")
        .eq("company_id", state.profile.company_id)
        .order("name",{ascending:true});

      tbodyPros.innerHTML = "";
      if(error){ tbodyPros.innerHTML = `<tr><td colspan="3">Erro ao carregar profissionais.</td></tr>`; return; }
      if(!data.length){ tbodyPros.innerHTML = `<tr><td colspan="3">Nenhum profissional cadastrado.</td></tr>`; return; }

      badgePros.textContent = String(data.length);

      data.forEach(p=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.name}</td>
          <td>${p.active ? `<span class="tag ok">Ativo</span>` : `<span class="tag bad">Inativo</span>`}</td>
          <td>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn2" onclick="openProModal(\'${encodeURIComponent(JSON.stringify(p))}\')">Editar</button>
              <button class="btn2" onclick="togglePro('${p.id}', ${p.active})">${p.active ? "Inativar" : "Ativar"}</button>
              ${state.isAdmin ? `<button class="btn2 btnDanger" onclick="deletePro('${p.id}')">Excluir</button>` : ""}
            </div>
          </td>
        `;
        tbodyPros.appendChild(tr);
      });

      await loadMaps();
      await fillWorkingHoursPros();
    }

    async function loadServices(){
      const { data, error } = await sb
        .from("services")
        .select("id,name,duration_minutes,price_cents,active")
        .eq("company_id", state.profile.company_id)
        .order("name",{ascending:true});

      tbodyServ.innerHTML = "";
      if(error){ tbodyServ.innerHTML = `<tr><td colspan="5">Erro ao carregar serviços.</td></tr>`; return; }
      if(!data.length){ tbodyServ.innerHTML = `<tr><td colspan="5">Nenhum serviço cadastrado.</td></tr>`; return; }

      badgeServ.textContent = String(data.length);

      data.forEach(s=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${s.name}</td>
          <td>${s.duration_minutes} min</td>
          <td>${money(s.price_cents)}</td>
          <td>${s.active ? `<span class="tag ok">Ativo</span>` : `<span class="tag bad">Inativo</span>`}</td>
          <td>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn2" onclick="openServiceModal(\'${encodeURIComponent(JSON.stringify(s))}\')">Editar</button>
              <button class="btn2" onclick="toggleService('${s.id}', ${s.active})">${s.active ? "Inativar" : "Ativar"}</button>
              ${state.isAdmin ? `<button class="btn2 btnDanger" onclick="deleteService('${s.id}')">Excluir</button>` : ""}
            </div>
          </td>
        `;
        tbodyServ.appendChild(tr);
      });

      await loadMaps();
    }

    async function loadWorkingHours(){
      const proId = whPro.value;

      let q = sb
        .from("working_hours")
        .select("id, professional_id, weekday, start_time, end_time, slot_minutes")
        .eq("company_id", state.profile.company_id)
        .order("professional_id",{ascending:true})
        .order("weekday",{ascending:true})
        .order("start_time",{ascending:true});

      if(proId) q = q.eq("professional_id", proId);

      const { data, error } = await q;

      tbodyHours.innerHTML = "";
      if(error){
        tbodyHours.innerHTML = `<tr><td colspan="6">Erro ao carregar horários.</td></tr>`;
        return;
      }
      if(!data.length){
        tbodyHours.innerHTML = `<tr><td colspan="6">Nenhum horário cadastrado.</td></tr>`;
        return;
      }

      data.forEach(w=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${state.prosMap[w.professional_id] || "—"}</td>
          <td>${weekdayLabel(w.weekday)}</td>
          <td>${w.start_time}</td>
          <td>${w.end_time}</td>
          <td>${w.slot_minutes} min</td>
          <td>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn2" onclick="editWH('${w.id}')">Editar</button>
              ${state.isAdmin ? `<button class="btn2 btnDanger" onclick="deleteWH('${w.id}')">Excluir</button>` : ""}
            </div>
          </td>
        `;
        tbodyHours.appendChild(tr);
      });

      await loadCounts();
    }

    // ----- MODAIS / CRUD -----
    function esc(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    window.openCustomerModal = (encoded)=>{
      let c=null;
      if(encoded) c = JSON.parse(decodeURIComponent(encoded));
      const isEdit = !!c;
      c = c || { id:null, full_name:"", phone:"", email:"", document:"", birth_date:"", address:"", notes:"" };

      openModal(
        isEdit ? "Editar Cliente" : "Novo Cliente",
        `
          <div class="row2">
            <div><label>Nome completo</label><input id="c_full_name" value="${esc(c.full_name)}"/></div>
            <div><label>Telefone</label><input id="c_phone" value="${esc(c.phone||"")}"/></div>
          </div>
          <div class="row2">
            <div><label>E-mail</label><input id="c_email" value="${esc(c.email||"")}"/></div>
            <div><label>Documento</label><input id="c_document" value="${esc(c.document||"")}"/></div>
          </div>
          <div class="row2">
            <div><label>Nascimento</label><input id="c_birth" type="date" value="${c.birth_date||""}"/></div>
            <div><label>Endereço</label><input id="c_address" value="${esc(c.address||"")}"/></div>
          </div>
          <div><label>Observações</label><input id="c_notes" value="${esc(c.notes||"")}"/></div>
        `,
        `
          <button class="btn2" onclick="window.__closeModal()">Cancelar</button>
          <button class="btn" onclick="window.saveCustomer('${c.id||""}')">${isEdit ? "Salvar" : "Cadastrar"}</button>
        `
      );
    };

    window.saveCustomer = async (id)=>{
      if(!state?.profile?.company_id) return toastMsg("err","Sessão inválida (sem company_id).");

      const payload = {
        company_id: state.profile.company_id,
        full_name: document.getElementById("c_full_name").value.trim(),
        phone: document.getElementById("c_phone").value.trim() || null,
        email: document.getElementById("c_email").value.trim() || null,
        document: document.getElementById("c_document").value.trim() || null,
        birth_date: document.getElementById("c_birth").value || null,
        address: document.getElementById("c_address").value.trim() || null,
        notes: document.getElementById("c_notes").value.trim() || null
      };
      if(payload.full_name.length < 2) return toastMsg("err","Nome inválido.");

      let res;
      if(id){
        // update não precisa regravar company_id, mas não atrapalha
        res = await sb.from("customers").update(payload).eq("id", id).eq("company_id", state.profile.company_id);
      } else {
        res = await sb.from("customers").insert(payload);
      }

      if(res.error) return toastMsg("err","Erro ao salvar cliente.");
      toastMsg("ok", id ? "Cliente atualizado." : "Cliente cadastrado.");
      closeModal();
      await loadCustomers(); await loadCounts();
    };

    window.deleteCustomer = async (id)=>{
      if(!state.isAdmin) return toastMsg("err","Apenas ADMIN pode excluir.");
      if(!confirm("Excluir cliente?")) return;
      const { error } = await sb.from("customers").delete().eq("id", id).eq("company_id", state.profile.company_id);
      if(error) return toastMsg("err","Erro ao excluir.");
      toastMsg("ok","Cliente excluído.");
      await loadCustomers(); await loadCounts();
    };

    window.openProModal = (encoded)=>{
      let p=null;
      if(encoded) p = JSON.parse(decodeURIComponent(encoded));
      const isEdit = !!p;
      p = p || { id:null, name:"", active:true };

      openModal(
        isEdit ? "Editar Profissional" : "Novo Profissional",
        `
          <div class="row2">
            <div><label>Nome</label><input id="p_name" value="${esc(p.name)}"/></div>
            <div>
              <label>Status</label>
              <select id="p_active">
                <option value="true" ${p.active ? "selected":""}>Ativo</option>
                <option value="false" ${!p.active ? "selected":""}>Inativo</option>
              </select>
            </div>
          </div>
        `,
        `
          <button class="btn2" onclick="window.__closeModal()">Cancelar</button>
          <button class="btn" onclick="window.savePro('${p.id||""}')">${isEdit ? "Salvar" : "Cadastrar"}</button>
        `
      );
    };

    window.savePro = async (id)=>{
      if(!state?.profile?.company_id) return toastMsg("err","Sessão inválida (sem company_id).");

      const name = document.getElementById("p_name").value.trim();
      const active = document.getElementById("p_active").value === "true";
      if(name.length < 2) return toastMsg("err","Nome inválido.");

      let res;
      if(id){
        res = await sb.from("professionals").update({ name, active }).eq("id", id).eq("company_id", state.profile.company_id);
      } else {
        res = await sb.from("professionals").insert({ company_id: state.profile.company_id, name, active });
      }

      if(res.error) return toastMsg("err","Erro ao salvar profissional.");
      toastMsg("ok", id ? "Profissional atualizado." : "Profissional cadastrado.");
      closeModal();
      await loadProfessionals(); await loadCounts();
    };

    window.togglePro = async (id, active)=>{
      const { error } = await sb.from("professionals").update({ active: !active }).eq("id", id).eq("company_id", state.profile.company_id);
      if(error) return toastMsg("err","Erro ao atualizar.");
      toastMsg("ok","Atualizado.");
      await loadProfessionals(); await loadCounts();
    };

    window.deletePro = async (id)=>{
      if(!state.isAdmin) return toastMsg("err","Apenas ADMIN pode excluir.");
      if(!confirm("Excluir profissional?")) return;
      const { error } = await sb.from("professionals").delete().eq("id", id).eq("company_id", state.profile.company_id);
      if(error) return toastMsg("err","Erro ao excluir.");
      toastMsg("ok","Profissional excluído.");
      await loadProfessionals(); await loadCounts();
    };

    window.openServiceModal = (encoded)=>{
      let s=null;
      if(encoded) s = JSON.parse(decodeURIComponent(encoded));
      const isEdit = !!s;
      s = s || { id:null, name:"", duration_minutes:30, price_cents:0, active:true };

      openModal(
        isEdit ? "Editar Serviço" : "Novo Serviço",
        `
          <div class="row2">
            <div><label>Nome do serviço</label><input id="s_name" value="${esc(s.name)}"/></div>
            <div><label>Duração (min)</label><input id="s_dur" type="number" min="10" max="480" value="${Number(s.duration_minutes||30)}"/></div>
          </div>
          <div class="row2">
            <div><label>Preço (R$)</label><input id="s_price" type="number" step="0.01" value="${(Number(s.price_cents||0)/100).toFixed(2)}"/></div>
            <div>
              <label>Status</label>
              <select id="s_active">
                <option value="true" ${s.active ? "selected":""}>Ativo</option>
                <option value="false" ${!s.active ? "selected":""}>Inativo</option>
              </select>
            </div>
          </div>
        `,
        `
          <button class="btn2" onclick="window.__closeModal()">Cancelar</button>
          <button class="btn" onclick="window.saveService('${s.id||""}')">${isEdit ? "Salvar" : "Cadastrar"}</button>
        `
      );
    };

    window.saveService = async (id)=>{
      if(!state?.profile?.company_id) return toastMsg("err","Sessão inválida (sem company_id).");

      const name = document.getElementById("s_name").value.trim();
      const duration_minutes = Number(document.getElementById("s_dur").value || 30);
      const price = Number(document.getElementById("s_price").value || 0);
      const price_cents = Math.round(price * 100);
      const active = document.getElementById("s_active").value === "true";

      if(name.length < 2) return toastMsg("err","Nome inválido.");
      if(duration_minutes < 10 || duration_minutes > 480) return toastMsg("err","Duração inválida.");

      let res;
      if(id){
        res = await sb.from("services").update({ name, duration_minutes, price_cents, active }).eq("id", id).eq("company_id", state.profile.company_id);
      } else {
        res = await sb.from("services").insert({ company_id: state.profile.company_id, name, duration_minutes, price_cents, active });
      }

      if(res.error) return toastMsg("err","Erro ao salvar serviço.");
      toastMsg("ok", id ? "Serviço atualizado." : "Serviço cadastrado.");
      closeModal();
      await loadServices(); await loadCounts();
    };

    window.toggleService = async (id, active)=>{
      const { error } = await sb.from("services").update({ active: !active }).eq("id", id).eq("company_id", state.profile.company_id);
      if(error) return toastMsg("err","Erro ao atualizar.");
      toastMsg("ok","Atualizado.");
      await loadServices(); await loadCounts();
    };

    window.deleteService = async (id)=>{
      if(!state.isAdmin) return toastMsg("err","Apenas ADMIN pode excluir.");
      if(!confirm("Excluir serviço?")) return;
      const { error } = await sb.from("services").delete().eq("id", id).eq("company_id", state.profile.company_id);
      if(error) return toastMsg("err","Erro ao excluir.");
      toastMsg("ok","Serviço excluído.");
      await loadServices(); await loadCounts();
    };

    // Working hours edit/delete
    window.editWH = async (id)=>{
      const { data, error } = await sb.from("working_hours")
        .select("id, professional_id, weekday, start_time, end_time, slot_minutes")
        .eq("company_id", state.profile.company_id)
        .eq("id", id).maybeSingle();

      if(error || !data) return toastMsg("err","Erro ao abrir horário.");

      openModal(
        "Editar Horário",
        `
          <div class="row2">
            <div>
              <label>Profissional</label>
              <select id="wh_e_pro">
                ${state.pros.filter(p=>p.active).map(p=>`<option value="${p.id}" ${p.id===data.professional_id?"selected":""}>${p.name}</option>`).join("")}
              </select>
            </div>
            <div>
              <label>Dia</label>
              <select id="wh_e_day">
                ${[0,1,2,3,4,5,6].map(w=>`<option value="${w}" ${Number(w)===Number(data.weekday)?"selected":""}>${weekdayLabel(w)}</option>`).join("")}
              </select>
            </div>
          </div>
          <div class="row2">
            <div><label>Início</label><input id="wh_e_start" type="time" value="${data.start_time}"/></div>
            <div><label>Fim</label><input id="wh_e_end" type="time" value="${data.end_time}"/></div>
          </div>
          <div><label>Slot (min)</label><input id="wh_e_slot" type="number" min="10" max="180" value="${data.slot_minutes}"/></div>
        `,
        `
          <button class="btn2" onclick="window.__closeModal()">Cancelar</button>
          <button class="btn" onclick="window.saveWH('${data.id}')">Salvar</button>
        `
      );
    };

    window.saveWH = async (id)=>{
      if(!state?.profile?.company_id) return toastMsg("err","Sessão inválida (sem company_id).");

      const professional_id = document.getElementById("wh_e_pro").value;
      const weekday = Number(document.getElementById("wh_e_day").value);
      const start_time = document.getElementById("wh_e_start").value;
      const end_time = document.getElementById("wh_e_end").value;
      const slot_minutes = Number(document.getElementById("wh_e_slot").value || 30);

      if(start_time >= end_time) return toastMsg("err","Início deve ser menor que fim.");
      if(slot_minutes < 10 || slot_minutes > 180) return toastMsg("err","Slot inválido.");

      const { error } = await sb.from("working_hours")
        .update({ professional_id, weekday, start_time, end_time, slot_minutes })
        .eq("id", id)
        .eq("company_id", state.profile.company_id);

      if(error) return toastMsg("err","Erro ao salvar horário.");
      toastMsg("ok","Horário atualizado.");
      closeModal();
      await loadWorkingHours();
    };

    window.deleteWH = async (id)=>{
      if(!state.isAdmin) return toastMsg("err","Apenas ADMIN pode excluir.");
      if(!confirm("Excluir horário?")) return;
      const { error } = await sb.from("working_hours").delete().eq("id", id).eq("company_id", state.profile.company_id);
      if(error) return toastMsg("err","Erro ao excluir.");
      toastMsg("ok","Horário excluído.");
      await loadWorkingHours();
    };


    // ----- NOVO AGENDAMENTO (com horários disponíveis por profissional) -----
    function buildOptions(list, valueKey, labelKey, onlyActive=true){
      return (list||[])
        .filter(x => !onlyActive || x.active)
        .map(x => `<option value="${x[valueKey]}">${esc(x[labelKey])}</option>`)
        .join("");
    }

    // Extrai o campo de data/hora retornado pelo RPC (compatível com variações de nome)
    function pickSlotStart(row){
      if(!row) return null;
      return row.slot_start || row.starts_at || row.start || row.slot || row.datetime || row.time || null;
    }

    async function openNewAppointmentModal(){
      if(!state?.profile?.company_id) return toastMsg("err","Sessão inválida (sem company_id).");
      if(!(state.pros||[]).length || !(state.serv||[]).length){
        await loadMaps();
      }

      const defaultDate = agendaDate.value || todayISO();

      const body = `
        <div class="row2">
          <div>
            <label>Profissional</label>
            <select id="na_pro">
              <option value="">Selecione</option>
              ${buildOptions(state.pros, "id", "name", true)}
            </select>
          </div>
          <div>
            <label>Serviço</label>
            <select id="na_serv">
              <option value="">Selecione</option>
              ${buildOptions(state.serv, "id", "name", true)}
            </select>
          </div>
        </div>

        <div class="row2" style="margin-top:8px">
          <div>
            <label>Data</label>
            <input id="na_date" type="date" value="${defaultDate}" />
          </div>
          <div>
            <label>Telefone do cliente</label>
            <input id="na_phone" placeholder="DDD + número" />
          </div>
        </div>

        <div style="margin-top:8px">
          <label>Nome do cliente</label>
          <input id="na_name" placeholder="Nome completo" />
        </div>

        <div class="toolbar" style="margin-top:12px">
          <div class="left" style="gap:10px">
            <div style="font-weight:1000">Horários disponíveis</div>
            <span class="muted" style="font-size:13px">selecionar um horário cria o agendamento</span>
          </div>
          <div class="right">
            <button class="btn2" id="na_reload_slots">Carregar horários</button>
          </div>
        </div>

        <div id="na_slots" style="display:flex;flex-wrap:wrap;gap:10px;padding:10px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background: rgba(255,255,255,.03);min-height:64px"></div>
        <div id="na_msg" class="muted" style="margin-top:10px;font-size:13px"></div>
      `;

      const footer = `
        <button class="btn2" onclick="window.__closeModal()">Fechar</button>
      `;

      openModal("Novo Agendamento", body, footer);

      // Wire events after render
      const elPro = document.getElementById("na_pro");
      const elServ = document.getElementById("na_serv");
      const elDate = document.getElementById("na_date");
      const elName = document.getElementById("na_name");
      const elPhone = document.getElementById("na_phone");
      const elSlots = document.getElementById("na_slots");
      const elMsg = document.getElementById("na_msg");
      const elReload = document.getElementById("na_reload_slots");

      const setMsg = (t)=>{ if(elMsg) elMsg.textContent = t || ""; };

      async function loadSlots(){
        setMsg("");
        elSlots.innerHTML = "";

        const p_professional_id = elPro.value;
        const p_service_id = elServ.value;
        const p_date = elDate.value;

        if(!p_professional_id || !p_service_id || !p_date){
          setMsg("Selecione profissional, serviço e data para listar horários.");
          return;
        }

        // RPC: get_available_slots(p_professional_id, p_service_id, p_date)
        const { data, error } = await sb.rpc("get_available_slots", {
          p_professional_id,
          p_service_id,
          p_date
        });

        if(error){
          console.error(error);
          setMsg("Erro ao buscar horários disponíveis. Verifique se a RPC get_available_slots existe e está liberada no RLS.");
          return;
        }

        const slots = (data||[])
          .map(pickSlotStart)
          .filter(Boolean);

        if(!slots.length){
          setMsg("Nenhum horário disponível para este profissional nesta data.");
          return;
        }

        // Render buttons
        slots.forEach(iso=>{
          const hhmm = fmtTime(iso);
          const btn = document.createElement("button");
          btn.className = "btn2";
          btn.textContent = hhmm;
          btn.style.minWidth = "90px";
          btn.onclick = ()=> createAppointment(iso);
          elSlots.appendChild(btn);
        });

        setMsg(`Total de horários livres: ${slots.length}`);
      }

      async function createAppointment(p_starts_at){
        setMsg("");

        const p_professional_id = elPro.value;
        const p_service_id = elServ.value;
        const p_customer_name = (elName.value||"").trim();
        const p_customer_phone = (elPhone.value||"").trim();

        if(!p_professional_id || !p_service_id) return setMsg("Selecione profissional e serviço.");
        if(!p_customer_name || p_customer_name.length < 2) return setMsg("Informe o nome do cliente.");
        // telefone pode ser vazio, mas é recomendado
        // Desabilita botões para evitar clique duplo
        [...elSlots.querySelectorAll("button")].forEach(b=>b.disabled = true);

        const { data, error } = await sb.rpc("create_appointment", {
          p_professional_id,
          p_service_id,
          p_customer_name,
          p_customer_phone,
          p_starts_at
        });

        if(error){
          console.error(error);
          // Caso clássico: unique violation / slot ocupado no exato momento
          toastMsg("err","Não foi possível agendar: horário pode ter sido ocupado. Recarregue os horários.");
          [...elSlots.querySelectorAll("button")].forEach(b=>b.disabled = false);
          return;
        }

        toastMsg("ok","Agendamento criado com sucesso.");
        // Atualiza agenda e KPIs
        await loadAgenda();
        await loadDashboard();
        await loadDashboardOverview();
        await loadCounts();

        // Recarrega slots para "sumir" o horário recém-ocupado
        await loadSlots();
      }

      elReload?.addEventListener("click", loadSlots);
      elPro?.addEventListener("change", loadSlots);
      elServ?.addEventListener("change", loadSlots);
      elDate?.addEventListener("change", loadSlots);

      // Carrega automaticamente se já houver dados preenchidos
      await loadSlots();
    }
    window.__closeModal = closeModal;

    // Auto start
    (async ()=>{
      const { data: sess } = await sb.auth.getSession();
      if(sess?.session){
        await bootstrap();
      } else {
        resetState();
        showLogin();
      }
    })();
  </script>
</body>
</html>
