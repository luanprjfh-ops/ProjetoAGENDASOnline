<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LEP Sistemas • Agenda Online</title>
  <style>
    /* Mantém o estilo do seu arquivo (mesma identidade visual) */
    :root{
      --bg1:#110814;
      --bg2:#2a0f2a;
      --card:#1b1020cc;
      --stroke:#ffffff14;
      --text:#f7f3ff;
      --muted:#cdb9d7;
      --accent1:#ff3fb4;
      --accent2:#7f5cff;
      --danger:#ff5c5c;
      --ok:#4dff9f;
      --shadow: 0 20px 70px rgba(0,0,0,.45);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% 10%, #5a1a4a55, transparent 70%),
        radial-gradient(900px 500px at 80% 20%, #2d2d8855, transparent 70%),
        radial-gradient(900px 600px at 40% 90%, #ff3fb433, transparent 70%),
        linear-gradient(145deg, var(--bg1), var(--bg2));
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }
    .wrap{width:min(980px, 100%); display:grid; gap:18px;}
    .card{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .head{
      padding:22px 22px 16px;
      display:flex; align-items:flex-end; justify-content:space-between; gap:16px;
      border-bottom:1px solid var(--stroke);
      background: linear-gradient(90deg, #ff3fb422, #7f5cff22);
    }
    .brand h1{margin:0; font-size:38px; letter-spacing:.2px; color:var(--accent1);}
    .brand p{margin:6px 0 0; color:var(--muted)}
    .pill{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--stroke);
      color:var(--muted);
      font-size:13px;
      background:#00000020;
      white-space:nowrap;
    }
    .body{padding:18px 22px 22px;}
    .grid{
      display:grid;
      grid-template-columns: 1.2fr 1fr;
      gap:16px;
    }
    @media (max-width: 860px){
      .grid{grid-template-columns:1fr;}
    }
    label{display:block; font-size:13px; color:var(--muted); margin:0 0 6px;}
    select, input, textarea{
      width:100%;
      padding:13px 14px;
      border-radius:14px;
      background:#0d0a12cc;
      border:1px solid var(--stroke);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:88px; resize:vertical;}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:12px;}
    @media (max-width: 520px){
      .row{grid-template-columns:1fr;}
    }
    .actions{display:flex; gap:12px; flex-wrap:wrap; margin-top:12px;}
    button{
      padding:13px 16px;
      border-radius:14px;
      border:0;
      cursor:pointer;
      color:#fff;
      font-weight:600;
      letter-spacing:.2px;
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      box-shadow: 0 12px 30px rgba(255,63,180,.16);
    }
    button.secondary{
      background:#0000002f;
      border:1px solid var(--stroke);
      color:var(--text);
      box-shadow:none;
    }
    button:disabled{opacity:.55; cursor:not-allowed;}
    .msg{
      display:none;
      margin-top:12px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--stroke);
      font-size:14px;
    }
    .msg.ok{display:block; border-color:#4dff9f55; background:#0b1a1355; color:var(--ok);}
    .msg.err{display:block; border-color:#ff5c5c55; background:#1a0b0b55; color:var(--danger);}
    .slots{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 860px){
      .slots{grid-template-columns: repeat(3, minmax(0,1fr));}
    }
    @media (max-width: 520px){
      .slots{grid-template-columns: repeat(2, minmax(0,1fr));}
    }
    .slot{
      padding:12px 10px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:#00000026;
      text-align:center;
      user-select:none;
      cursor:pointer;
      transition: transform .06s ease, border-color .12s ease, background .12s ease;
      color:var(--text);
      font-weight:600;
    }
    .slot:hover{transform: translateY(-1px); border-color:#ffffff26;}
    .slot.active{
      background: linear-gradient(90deg, #ff3fb433, #7f5cff33);
      border-color:#ffffff35;
      outline: 2px solid #ff3fb444;
    }
    .foot{
      text-align:center;
      color:var(--muted);
      font-size:13px;
      padding:14px 10px 0;
      opacity:.9;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="head">
        <div class="brand">
          <h1>Agendar</h1>
          <p id="subtitle">Escolha serviço, profissional, data e horário.</p>
        </div>
        <div class="pill" id="companyPill">Carregando empresa...</div>
      </div>

      <div class="body">
        <div class="grid">
          <div>
            <div style="display:grid; gap:12px;">
              <div>
                <label>Serviço</label>
                <select id="service">
                  <option value="">Carregando...</option>
                </select>
              </div>

              <div>
                <label>Profissional</label>
                <select id="professional">
                  <option value="">Carregando...</option>
                </select>
              </div>

              <div class="row">
                <div>
                  <label>Data</label>
                  <select id="availableDate">
                    <option value="">Selecione</option>
                  </select>
                </div>
                <div>
                  <label>Ou escolha manual</label>
                  <input id="date" type="date" />
                </div>
              </div>

              <div class="actions">
                <button class="secondary" id="btnFindDates" type="button">Buscar datas</button>
              </div>

              <div>
                <label>Horários disponíveis</label>
                <div id="slots" class="slots"></div>
              </div>
            </div>
          </div>

          <div>
            <div style="display:grid; gap:12px;">
              <div>
                <label>Seu nome</label>
                <input id="customerName" placeholder="Ex.: Maria Silva" />
              </div>
              <div class="row">
                <div>
                  <label>Telefone</label>
                  <input id="customerPhone" placeholder="(00) 00000-0000" />
                </div>
                <div>
                  <label>E-mail (opcional)</label>
                  <input id="customerEmail" placeholder="email@exemplo.com" />
                </div>
              </div>
              <div>
                <label>Observações (opcional)</label>
                <textarea id="notes" placeholder="Se quiser, descreva algo importante..."></textarea>
              </div>

              <div class="actions">
                <button id="btnConfirm" type="button" disabled>Confirmar agendamento</button>
              </div>

              <div id="msgOk" class="msg ok"></div>
              <div id="msgErr" class="msg err"></div>
            </div>
          </div>
        </div>

        <div class="foot">LEP Sistemas • Agenda Online</div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
  // =========================
  // CONFIGURAÇÃO SUPABASE
  // =========================
  // Use o mesmo projeto do Painel (URL e ANON KEY)
  const SUPABASE_URL = "https://nsmvnfhdohpvmtoimsub.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_tn76OaKxjctgngA6jj9NSw_KXfWqt-f";

  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // =========================
  // HELPERS UI
  // =========================
  const serviceSel = document.getElementById("service");
  const profSel = document.getElementById("professional");
  const dateInput = document.getElementById("date");
  const availDateSel = document.getElementById("availableDate");
  const btnFindDates = document.getElementById("btnFindDates");
  const slotsDiv = document.getElementById("slots");
  const btnConfirm = document.getElementById("btnConfirm");
  const msgOk = document.getElementById("msgOk");
  const msgErr = document.getElementById("msgErr");
  const companyPill = document.getElementById("companyPill");
  const subtitle = document.getElementById("subtitle");

  function showOk(t){ msgOk.textContent=t; msgOk.className="msg ok"; msgOk.style.display="block"; msgErr.style.display="none"; }
  function showErr(t){ msgErr.textContent=t; msgErr.className="msg err"; msgErr.style.display="block"; msgOk.style.display="none"; }
  function clearMsgs(){ msgOk.style.display="none"; msgErr.style.display="none"; }

  function fmtTimeHM(d){
    return d.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});
  }
  function fmtDateLabel(iso){
    const [y,m,d] = iso.split("-").map(Number);
    const dt = new Date(Date.UTC(y, m-1, d));
    const week = ["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"][dt.getUTCDay()];
    return `${String(d).padStart(2,"0")}/${String(m).padStart(2,"0")} • ${week}`;
  }
  function parseCompanySlug(){
    const url = new URL(window.location.href);
    const s = (url.searchParams.get("empresa") || "").trim();
    if(!s){
      // Em produção, exigir o slug para evitar cair na empresa errada.
      throw new Error("Link inválido: falta ?empresa=SEU-SLUG. Ex.: ?empresa=clinica-x");
    }
    return s;
  }

  // =========================
  // ESTADO
  // =========================
  let COMPANY_ID = null;
  let COMPANY_NAME = null;
  let selectedSlot = null;

  // =========================
  // DATA ACCESS (PUBLICO)
  // =========================
  async function loadCompanyBySlug(slug){
    const { data, error } = await sb.rpc("get_company_public", { p_slug: slug });
    if(error) throw error;
    if(!data || !data.id) throw new Error("Empresa inválida.");
    COMPANY_ID = data.id;
    COMPANY_NAME = data.name;
    companyPill.textContent = data.name;
    subtitle.textContent = `Agende na empresa: ${data.name}`;
  }

  async function loadServices(){
    serviceSel.innerHTML = `<option value="">Selecione</option>`;
    const { data, error } = await sb
      .from("services")
      .select("id,name,duration_minutes,price_cents,active,company_id")
      .eq("company_id", COMPANY_ID)
      .eq("active", true)
      .order("name",{ascending:true});

    if(error) throw error;
    for(const s of (data||[])){
      const opt = document.createElement("option");
      opt.value = s.id;
      opt.textContent = `${s.name} • ${s.duration_minutes} min`;
      opt.dataset.duration = s.duration_minutes;
      serviceSel.appendChild(opt);
    }
  }

  async function loadProfessionals(){
    profSel.innerHTML = `<option value="">Selecione</option>`;
    const { data, error } = await sb
      .from("professionals")
      .select("id,name,active,company_id")
      .eq("company_id", COMPANY_ID)
      .eq("active", true)
      .order("name",{ascending:true});

    if(error) throw error;
    for(const p of (data||[])){
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = p.name;
      profSel.appendChild(opt);
    }
  }

  async function loadWorkingHours(profId){
    const { data, error } = await sb
      .from("working_hours")
      .select("weekday,start_time,end_time,slot_minutes,professional_id,company_id")
      .eq("company_id", COMPANY_ID)
      .eq("professional_id", profId);

    if(error) throw error;
    return data || [];
  }

  async function loadBusyForDay(profId, isoDate){
    // RPC retorna apenas intervalos (sem dados pessoais)
    const { data, error } = await sb.rpc("get_busy_slots", {
      p_company_id: COMPANY_ID,
      p_professional_id: profId,
      p_day: isoDate
    });
    if(error) throw error;
    return data || []; // [{starts_at, ends_at}]
  }

  // =========================
  // CALCULO DE SLOTS
  // =========================
  function overlaps(aStart, aEnd, bStart, bEnd){
    return aStart < bEnd && bStart < aEnd;
  }

  async function renderSlotsForDate(isoDate){
    clearMsgs();
    selectedSlot = null;
    btnConfirm.disabled = true;
    slotsDiv.innerHTML = "";

    const serviceId = serviceSel.value;
    const profId = profSel.value;

    if(!COMPANY_ID) { showErr("Empresa inválida."); return; }
    if(!serviceId || !profId) { showErr("Selecione um serviço e um profissional."); return; }
    if(!isoDate) { showErr("Selecione uma data."); return; }

    const durMin = Number(serviceSel.selectedOptions[0]?.dataset?.duration || 30);

    // working_hours
    const wh = await loadWorkingHours(profId);
    if(!wh.length){ showErr("Este profissional não possui horários cadastrados."); return; }

    // weekday 0..6 (Dom..Sáb)
    const [y,m,d] = isoDate.split("-").map(Number);
    const dtLocal = new Date(y, m-1, d);
    const weekday = dtLocal.getDay();

    const todays = wh.filter(x => x.weekday === weekday);
    if(!todays.length){ showErr("Sem expediente nesta data."); return; }

    const busy = await loadBusyForDay(profId, isoDate);

    // Gera slots
    const slots = [];
    for(const w of todays){
      const slotMin = w.slot_minutes || 30;
      // monta DateTime local
      const [sh, sm] = (w.start_time||"09:00:00").split(":").map(Number);
      const [eh, em] = (w.end_time||"18:00:00").split(":").map(Number);

      let cur = new Date(y, m-1, d, sh, sm, 0, 0);
      const end = new Date(y, m-1, d, eh, em, 0, 0);

      while(true){
        const slotStart = new Date(cur);
        const slotEnd = new Date(cur.getTime() + durMin*60000);
        if(slotEnd > end) break;

        // verifica colisão com busy (busy vem timestamptz; converte)
        const collides = (busy||[]).some(b=>{
          const bs = new Date(b.starts_at);
          const be = new Date(b.ends_at);
          return overlaps(slotStart, slotEnd, bs, be);
        });

        if(!collides){
          slots.push({ start: slotStart, end: slotEnd });
        }
        cur = new Date(cur.getTime() + slotMin*60000);
      }
    }

    if(!slots.length){ showErr("Sem horários disponíveis para esta data."); return; }

    // Render
    for(const s of slots){
      const div = document.createElement("div");
      div.className = "slot";
      div.textContent = fmtTimeHM(s.start);
      div.onclick = ()=>{
        document.querySelectorAll(".slot").forEach(el=>el.classList.remove("active"));
        div.classList.add("active");
        selectedSlot = s;
        btnConfirm.disabled = false;
      };
      slotsDiv.appendChild(div);
    }
  }

  async function scanAvailableDates({daysAhead=21, maxDates=14}={}){
    clearMsgs();
    selectedSlot = null;
    btnConfirm.disabled = true;
    slotsDiv.innerHTML = "";
    availDateSel.innerHTML = `<option value="">Selecione</option>`;

    const serviceId = serviceSel.value;
    const profId = profSel.value;
    if(!COMPANY_ID) { showErr("Empresa inválida."); return; }
    if(!serviceId || !profId) { showErr("Selecione um serviço e um profissional."); return; }

    const wh = await loadWorkingHours(profId);
    if(!wh.length){ showErr("Este profissional não possui horários cadastrados."); return; }

    const today = new Date();
    const dates = [];
    for(let i=0;i<daysAhead;i++){
      const d = new Date(today.getFullYear(), today.getMonth(), today.getDate()+i);
      const iso = d.toISOString().slice(0,10);
      const weekday = d.getDay();
      if(!wh.some(x=>x.weekday===weekday)) continue; // sem expediente
      dates.push(iso);
      if(dates.length>=maxDates) break;
    }

    for(const iso of dates){
      const opt = document.createElement("option");
      opt.value = iso;
      opt.textContent = fmtDateLabel(iso);
      availDateSel.appendChild(opt);
    }

    if(dates.length){
      // pré-carrega slots do primeiro dia
      availDateSel.value = dates[0];
      await renderSlotsForDate(dates[0]);
    }
  }

  // =========================
  // CONFIRMAR AGENDAMENTO (PUBLICO)
  // =========================
  async function confirmAppointment(){
    clearMsgs();

    const serviceId = serviceSel.value;
    const profId = profSel.value;
    const isoDate = (availDateSel.value || dateInput.value || "").trim();

    const name = document.getElementById("customerName").value.trim();
    const phone = document.getElementById("customerPhone").value.trim();
    const email = document.getElementById("customerEmail").value.trim();
    const notes = document.getElementById("notes").value.trim();

    if(!COMPANY_ID){ showErr("Empresa inválida."); return; }
    if(!serviceId || !profId){ showErr("Selecione serviço e profissional."); return; }
    if(!isoDate){ showErr("Selecione uma data."); return; }
    if(!selectedSlot){ showErr("Selecione um horário."); return; }
    if(!name || name.length < 3){ showErr("Informe seu nome."); return; }

    btnConfirm.disabled = true;
    btnConfirm.textContent = "Confirmando...";

    try{
      const { data, error } = await sb.rpc("create_public_appointment", {
        p_company_id: COMPANY_ID,
        p_professional_id: profId,
        p_service_id: serviceId,
        p_starts_at: selectedSlot.start.toISOString(),
        p_customer_name: name,
        p_customer_phone: phone || null,
        p_customer_email: email || null,
        p_notes: notes || null
      });
      if(error) throw error;

      showOk("Agendamento confirmado com sucesso.");
      // limpa seleção e recarrega slots (pra não permitir duplicidade)
      await renderSlotsForDate(isoDate);

      document.getElementById("customerName").value="";
      document.getElementById("customerPhone").value="";
      document.getElementById("customerEmail").value="";
      document.getElementById("notes").value="";
      btnConfirm.textContent = "Confirmar agendamento";
      btnConfirm.disabled = true;

    }catch(e){
      showErr(e?.message || "Falha ao confirmar agendamento.");
      btnConfirm.textContent = "Confirmar agendamento";
      btnConfirm.disabled = false;
    }
  }

  // =========================
  // EVENTOS
  // =========================
  btnFindDates.onclick = ()=> scanAvailableDates({daysAhead:21, maxDates:14});

  availDateSel.onchange = async ()=>{
    if(availDateSel.value){
      dateInput.value = "";
      await renderSlotsForDate(availDateSel.value);
    }
  };

  dateInput.onchange = async ()=>{
    if(dateInput.value){
      availDateSel.value = "";
      await renderSlotsForDate(dateInput.value);
    }
  };

  serviceSel.onchange = ()=> scanAvailableDates({daysAhead:21, maxDates:14});
  profSel.onchange = ()=> scanAvailableDates({daysAhead:21, maxDates:14});

  btnConfirm.onclick = confirmAppointment;

  // =========================
  // INIT
  // =========================
  (async ()=>{
    try{
      const slug = parseCompanySlug();
      await loadCompanyBySlug(slug);
      await loadServices();
      await loadProfessionals();
      // não inicia slots até selecionar
      serviceSel.innerHTML = serviceSel.innerHTML.includes("Selecione") ? serviceSel.innerHTML : `<option value="">Selecione</option>` + serviceSel.innerHTML;
      profSel.innerHTML = profSel.innerHTML.includes("Selecione") ? profSel.innerHTML : `<option value="">Selecione</option>` + profSel.innerHTML;
      clearMsgs();
    }catch(e){
      showErr(e?.message || "Falha ao carregar agenda.");
      companyPill.textContent = "Erro";
    }
  })();
  </script>
</body>
</html>
